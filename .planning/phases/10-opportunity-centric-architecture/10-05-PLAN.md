---
phase: 10-opportunity-centric-architecture
plan: 05
type: execute
wave: 3
depends_on: ["10-03", "10-04"]
files_modified:
  - src/webhook/worker.ts
  - src/classification/classification-worker.ts
  - src/crm/index.ts
  - src/crm/contacts.ts
autonomous: true
requirements: [OPP-01, OPP-03, OPP-04, OPP-05, OPP-07, OPP-08]

must_haves:
  truths:
    - "Webhook worker passes finmoApplicationId to syncChecklistToCrm"
    - "Classification worker resolves opportunity ID before tracking update"
    - "Barrel export includes new opportunity functions and types"
    - "Deprecated upsert/move functions removed from barrel export"
    - "Contact upsert no longer includes doc tracking fields by default"
  artifacts:
    - path: "src/webhook/worker.ts"
      provides: "Webhook worker passing Finmo application UUID to CRM sync"
      contains: "finmoApplicationId"
    - path: "src/classification/classification-worker.ts"
      provides: "Classification worker resolving opportunity for tracking"
      contains: "finmoApplicationId"
    - path: "src/crm/index.ts"
      provides: "Updated barrel export with opportunity functions"
      exports: ["searchOpportunities", "getOpportunity", "updateOpportunityFields", "updateOpportunityStage", "findOpportunityByFinmoId"]
  key_links:
    - from: "src/webhook/worker.ts"
      to: "src/crm/checklist-sync.ts"
      via: "finmoApplicationId in SyncChecklistInput"
      pattern: "finmoApplicationId"
    - from: "src/classification/classification-worker.ts"
      to: "src/crm/tracking-sync.ts"
      via: "finmoApplicationId in TrackingUpdateInput"
      pattern: "finmoApplicationId"
---

<objective>
Wire the opportunity-centric changes into the webhook worker and classification worker, update the barrel export, and clean up deprecated code.

Purpose: Plans 03-04 created the refactored modules. This plan connects them to the actual pipeline and cleans up the public API.

Output: End-to-end pipeline uses opportunity-level tracking. Barrel export reflects the new architecture.
</objective>

<execution_context>
@C:/Users/lucac/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/lucac/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-opportunity-centric-architecture/10-RESEARCH.md
@.planning/phases/10-opportunity-centric-architecture/10-03-SUMMARY.md
@.planning/phases/10-opportunity-centric-architecture/10-04-SUMMARY.md

@src/webhook/worker.ts
@src/classification/classification-worker.ts
@src/crm/index.ts
@src/crm/contacts.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update webhook worker and classification worker</name>
  <files>src/webhook/worker.ts, src/classification/classification-worker.ts</files>
  <action>
**In `src/webhook/worker.ts` (processJob):**

1. Pass `finmoApplicationId` to `syncChecklistToCrm`. The Finmo application UUID is at `finmoApp.application.id` (this is the UUID like `98f332e4-...` that Finmo stores in the opportunity's custom field `ezhN6WKQLzY7MvqIKSY9`).

   Current call (step 8):
   ```typescript
   const crmResult = await syncChecklistToCrm({
     ...
     finmoDealId: applicationId,
     ...
   });
   ```

   Update to also include:
   ```typescript
   finmoApplicationId: finmoApp.application.id,
   ```

   Note: `applicationId` from the job data is the same as `finmoApp.application.id` — it's the UUID used to fetch the application. So `finmoApplicationId: applicationId` should also work. But use `finmoApp.application.id` for clarity (it's the canonical source).

2. Log `trackingTarget` from the CRM result:
   ```typescript
   console.log('[worker] CRM synced', {
     applicationId,
     contactId: crmResult.contactId,
     trackingTarget: crmResult.trackingTarget,
     fieldsUpdated: crmResult.fieldsUpdated,
     errors: crmResult.errors.length,
   });
   ```

**In `src/classification/classification-worker.ts` (processClassificationJob):**

1. The `ClassificationJobData` interface (in `src/classification/types.ts`) already has `applicationId?: string`. This is the Finmo application UUID. Pass it to `updateDocTracking`:

   Current call (step j):
   ```typescript
   const trackingResult = await updateDocTracking({
     senderEmail: senderEmail ?? '',
     documentType: classification.documentType,
     driveFileId,
     source,
     receivedAt: job.data.receivedAt,
     ...(contactId ? { contactId } : {}),
   });
   ```

   Update to also include:
   ```typescript
   finmoApplicationId: applicationId ?? undefined,
   ```

   This allows the tracking sync to find the right opportunity when a document arrives for a client with multiple deals.

2. Log the tracking target:
   ```typescript
   if (trackingResult.updated) {
     console.log('[classification] CRM tracking updated:', {
       contactId: trackingResult.contactId,
       opportunityId: trackingResult.opportunityId,
       trackingTarget: trackingResult.trackingTarget,
       newStatus: trackingResult.newStatus,
       crossDealUpdates: trackingResult.crossDealUpdates,
     });
   }
   ```
  </action>
  <verify>Run `npx tsc --noEmit` — no TypeScript errors. Run `npx vitest run --reporter=verbose 2>&1 | tail -10` — all tests pass.</verify>
  <done>Webhook worker passes finmoApplicationId to checklist sync. Classification worker passes finmoApplicationId to tracking sync. Both log the tracking target.</done>
</task>

<task type="auto">
  <name>Task 2: Update barrel export and clean up deprecated exports</name>
  <files>src/crm/index.ts, src/crm/contacts.ts</files>
  <action>
**In `src/crm/index.ts`:**

1. Add new exports from opportunities.ts:
   ```typescript
   export {
     searchOpportunities,
     getOpportunity,
     updateOpportunityFields,
     updateOpportunityStage,
     findOpportunityByFinmoId,
     getOpportunityFieldValue,
   } from './opportunities.js';
   ```

2. Remove deprecated exports:
   - Remove `upsertOpportunity` from export (keep function in opportunities.ts but don't export from barrel)
   - Remove `moveToCollectingDocs` from export
   - Remove `moveToAllDocsReceived` from export

3. Add new type exports:
   ```typescript
   export type { CrmOpportunity, CrmOpportunityCustomField } from './types/index.js';
   export { EXISTING_OPP_FIELDS, OPP_DOC_TRACKING_FIELD_DEFS } from './types/index.js';
   ```

4. Update tracking-sync exports to include new function:
   ```typescript
   export { updateDocTracking, parseContactTrackingFields, parseOpportunityTrackingFields } from './tracking-sync.js';
   ```

5. Verify no remaining imports of deprecated functions across the codebase (use grep). If any module still imports `moveToCollectingDocs` or `moveToAllDocsReceived` from the barrel, update those imports.

**In `src/crm/contacts.ts`:**

No functional changes needed. The contact upsert function remains unchanged — it accepts customFields and writes them. The change is at the caller level (checklist-sync no longer passes doc tracking fields to contacts when an opportunity is available).

However, add a JSDoc comment to `upsertContact` noting:
```typescript
/**
 * ...existing docs...
 *
 * NOTE (Phase 10): Doc tracking fields are now stored on opportunities,
 * not contacts. Contact upsert should only receive borrower details
 * (name, email, phone) and non-doc-tracking custom fields.
 */
```
  </action>
  <verify>Run `npx vitest run --reporter=verbose 2>&1 | tail -10` — all tests pass. Run `npx tsc --noEmit` — no TypeScript errors. Run grep for any remaining references to deprecated functions outside opportunities.ts: `grep -rn "moveToCollectingDocs\|moveToAllDocsReceived\|upsertOpportunity" src/ --include="*.ts" | grep -v opportunities.ts | grep -v __tests__ | grep -v PLAN` — should show zero results (or only in test mocks that need updating).</verify>
  <done>Barrel export includes new opportunity functions. Deprecated functions removed from public API. No remaining usages of deprecated functions in production code. All tests pass.</done>
</task>

</tasks>

<verification>
1. `npx vitest run --reporter=verbose` — full test suite passes
2. `npx tsc --noEmit` — no TypeScript errors
3. No production code imports deprecated functions (upsertOpportunity, moveToCollectingDocs, moveToAllDocsReceived)
4. Webhook worker passes finmoApplicationId to CRM sync
5. Classification worker passes finmoApplicationId to tracking sync
6. Barrel export includes all new opportunity functions
</verification>

<success_criteria>
- End-to-end pipeline wired: webhook -> checklist sync -> opportunity, classification -> tracking sync -> opportunity
- finmoApplicationId flows from Finmo API through to opportunity resolution
- Deprecated functions removed from barrel export
- All tests pass
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/10-opportunity-centric-architecture/10-05-SUMMARY.md`
</output>
