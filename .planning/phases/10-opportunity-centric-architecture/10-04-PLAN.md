---
phase: 10-opportunity-centric-architecture
plan: 04
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - src/crm/tracking-sync.ts
  - src/crm/__tests__/tracking-sync.test.ts
autonomous: true
requirements: [OPP-02, OPP-03, OPP-04, OPP-05, OPP-06]

must_haves:
  truths:
    - "updateDocTracking reads doc tracking fields from the opportunity, not the contact"
    - "updateDocTracking writes updated fields to the opportunity, not the contact"
    - "Reusable documents (IDs, T4s, bank statements) update ALL active opportunities for the contact"
    - "Property-specific documents (purchase agreement, MLS) update only the matched opportunity"
    - "Pipeline stage advances per-opportunity when all docs received"
    - "Two simultaneous deals have independent checklists that don't overwrite each other"
  artifacts:
    - path: "src/crm/tracking-sync.ts"
      provides: "Opportunity-level tracking sync orchestrator"
      exports: ["updateDocTracking", "parseOpportunityTrackingFields"]
    - path: "src/crm/__tests__/tracking-sync.test.ts"
      provides: "Tests for opportunity-level tracking including reuse logic"
  key_links:
    - from: "src/crm/tracking-sync.ts"
      to: "src/crm/opportunities.ts"
      via: "searchOpportunities, getOpportunity, updateOpportunityFields, updateOpportunityStage, getOpportunityFieldValue"
      pattern: "searchOpportunities|getOpportunity|updateOpportunityFields|getOpportunityFieldValue"
    - from: "src/crm/tracking-sync.ts"
      to: "src/drive/doc-expiry.ts"
      via: "PROPERTY_SPECIFIC_TYPES import"
      pattern: "PROPERTY_SPECIFIC_TYPES"
---

<objective>
Refactor tracking-sync.ts to read/write doc tracking fields on opportunities instead of contacts, and implement document reuse logic across deals.

Purpose: When a document is received, the tracking sync must update the correct opportunity (or all opportunities for reusable docs). This plan implements the multi-deal support that is the key value of Phase 10.

Output: Updated updateDocTracking that targets opportunities, with PROPERTY_SPECIFIC_TYPES governing single-deal vs cross-deal tracking.
</objective>

<execution_context>
@C:/Users/lucac/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/lucac/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-opportunity-centric-architecture/10-RESEARCH.md
@.planning/phases/10-opportunity-centric-architecture/10-01-SUMMARY.md

@src/crm/tracking-sync.ts
@src/crm/__tests__/tracking-sync.test.ts
@src/crm/checklist-mapper.ts
@src/drive/doc-expiry.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor tracking-sync.ts for opportunity-level tracking</name>
  <files>src/crm/tracking-sync.ts</files>
  <action>
Major refactor of `updateDocTracking` to work at the opportunity level.

**New imports:**
- `searchOpportunities`, `getOpportunity`, `updateOpportunityFields`, `updateOpportunityStage`, `getOpportunityFieldValue` from `./opportunities.js`
- `PROPERTY_SPECIFIC_TYPES` from `../drive/doc-expiry.js`
- Keep: `findContactByEmail`, `getContact` from `./contacts.js` (for contact resolution, NOT for doc tracking)
- Keep: `createAuditNote` from `./notes.js` (audit notes still go on contacts)
- Keep: `findMatchingChecklistDoc` from `./doc-type-matcher.js`
- Keep: `computeDocStatus`, `formatMissingDocsForCrm`, `formatReceivedDocsForCrm`, `parseMissingDocsText`, `parseReceivedDocsText` from `./checklist-mapper.js`
- Remove: `upsertContact` import (no longer writing doc tracking to contacts)
- Remove: `moveToAllDocsReceived` import (replaced by updateOpportunityStage)

**Update `TrackingUpdateInput`:**
- Add `finmoApplicationId?: string` — for finding the right opportunity
- Keep existing fields (senderEmail, documentType, driveFileId, source, receivedAt, contactId)

**Update `TrackingUpdateResult`:**
- Add `opportunityId?: string`
- Add `trackingTarget?: 'opportunity' | 'contact'`
- Add `crossDealUpdates?: number` — count of opportunities updated (for reusable docs)

**New function: `parseOpportunityTrackingFields(opp, fieldIds)`**
Similar to `parseContactTrackingFields` but handles the opportunity custom field format. Uses `getOpportunityFieldValue(opp, fieldId)` to extract values from the opportunity's `fieldValueString`/`fieldValueNumber`/`fieldValueDate` format.

Return type is the same `ParsedTrackingFields` interface.

**Refactored `updateDocTracking` flow:**

1. **Resolve contact** — same as before (email or pre-resolved contactId)

2. **Find opportunities** — `searchOpportunities(contactId, PIPELINE_IDS.LIVE_DEALS)`. Filter to `status === 'open'`.

3. **If no opportunities found:** Fall back to contact-level tracking (old behavior). Log warning. Return `trackingTarget: 'contact'`.

4. **Determine tracking strategy based on document type:**
   - If `PROPERTY_SPECIFIC_TYPES.has(input.documentType)`:
     - **Single-deal mode:** Find the specific opportunity (by finmoApplicationId if provided, else most recent). Only update that one.
     - If can't determine which opportunity: return `{ updated: false, reason: 'ambiguous-deal' }` (new reason).
   - Else (reusable doc like T4, pay stub, bank statement, ID):
     - **Cross-deal mode:** Update ALL open opportunities for this contact.
     - Track count of updates in `crossDealUpdates`.

5. **For each target opportunity:**
   - Read current tracking fields via `parseOpportunityTrackingFields(opp, crmConfig.opportunityFieldIds)`
   - Find matching checklist doc
   - If matched and not already received: compute new values, write via `updateOpportunityFields`
   - If status becomes "All Complete": call `updateOpportunityStage(oppId, crmConfig.stageIds.allDocsReceived)` (non-fatal)
   - If status becomes "PRE Complete": call `createPreReadinessTask(contactId, borrowerName)` — only ONCE even for cross-deal updates

6. **Audit note** — create once on the contact (not per-opportunity)

7. **Return result** — with opportunityId (first updated), crossDealUpdates count, trackingTarget

**Contact-level fallback (when no opportunities):**
Keep the old `parseContactTrackingFields` + `upsertContact` path as fallback. Import `upsertContact` back but only use it in the fallback path. This ensures existing single-deal clients without opportunities still work.

Actually, re-import `upsertContact` for the fallback path. The contact fallback should work exactly as the old code did.

**Keep `parseContactTrackingFields` exported** — it's still needed for the fallback path and existing callers.
  </action>
  <verify>Run `npx tsc --noEmit` — no TypeScript errors.</verify>
  <done>updateDocTracking reads/writes opportunity fields, handles cross-deal reuse for non-property-specific docs, falls back to contact when no opportunities exist.</done>
</task>

<task type="auto">
  <name>Task 2: Rewrite tracking-sync tests for opportunity-level tracking</name>
  <files>src/crm/__tests__/tracking-sync.test.ts</files>
  <action>
Major rewrite of the test file to cover opportunity-level tracking.

**New mocks:**
- Add mocks for opportunity functions: `searchOpportunities`, `getOpportunity`, `updateOpportunityFields`, `updateOpportunityStage`, `getOpportunityFieldValue`
- Keep existing mocks for contacts, notes, doc-type-matcher, checklist-mapper, tasks
- Remove `moveToAllDocsReceived` mock (replaced by updateOpportunityStage)
- Add mock for config with `opportunityFieldIds`

**Helper functions:**
- `makeOpportunity(customFields)` — creates a CrmOpportunity with opportunity-format custom fields (fieldValueString/fieldValueNumber)
- Update `setupHappyPath` to configure opportunity search results instead of contact custom fields

**Test cases to ADD:**

1. **Happy path: PRE doc received on opportunity**
   - searchOpportunities returns 1 open opportunity
   - getOpportunity returns it with tracking fields
   - updateOpportunityFields called with updated missing/received/counters
   - Result has `trackingTarget: 'opportunity'` and `opportunityId`

2. **Reusable doc updates ALL open opportunities**
   - searchOpportunities returns 2 open opportunities
   - documentType is 't4' (not property-specific)
   - updateOpportunityFields called TWICE (once per opportunity)
   - Result has `crossDealUpdates: 2`

3. **Property-specific doc updates only matched opportunity**
   - searchOpportunities returns 2 open opportunities
   - documentType is 'purchase_agreement' (property-specific)
   - finmoApplicationId matches one opportunity's Finmo Application ID field
   - updateOpportunityFields called ONCE
   - Result has `crossDealUpdates: 1` (or undefined)

4. **Property-specific doc with ambiguous deal returns error**
   - searchOpportunities returns 2 opportunities, no finmoApplicationId provided
   - documentType is 'mls_listing'
   - Returns `{ updated: false, reason: 'ambiguous-deal' }`

5. **Fallback to contact when no opportunities**
   - searchOpportunities returns []
   - Old contact-level tracking path executes
   - upsertContact called with doc tracking fields
   - Result has `trackingTarget: 'contact'`

6. **Pipeline stage advances per-opportunity**
   - When status becomes 'All Complete', updateOpportunityStage called with the specific opportunity ID

7. **PRE readiness task created only once even for cross-deal**
   - 3 opportunities all reach PRE Complete
   - createPreReadinessTask called exactly once

8. **Audit note created on contact, not opportunity**
   - createAuditNote called with contactId (not opportunityId)

**Keep existing test cases** (adapted for opportunity context):
- no-contact, no-match-in-checklist, already-received
- LATER/CONDITIONAL stage docs don't increment counters
- Non-fatal error handling (notes, tasks, pipeline)

**Keep parseContactTrackingFields tests** (used by fallback path)

**Add parseOpportunityTrackingFields tests:**
- Parses fieldValueString, fieldValueNumber correctly
- Handles missing fields with safe defaults
  </action>
  <verify>Run `npx vitest run src/crm/__tests__/tracking-sync.test.ts --reporter=verbose` — all tests pass. Then `npx vitest run --reporter=verbose 2>&1 | tail -5` — full suite passes.</verify>
  <done>Tracking sync tests cover: opportunity-level read/write, cross-deal reuse for reusable docs, single-deal for property-specific docs, contact fallback, pipeline advance per-opportunity, PRE task once. All tests pass.</done>
</task>

</tasks>

<verification>
1. `npx vitest run --reporter=verbose` — all tests pass
2. `npx tsc --noEmit` — no TypeScript errors
3. PROPERTY_SPECIFIC_TYPES imported from drive/doc-expiry.ts (not redefined)
4. Reusable docs update all open opportunities; property-specific docs update one
5. Contact-level fallback still functional
</verification>

<success_criteria>
- Tracking sync reads/writes opportunity fields (not contact fields)
- Reusable docs fan out to all active opportunities
- Property-specific docs target single opportunity (by Finmo App ID)
- Ambiguous property-specific docs return error (not silent failure)
- Contact fallback works when no opportunities exist
- All tests pass including cross-deal reuse scenarios
</success_criteria>

<output>
After completion, create `.planning/phases/10-opportunity-centric-architecture/10-04-SUMMARY.md`
</output>
