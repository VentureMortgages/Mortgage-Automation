---
phase: 10-opportunity-centric-architecture
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/crm/setup/create-custom-fields.ts
  - src/crm/setup/fetch-ids.ts
autonomous: false
requirements: [OPP-02, OPP-07]

must_haves:
  truths:
    - "Setup script creates doc tracking fields scoped to opportunity model"
    - "Fetch-ids script lists opportunity-scoped custom field IDs"
    - "Created field IDs are output in GHL_OPP_FIELD_* env var format"
  artifacts:
    - path: "src/crm/setup/create-custom-fields.ts"
      provides: "Opportunity-scoped custom field creation"
      contains: "model: 'opportunity'"
    - path: "src/crm/setup/fetch-ids.ts"
      provides: "Lists opportunity custom fields"
      contains: "model=opportunity"
  key_links:
    - from: "src/crm/setup/create-custom-fields.ts"
      to: "src/crm/types/index.ts"
      via: "OPP_DOC_TRACKING_FIELD_DEFS import"
      pattern: "OPP_DOC_TRACKING_FIELD_DEFS"
---

<objective>
Update setup scripts to create doc tracking custom fields on opportunities (not contacts) and fetch their IDs.

Purpose: The CRM needs opportunity-scoped fields before any runtime code can write to them. This plan modifies the one-time setup scripts.

Output: Updated create-custom-fields.ts that creates fields with `model: 'opportunity'`, and updated fetch-ids.ts that lists opportunity fields.
</objective>

<execution_context>
@C:/Users/lucac/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/lucac/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-opportunity-centric-architecture/10-RESEARCH.md

@src/crm/setup/create-custom-fields.ts
@src/crm/types/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update setup scripts for opportunity-scoped fields</name>
  <files>src/crm/setup/create-custom-fields.ts, src/crm/setup/fetch-ids.ts</files>
  <action>
**In `src/crm/setup/create-custom-fields.ts`:**

1. Import `OPP_DOC_TRACKING_FIELD_DEFS` from `../types/index.js` alongside existing `DOC_TRACKING_FIELD_DEFS`.

2. Add a `--model` CLI argument parser at the top of `main()`:
   ```typescript
   const modelArg = process.argv.find(a => a.startsWith('--model='));
   const model = modelArg ? modelArg.split('=')[1] : 'contact';
   const fieldDefs = model === 'opportunity' ? OPP_DOC_TRACKING_FIELD_DEFS : DOC_TRACKING_FIELD_DEFS;
   ```

3. When `model === 'opportunity'`:
   - Use a different field group. First, check if a group named "Doc Tracking" already exists on opportunities by doing `GET /locations/:locationId/customFields?model=opportunity` and looking through the response for a group. If not found, create a new group by making a `POST /locations/:locationId/customFields` call with `{ name: "Doc Tracking", dataType: "GROUP", model: "opportunity" }` to create the group, then use its returned ID as `parentId`.
   - Pass `model: 'opportunity'` in the payload instead of `model: 'contact'`.

4. Log which model is being used at the top.

5. Usage instructions in comments:
   ```
   // Create contact fields (existing behavior):
   //   npx tsx src/crm/setup/create-custom-fields.ts
   // Create opportunity fields (Phase 10):
   //   npx tsx src/crm/setup/create-custom-fields.ts --model=opportunity
   ```

**In `src/crm/setup/fetch-ids.ts`:**

Read the current file first. Add a section that lists opportunity custom fields:
1. After listing contact fields, add: `GET /locations/:locationId/customFields?model=opportunity`
2. Filter to show only doc tracking fields (match by name against OPP_DOC_TRACKING_FIELD_DEFS names)
3. Print in the same env var format: `GHL_OPP_FIELD_DOC_STATUS_ID=<id>`, etc.

If the file doesn't exist yet, create it with similar structure to create-custom-fields.ts.
  </action>
  <verify>Run `npx tsc --noEmit` to verify TypeScript compilation. Do NOT run the setup scripts (they hit live API).</verify>
  <done>create-custom-fields.ts supports --model=opportunity flag, creates fields with model:'opportunity', creates group if needed. fetch-ids.ts lists opportunity field IDs in GHL_OPP_FIELD_* format.</done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 2: Run setup script to create opportunity fields in live CRM</name>
  <action>
Run the setup script against the live CRM to create the 9 doc tracking custom fields on opportunities:

```bash
npx tsx src/crm/setup/create-custom-fields.ts --model=opportunity
```

Then run fetch-ids to get the field IDs:

```bash
npx tsx src/crm/setup/fetch-ids.ts
```

Copy the output `GHL_OPP_FIELD_*` values into `.env`.

If any fields fail to create (e.g., the legacy API doesn't support `model: 'opportunity'`), create them manually in the GHL UI under a "Doc Tracking" field group on opportunities, then use fetch-ids to get their IDs.
  </action>
  <resume-signal>Paste the GHL_OPP_FIELD_* env var values (or confirm they're in .env), or describe any errors encountered.</resume-signal>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` â€” no TypeScript errors
2. Script accepts --model=opportunity flag
3. Script creates/finds a field group before creating fields
4. Field IDs available in .env after running
</verification>

<success_criteria>
- Setup script creates 9 doc tracking fields with model='opportunity'
- Field IDs are captured in GHL_OPP_FIELD_* env vars
- Existing contact field creation still works (backward compat)
</success_criteria>

<output>
After completion, create `.planning/phases/10-opportunity-centric-architecture/10-02-SUMMARY.md`
</output>
