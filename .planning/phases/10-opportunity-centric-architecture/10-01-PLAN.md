---
phase: 10-opportunity-centric-architecture
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/crm/types/index.ts
  - src/crm/config.ts
  - src/crm/opportunities.ts
  - src/crm/__tests__/opportunities.test.ts
autonomous: true
requirements: [OPP-01, OPP-06, OPP-08]

must_haves:
  truths:
    - "searchOpportunities returns Finmo-created opportunities by contactId + pipelineId"
    - "getOpportunity reads custom fields from a single opportunity"
    - "updateOpportunityFields writes custom fields to an opportunity"
    - "updateOpportunityStage changes pipeline stage on an opportunity"
    - "Opportunity custom field response format (fieldValueString/fieldValueNumber) is handled correctly"
  artifacts:
    - path: "src/crm/opportunities.ts"
      provides: "Opportunity search, get, update, stage management"
      exports: ["searchOpportunities", "getOpportunity", "updateOpportunityFields", "updateOpportunityStage", "findOpportunityByFinmoId"]
    - path: "src/crm/types/index.ts"
      provides: "CrmOpportunity type, opportunity field IDs, opportunity field group constant"
      contains: "CrmOpportunity"
    - path: "src/crm/config.ts"
      provides: "opportunityFieldIds config section"
      contains: "opportunityFieldIds"
    - path: "src/crm/__tests__/opportunities.test.ts"
      provides: "Unit tests for opportunity API functions"
  key_links:
    - from: "src/crm/opportunities.ts"
      to: "src/crm/config.ts"
      via: "crmConfig.opportunityFieldIds"
      pattern: "crmConfig\\.opportunityFieldIds"
    - from: "src/crm/opportunities.ts"
      to: "src/crm/types/index.ts"
      via: "CrmOpportunity type import"
      pattern: "import.*CrmOpportunity"
---

<objective>
Create the opportunity API foundation: types, config, and service functions for searching, reading, and writing opportunities with custom fields.

Purpose: Phase 10 replaces contact-level doc tracking with opportunity-level tracking. This plan builds the low-level API functions that Plans 03-05 consume.

Output: New opportunity service functions, CrmOpportunity type, opportunity field IDs in config, and comprehensive tests.
</objective>

<execution_context>
@C:/Users/lucac/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/lucac/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-opportunity-centric-architecture/10-RESEARCH.md

@src/crm/types/index.ts
@src/crm/config.ts
@src/crm/opportunities.ts
@src/crm/errors.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add opportunity types, field IDs, and config</name>
  <files>src/crm/types/index.ts, src/crm/config.ts</files>
  <action>
**In `src/crm/types/index.ts`:**

1. Add `CrmOpportunity` interface matching GHL response format. CRITICAL: opportunity customFields use a DIFFERENT format than contacts:
   ```typescript
   export interface CrmOpportunityCustomField {
     id: string;
     fieldValueString?: string;
     fieldValueNumber?: number;
     fieldValueDate?: number;
     type?: string;
   }

   export interface CrmOpportunity {
     id: string;
     name?: string;
     contactId?: string;
     pipelineId?: string;
     pipelineStageId?: string;
     status?: string;
     customFields?: CrmOpportunityCustomField[];
     createdAt?: string;
     updatedAt?: string;
   }
   ```

2. Add `EXISTING_OPP_FIELDS` constant for Finmo-created opportunity fields (different IDs than contact-level):
   ```typescript
   export const EXISTING_OPP_FIELDS = {
     FINMO_APPLICATION_ID: 'ezhN6WKQLzY7MvqIKSY9',
     FINMO_DEAL_ID: 'oQacgWtfN4YntLChYcvn',
     FINMO_DEAL_LINK: 'lp7dunT6sJY0ZmXAIasi',
     TRANSACTION_TYPE: 'tuUFgUp9pAPeOoorOrrn',
   } as const;
   ```

3. Add `OPP_FIELD_GROUP_ID` for the new field group we'll create for doc tracking on opportunities. Use empty string placeholder (setup script populates it):
   ```typescript
   export const OPP_FIELD_GROUP_ID = '';  // Populated after running setup script
   ```

4. Add `OPP_DOC_TRACKING_FIELD_DEFS` — same definitions as `DOC_TRACKING_FIELD_DEFS` but with `OPP_` prefixed envKey names:
   ```typescript
   export const OPP_DOC_TRACKING_FIELD_DEFS = [
     { envKey: 'GHL_OPP_FIELD_DOC_STATUS_ID', name: 'Doc Collection Status', dataType: 'SINGLE_OPTIONS' as const, options: ['Not Started', 'In Progress', 'PRE Complete', 'All Complete'] },
     { envKey: 'GHL_OPP_FIELD_DOC_REQUEST_SENT_ID', name: 'Doc Request Sent Date', dataType: 'DATE' as const },
     { envKey: 'GHL_OPP_FIELD_MISSING_DOCS_ID', name: 'Missing Docs', dataType: 'LARGE_TEXT' as const },
     { envKey: 'GHL_OPP_FIELD_RECEIVED_DOCS_ID', name: 'Received Docs', dataType: 'LARGE_TEXT' as const },
     { envKey: 'GHL_OPP_FIELD_PRE_TOTAL_ID', name: 'PRE Docs Total', dataType: 'NUMERICAL' as const },
     { envKey: 'GHL_OPP_FIELD_PRE_RECEIVED_ID', name: 'PRE Docs Received', dataType: 'NUMERICAL' as const },
     { envKey: 'GHL_OPP_FIELD_FULL_TOTAL_ID', name: 'FULL Docs Total', dataType: 'NUMERICAL' as const },
     { envKey: 'GHL_OPP_FIELD_FULL_RECEIVED_ID', name: 'FULL Docs Received', dataType: 'NUMERICAL' as const },
     { envKey: 'GHL_OPP_FIELD_LAST_DOC_RECEIVED_ID', name: 'Last Doc Received Date', dataType: 'DATE' as const },
   ] as const;
   ```

**In `src/crm/config.ts`:**

1. Add `opportunityFieldIds` to `CrmConfig` interface — same shape as `fieldIds` (both have docStatus, missingDocs, receivedDocs, etc.) but loaded from `GHL_OPP_FIELD_*` env vars:
   ```typescript
   opportunityFieldIds: {
     docStatus: string;
     docRequestSent: string;
     missingDocs: string;
     receivedDocs: string;
     preDocsTotal: string;
     preDocsReceived: string;
     fullDocsTotal: string;
     fullDocsReceived: string;
     lastDocReceived: string;
   };
   ```

2. Populate with `optionalEnv('GHL_OPP_FIELD_DOC_STATUS_ID')`, etc.

3. Update `validateConfig()` to also validate `opportunityFieldIds` using an `oppFieldIdToEnvKey` helper. IMPORTANT: Unlike `fieldIds` which throws on empty values, `opportunityFieldIds` should LOG a warning for empty values but NOT throw. This is because the opportunity fields won't exist until the human runs the setup script in Plan 10-02. The pattern: iterate `opportunityFieldIds`, if any value is empty, push to a `warnings` array (not `missing`), and log them as `console.warn('[CRM config] Opportunity field IDs not yet configured (run setup script with --model=opportunity):', warnings)`. This matches the existing approach where `optionalEnv` defaults to `''` — the config is valid with empty strings, but runtime code in Plans 03/04 will check for non-empty IDs before attempting opportunity-level writes.

NOTE on execution order: `opportunityFieldIds` will have empty strings until Plan 10-02 checkpoint completes (human runs setup script and populates .env). This is expected and safe — Plan 10-01 only adds config READING, and Plans 03/04 (Wave 2) are the first to USE the field IDs at runtime. The empty-string-safe validation here ensures Plan 10-01 can be executed in parallel with Plan 10-02 without issues.

Do NOT remove existing contact-level `fieldIds` — they remain for backward compatibility during migration. The contact fields will be deprecated in Plan 10-05.
  </action>
  <verify>Run `npx vitest run --reporter=verbose 2>&1 | tail -20` — all existing tests pass (no regressions from adding types/config).</verify>
  <done>CrmOpportunity type exists with opportunity-specific customFields format. EXISTING_OPP_FIELDS has the 4 Finmo field IDs. CrmConfig has opportunityFieldIds populated from GHL_OPP_FIELD_* env vars. validateConfig checks both fieldIds and opportunityFieldIds.</done>
</task>

<task type="auto">
  <name>Task 2: Rewrite opportunities.ts with search/get/update functions and tests</name>
  <files>src/crm/opportunities.ts, src/crm/__tests__/opportunities.test.ts</files>
  <action>
**Rewrite `src/crm/opportunities.ts`:**

Keep the existing `oppFetch` helper and error handling. Replace `upsertOpportunity`, `moveToCollectingDocs`, and `moveToAllDocsReceived` with new functions:

1. **`searchOpportunities(contactId, pipelineId)`** — `GET /opportunities/search` with query params.
   CRITICAL: Search params use underscores: `location_id`, `pipeline_id`, `contact_id` (NOT camelCase). Return `CrmOpportunity[]`.

2. **`getOpportunity(opportunityId)`** — `GET /opportunities/{id}`. Returns full `CrmOpportunity` with customFields.

3. **`updateOpportunityFields(opportunityId, customFields)`** — `PUT /opportunities/{id}` with `{ customFields }` body. customFields format: `[{ id, field_value }]` (same write format as contacts).

4. **`updateOpportunityStage(opportunityId, stageId)`** — `PUT /opportunities/{id}` with `{ pipelineStageId }`.

5. **`findOpportunityByFinmoId(contactId, pipelineId, finmoApplicationId)`** — Searches opportunities by contactId+pipelineId, then client-side filters by matching `EXISTING_OPP_FIELDS.FINMO_APPLICATION_ID` custom field value against finmoApplicationId.
   - Uses helper `getOpportunityFieldValue(opp, fieldId)` that handles the opportunity custom field response format: checks `fieldValueString`, `fieldValueNumber`, and `fieldValueDate` based on `type` field.
   - If finmoApplicationId match found, return that opportunity.
   - If no match but only one opportunity, return it (single-deal fallback per OPP-08).
   - If multiple opportunities and no match, return null (ambiguous — caller must handle).

6. **`getOpportunityFieldValue(opp, fieldId)`** — Pure helper that extracts a field value from a CrmOpportunity's customFields array. Returns the value from whichever typed field is present (`fieldValueString` || `fieldValueNumber` || `fieldValueDate`), or `undefined` if field not found. Export this — tracking-sync needs it.

Mark `upsertOpportunity`, `moveToCollectingDocs`, `moveToAllDocsReceived` as `@deprecated` with JSDoc (keep them for now — Plan 05 removes usages).

**Create `src/crm/__tests__/opportunities.test.ts`:**

Mock `oppFetch` via vi.mock on the fetch global (same pattern as contacts.test.ts). Test:
- `searchOpportunities`: correct URL with underscore params, parses response
- `getOpportunity`: correct URL, returns CrmOpportunity
- `updateOpportunityFields`: correct PUT body with customFields
- `updateOpportunityStage`: correct PUT body with pipelineStageId
- `findOpportunityByFinmoId`: returns match by Finmo Application ID field, falls back to single opportunity, returns null on ambiguous multi-deal
- `getOpportunityFieldValue`: extracts string, number, date field values correctly; returns undefined for missing field
- Error handling: 429 -> CrmRateLimitError, 401 -> CrmAuthError, other -> CrmApiError
  </action>
  <verify>Run `npx vitest run src/crm/__tests__/opportunities.test.ts --reporter=verbose` — all new tests pass. Then `npx vitest run --reporter=verbose 2>&1 | tail -5` — full suite still passes.</verify>
  <done>opportunities.ts exports searchOpportunities, getOpportunity, updateOpportunityFields, updateOpportunityStage, findOpportunityByFinmoId, getOpportunityFieldValue. Deprecated functions still exist but are marked @deprecated. All tests pass.</done>
</task>

</tasks>

<verification>
1. `npx vitest run --reporter=verbose` — all tests pass (existing + new opportunities tests)
2. `npx tsc --noEmit` — no TypeScript errors
3. CrmOpportunity type has opportunityCustomField format (fieldValueString/fieldValueNumber/fieldValueDate)
4. Search params use underscores in the URL (location_id, pipeline_id, contact_id)
5. Write format uses { id, field_value } (same as contacts)
6. getOpportunityFieldValue handles all 3 typed field variants
</verification>

<success_criteria>
- CrmOpportunity type with opportunity-specific custom field format exists
- 6 new opportunity functions exported and tested
- Existing deprecated functions still compile (no breakage)
- Full test suite passes
</success_criteria>

<output>
After completion, create `.planning/phases/10-opportunity-centric-architecture/10-01-SUMMARY.md`
</output>
