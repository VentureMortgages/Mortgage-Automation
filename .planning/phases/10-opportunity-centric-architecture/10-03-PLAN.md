---
phase: 10-opportunity-centric-architecture
plan: 03
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - src/crm/checklist-sync.ts
  - src/crm/__tests__/checklist-sync.test.ts
autonomous: true
requirements: [OPP-01, OPP-02, OPP-06, OPP-08]

must_haves:
  truths:
    - "syncChecklistToCrm finds Finmo's existing opportunity instead of creating its own"
    - "Doc tracking fields are written to the opportunity, not the contact"
    - "Pipeline stage is set on the found opportunity, not via upsert"
    - "Contact still receives borrower details (name, email, phone) but NOT doc tracking fields"
    - "If no opportunity found, contact-level doc tracking is used as fallback (backward compat)"
  artifacts:
    - path: "src/crm/checklist-sync.ts"
      provides: "Checklist sync orchestrator writing to opportunity"
      exports: ["syncChecklistToCrm"]
    - path: "src/crm/__tests__/checklist-sync.test.ts"
      provides: "Updated tests verifying opportunity-level writes"
  key_links:
    - from: "src/crm/checklist-sync.ts"
      to: "src/crm/opportunities.ts"
      via: "findOpportunityByFinmoId + updateOpportunityFields + updateOpportunityStage"
      pattern: "findOpportunityByFinmoId|updateOpportunityFields|updateOpportunityStage"
    - from: "src/crm/checklist-sync.ts"
      to: "src/crm/contacts.ts"
      via: "upsertContact (borrower details only, no doc tracking fields)"
      pattern: "upsertContact"
---

<objective>
Refactor checklist-sync.ts to write doc tracking fields to the opportunity instead of the contact, and find Finmo's existing opportunity instead of creating a new one.

Purpose: This is the core behavior change of Phase 10 — the webhook worker's CRM sync step now targets the opportunity for doc tracking.

Output: Updated syncChecklistToCrm that searches for existing opportunity, writes doc tracking to it, and falls back to contact-level if no opportunity found.
</objective>

<execution_context>
@C:/Users/lucac/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/lucac/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-opportunity-centric-architecture/10-RESEARCH.md
@.planning/phases/10-opportunity-centric-architecture/10-01-SUMMARY.md

@src/crm/checklist-sync.ts
@src/crm/__tests__/checklist-sync.test.ts
@src/crm/checklist-mapper.ts
@src/crm/contacts.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor checklist-sync.ts for opportunity-level tracking</name>
  <files>src/crm/checklist-sync.ts</files>
  <action>
Rewrite the sync orchestrator to use opportunity-level doc tracking. The new flow:

1. **Map checklist to CRM fields** — same pure function, but pass `crmConfig.opportunityFieldIds` instead of `crmConfig.fieldIds` when targeting opportunity. Keep the mapper function generic (it takes `{ fieldIds }` config).

2. **Upsert contact** — still create/update the contact with borrower details (name, email, phone). But do NOT include doc tracking custom fields on the contact. The contact upsert should only have basic borrower info and any non-doc-tracking fields.

3. **Find Finmo's existing opportunity** — call `findOpportunityByFinmoId(contactId, PIPELINE_IDS.LIVE_DEALS, input.finmoApplicationId)`.
   - `input.finmoApplicationId` is a NEW field on `SyncChecklistInput` (the Finmo application UUID, e.g., `98f332e4-...`). This comes from `finmoApp.application.id` in the webhook worker.
   - Note: `input.finmoDealId` already exists but is the deal code (e.g., `BRXM-F050382`). The application ID is different — it's the UUID used in Finmo's opportunity custom field.

4. **If opportunity found:**
   - Write doc tracking custom fields to opportunity via `updateOpportunityFields(opportunityId, fieldUpdates)`
   - Set stage to "Collecting Documents" via `updateOpportunityStage(opportunityId, crmConfig.stageIds.collectingDocuments)`
   - Return `opportunityId` in result

5. **If NO opportunity found (fallback for backward compat — OPP-08):**
   - Log warning: `[syncChecklistToCrm] No Finmo opportunity found, falling back to contact-level tracking`
   - Write doc tracking fields to contact via upsertContact (the old behavior)
   - Do NOT try to create an opportunity (that's the anti-pattern we're fixing)
   - Set `opportunityId` to undefined in result

6. **Create review task** — still creates on contact (tasks stay on contacts in GHL)

**Update `SyncChecklistInput`:**
- Add `finmoApplicationId?: string` — the UUID from `finmoApp.application.id`
- Keep `finmoDealId` (used for other things)

**Update `SyncChecklistResult`:**
- Add `trackingTarget: 'opportunity' | 'contact'` — indicates where doc tracking was written

Import new functions from opportunities.ts: `findOpportunityByFinmoId`, `updateOpportunityFields`, `updateOpportunityStage`.
Remove import of `moveToCollectingDocs`.
  </action>
  <verify>Run `npx tsc --noEmit` — no TypeScript errors.</verify>
  <done>syncChecklistToCrm finds Finmo's opportunity, writes doc tracking to it, falls back to contact if not found. SyncChecklistInput has finmoApplicationId. SyncChecklistResult has trackingTarget.</done>
</task>

<task type="auto">
  <name>Task 2: Update checklist-sync tests for opportunity-level tracking</name>
  <files>src/crm/__tests__/checklist-sync.test.ts</files>
  <action>
Rewrite the test file to verify the new opportunity-centric behavior.

**Mock changes:**
- Replace `moveToCollectingDocs` mock with mocks for `findOpportunityByFinmoId`, `updateOpportunityFields`, `updateOpportunityStage`
- Keep `upsertContact`, `createReviewTask`, `mapChecklistToFields`, `buildChecklistSummary` mocks
- Update config mock to include `opportunityFieldIds` alongside `fieldIds`

**Test cases:**

1. **Happy path: opportunity found**
   - `findOpportunityByFinmoId` returns `{ id: 'opp-123', ... }`
   - Verify `updateOpportunityFields` called with opp-123 and field updates
   - Verify `updateOpportunityStage` called with opp-123 and collectingDocuments stage ID
   - Verify `upsertContact` called WITHOUT doc tracking custom fields (only borrower info)
   - Verify result has `trackingTarget: 'opportunity'`

2. **Fallback: no opportunity found**
   - `findOpportunityByFinmoId` returns null
   - Verify `upsertContact` called WITH doc tracking custom fields (fallback behavior)
   - Verify `updateOpportunityFields` NOT called
   - Verify result has `trackingTarget: 'contact'`
   - Verify warning is logged

3. **Contact upsert still gets borrower details** in both paths

4. **Review task still created on contact** (not opportunity)

5. **Error handling:**
   - Opportunity search failure: non-fatal, falls back to contact
   - Opportunity field update failure: non-fatal, captured in errors[]
   - Stage update failure: non-fatal, captured in errors[]

6. **mapChecklistToFields called with correct fieldIds:**
   - When targeting opportunity: uses `opportunityFieldIds`
   - When falling back to contact: uses `fieldIds`
  </action>
  <verify>Run `npx vitest run src/crm/__tests__/checklist-sync.test.ts --reporter=verbose` — all tests pass. Then `npx vitest run --reporter=verbose 2>&1 | tail -5` — full suite passes.</verify>
  <done>checklist-sync tests cover opportunity-found path, contact-fallback path, error handling, and correct fieldIds usage. All tests pass.</done>
</task>

</tasks>

<verification>
1. `npx vitest run --reporter=verbose` — all tests pass
2. `npx tsc --noEmit` — no TypeScript errors
3. syncChecklistToCrm never calls upsertOpportunity or moveToCollectingDocs
4. Doc tracking fields go to opportunity when found, contact when not
5. Contact always gets basic borrower info (no doc tracking fields when opportunity is used)
</verification>

<success_criteria>
- syncChecklistToCrm uses findOpportunityByFinmoId to locate Finmo's opportunity
- Doc tracking written to opportunity via updateOpportunityFields
- Stage set via updateOpportunityStage (not upsert)
- Contact fallback works when no opportunity found
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/10-opportunity-centric-architecture/10-03-SUMMARY.md`
</output>
