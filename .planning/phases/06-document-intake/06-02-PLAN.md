---
phase: 06-document-intake
plan: 02
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/intake/pdf-converter.ts
  - src/intake/__tests__/pdf-converter.test.ts
autonomous: true

must_haves:
  truths:
    - "JPEG image buffer is converted to a valid PDF buffer"
    - "PNG image buffer is converted to a valid PDF buffer"
    - "PDF buffer passes through unchanged"
    - "Word documents are flagged for manual review (not auto-converted)"
    - "Unsupported MIME types are rejected with a descriptive error"
  artifacts:
    - path: "src/intake/pdf-converter.ts"
      provides: "convertToPdf pure function for image-to-PDF conversion"
      exports: ["convertToPdf", "ConversionResult"]
    - path: "src/intake/__tests__/pdf-converter.test.ts"
      provides: "TDD tests for PDF conversion covering all MIME types"
      min_lines: 50
  key_links:
    - from: "src/intake/pdf-converter.ts"
      to: "pdf-lib"
      via: "PDFDocument.create + embedPng/embedJpg"
      pattern: "PDFDocument"
---

<objective>
Build the PDF conversion module using TDD. This is a pure-function module that converts image attachments (JPEG, PNG) to PDF using pdf-lib, passes PDFs through unchanged, and flags Word documents for manual review.

Purpose: INTAKE-04 requires non-PDF documents to be auto-converted to PDF before downstream processing. Image-to-PDF conversion via pdf-lib is a well-defined input/output operation ideal for TDD. Word document conversion is deferred (requires LibreOffice system dependency) -- instead, Word docs are flagged for Cat's manual conversion.

Output: src/intake/pdf-converter.ts with convertToPdf function, comprehensive test suite
</objective>

<execution_context>
@C:/Users/lucac/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/lucac/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-document-intake/06-RESEARCH.md
</context>

<feature>
  <name>PDF Converter</name>
  <files>src/intake/pdf-converter.ts, src/intake/__tests__/pdf-converter.test.ts</files>
  <behavior>
    The convertToPdf function takes a Buffer and a MIME type string and returns a ConversionResult:

    ```typescript
    interface ConversionResult {
      /** The output PDF buffer (same as input for PDFs, converted for images) */
      pdfBuffer: Buffer;
      /** Whether conversion was performed */
      converted: boolean;
      /** If conversion was skipped, the reason */
      skippedReason?: string;
    }
    ```

    Cases:
    - `convertToPdf(jpegBuffer, 'image/jpeg')` -> `{ pdfBuffer: <valid PDF>, converted: true }`
    - `convertToPdf(pngBuffer, 'image/png')` -> `{ pdfBuffer: <valid PDF>, converted: true }`
    - `convertToPdf(pdfBuffer, 'application/pdf')` -> `{ pdfBuffer: pdfBuffer, converted: false }` (passthrough)
    - `convertToPdf(docxBuffer, 'application/vnd.openxmlformats-officedocument.wordprocessingml.document')` -> throws ConversionError with message containing "manual review" and "Word"
    - `convertToPdf(docBuffer, 'application/msword')` -> throws ConversionError with message containing "manual review" and "Word"
    - `convertToPdf(anyBuffer, 'video/mp4')` -> throws ConversionError with message containing "unsupported"
    - `convertToPdf(emptyBuffer, 'image/jpeg')` -> throws ConversionError with message about empty/corrupt

    The output PDF buffer should:
    - Start with `%PDF` magic bytes
    - Have a page matching the image dimensions (for image conversion)
    - Be a valid PDF (parseable by PDFDocument.load)

    ConversionError extends Error with a `code` property:
    - 'WORD_MANUAL_REVIEW' for Word docs
    - 'UNSUPPORTED_TYPE' for unknown MIME types
    - 'CONVERSION_FAILED' for corrupt/empty input or pdf-lib errors

    Install pdf-lib: `npm install pdf-lib`
  </behavior>
  <implementation>
    Use pdf-lib (pure JS, no native deps):
    - For 'image/jpeg': `PDFDocument.create()` -> `pdfDoc.embedJpg(buffer)` -> add page matching image dimensions -> `pdfDoc.save()`
    - For 'image/png': `PDFDocument.create()` -> `pdfDoc.embedPng(buffer)` -> add page matching image dimensions -> `pdfDoc.save()`
    - For 'application/pdf': return input buffer unchanged with `converted: false`
    - For Word MIME types: throw ConversionError('WORD_MANUAL_REVIEW')
    - For anything else: throw ConversionError('UNSUPPORTED_TYPE')

    Wrap pdf-lib operations in try/catch to convert pdf-lib errors into ConversionError('CONVERSION_FAILED').

    For test fixtures:
    - Create a minimal valid JPEG buffer (smallest valid JPEG: FFD8FFE000104A46494600... ~107 bytes)
    - Create a minimal valid PNG buffer (smallest valid 1x1 PNG: ~67 bytes)
    - Create a valid PDF buffer using PDFDocument.create() + save()
    - Use Buffer.from() with known byte sequences for test images

    The simplest valid test image approach: use pdf-lib itself to create test PDFs, and for images, use tiny valid JPEG/PNG byte sequences. A 1x1 white JPEG is about 107 bytes and can be hardcoded as a hex string. A 1x1 white PNG is ~67 bytes.
  </implementation>
</feature>

<verification>
- `npx vitest run src/intake/__tests__/pdf-converter.test.ts` passes all tests
- JPEG -> PDF produces buffer starting with %PDF
- PNG -> PDF produces buffer starting with %PDF
- PDF passthrough returns identical buffer
- Word types throw ConversionError with code 'WORD_MANUAL_REVIEW'
- Unsupported types throw ConversionError with code 'UNSUPPORTED_TYPE'
- Empty/corrupt input throws ConversionError with code 'CONVERSION_FAILED'
</verification>

<success_criteria>
- convertToPdf handles all five cases: JPEG, PNG, PDF passthrough, Word rejection, unsupported rejection
- All tests follow RED -> GREEN -> REFACTOR TDD cycle
- pdf-lib is installed and working
- No native dependencies required (pure JS)
</success_criteria>

<output>
After completion, create `.planning/phases/06-document-intake/06-02-SUMMARY.md`
</output>
