---
phase: 06-document-intake
plan: 03
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/intake/gmail-reader.ts
  - src/intake/attachment-extractor.ts
  - src/intake/__tests__/gmail-reader.test.ts
  - src/intake/__tests__/attachment-extractor.test.ts
autonomous: true

must_haves:
  truths:
    - "System can poll Gmail inbox for new messages since a given historyId"
    - "System gracefully recovers when historyId becomes stale (falls back to recent messages)"
    - "Attachments are recursively extracted from nested MIME parts"
    - "Base64url attachment data is correctly decoded to Buffer"
    - "Forwarded emails with inline attachments are handled correctly"
    - ".eml attachments are flagged for manual review (not recursively parsed)"
  artifacts:
    - path: "src/intake/gmail-reader.ts"
      provides: "Gmail inbox polling via history API with stale ID recovery"
      exports: ["pollForNewMessages", "getMessageDetails", "getInitialHistoryId"]
    - path: "src/intake/attachment-extractor.ts"
      provides: "MIME part walking and attachment data download"
      exports: ["extractAttachments", "downloadAttachment"]
    - path: "src/intake/__tests__/gmail-reader.test.ts"
      provides: "Tests for Gmail polling with mocked API"
      min_lines: 60
    - path: "src/intake/__tests__/attachment-extractor.test.ts"
      provides: "Tests for MIME walking and attachment extraction"
      min_lines: 50
  key_links:
    - from: "src/intake/gmail-reader.ts"
      to: "src/email/gmail-client.ts"
      via: "getGmailReadonlyClient"
      pattern: "getGmailReadonlyClient"
    - from: "src/intake/gmail-reader.ts"
      to: "googleapis"
      via: "users.history.list and users.messages.get"
      pattern: "history\\.list|messages\\.get"
    - from: "src/intake/attachment-extractor.ts"
      to: "googleapis"
      via: "users.messages.attachments.get"
      pattern: "attachments\\.get"
    - from: "src/intake/attachment-extractor.ts"
      to: "src/intake/types.ts"
      via: "AttachmentInfo type"
      pattern: "AttachmentInfo"
---

<objective>
Build the Gmail reading infrastructure: inbox polling via history API and attachment extraction from MIME parts.

Purpose: INTAKE-01 requires monitoring the docs@ inbox for new messages within 5 minutes. INTAKE-03 requires extracting PDF, image, and Word attachments from emails. This plan implements the Gmail API reading layer that the monitor (Plan 04) will schedule.

Output: src/intake/gmail-reader.ts (polling logic), src/intake/attachment-extractor.ts (MIME walking + download), test suites for both
</objective>

<execution_context>
@C:/Users/lucac/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/lucac/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-document-intake/06-RESEARCH.md
@.planning/phases/06-document-intake/06-01-SUMMARY.md
@src/email/gmail-client.ts
@src/intake/types.ts
@src/intake/config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Gmail reader with history-based polling</name>
  <files>src/intake/gmail-reader.ts, src/intake/__tests__/gmail-reader.test.ts</files>
  <action>
Create `src/intake/gmail-reader.ts` with three exported functions:

**1. `getInitialHistoryId(gmailClient): Promise<string>`**
- Calls `gmail.users.getProfile({ userId: 'me' })` to get the current historyId
- Returns the historyId as a string
- Used on first startup when no stored historyId exists

**2. `pollForNewMessages(gmailClient, startHistoryId): Promise<{ messageIds: string[], newHistoryId: string }>`**
- Calls `gmail.users.history.list({ userId: 'me', startHistoryId, historyTypes: ['messageAdded'], labelId: 'INBOX' })`
- Extracts new message IDs from `history.data.history[].messagesAdded[].message.id`
- Deduplicates message IDs (same message can appear in multiple history records)
- Returns `{ messageIds, newHistoryId }` where newHistoryId is from the response (for next poll)
- **Stale historyId recovery:** If history.list returns a 404 or error indicating stale historyId:
  - Fall back to `gmail.users.messages.list({ userId: 'me', q: 'newer_than:1d', labelIds: ['INBOX'], maxResults: 50 })`
  - Get new historyId from `gmail.users.getProfile`
  - Log warning: `[intake] historyId stale, falling back to recent messages`
  - Return the fallback results

**3. `getMessageDetails(gmailClient, messageId): Promise<GmailMessageMeta>`**
- Calls `gmail.users.messages.get({ userId: 'me', id: messageId, format: 'full' })`
- Extracts: messageId, threadId, from (from headers), subject (from headers), date (from headers), historyId
- Parses the `From` header to extract the email address (handle "Name <email>" format)
- Returns GmailMessageMeta object

**Gmail client parameter:** All functions accept the gmail client as the first parameter (not calling getGmailReadonlyClient internally). This keeps the functions pure and testable -- the caller (monitor) provides the client.

**Import notes:** Use `.js` extensions. Import `GmailMessageMeta` from `../intake/types.js`. The gmail client type is `ReturnType<typeof google.gmail>` from googleapis -- import `google` from `googleapis` for the type.

Create `src/intake/__tests__/gmail-reader.test.ts`:
- Mock the gmail client (create a mock object matching the API shape)
- Test pollForNewMessages with history containing messages -> returns message IDs
- Test pollForNewMessages with empty history (no new messages) -> returns empty array
- Test pollForNewMessages with duplicate message IDs in history -> deduplicates
- Test stale historyId recovery (mock history.list throwing 404 error, verify fallback to messages.list)
- Test getMessageDetails extracts correct fields from headers
- Test getMessageDetails parses "Name <email>" format correctly
- Test getInitialHistoryId returns profile historyId

Use `vi.fn()` for mock API methods. Pattern: create a mock gmail object with nested `users.history.list`, `users.messages.get`, `users.messages.list`, `users.getProfile` methods as vi.fn(). Use `vi.hoisted()` if needed for mock variables shared between vi.mock and test body (per project convention).
  </action>
  <verify>Run `npx vitest run src/intake/__tests__/gmail-reader.test.ts` and confirm all tests pass. Run `npx tsc --noEmit` with no errors.</verify>
  <done>pollForNewMessages returns new message IDs from history API and recovers from stale historyId. getMessageDetails extracts sender email, subject, date from message headers. getInitialHistoryId returns profile historyId. All functions accept gmail client as parameter for testability. Tests cover happy path, empty results, deduplication, stale recovery, and header parsing.</done>
</task>

<task type="auto">
  <name>Task 2: Create attachment extractor with MIME part walking</name>
  <files>src/intake/attachment-extractor.ts, src/intake/__tests__/attachment-extractor.test.ts</files>
  <action>
Create `src/intake/attachment-extractor.ts` with two exported functions:

**1. `extractAttachments(messageParts): AttachmentInfo[]`**
- Takes the `payload.parts` array from a Gmail message (type from gmail_v1.Schema$MessagePart)
- Recursively walks the MIME part tree
- For each part with a `filename` and `body.attachmentId`: creates an AttachmentInfo object
- Handles nested multipart structures (e.g., multipart/mixed containing multipart/alternative containing attachments)
- Special case: if a part has mimeType `message/rfc822` (forwarded email as attachment), include it with a flag -- set mimeType to 'message/rfc822' so downstream code can detect and flag for manual review
- Returns an array of AttachmentInfo objects

**2. `downloadAttachment(gmailClient, messageId, attachmentId): Promise<Buffer>`**
- Calls `gmail.users.messages.attachments.get({ userId: 'me', messageId, id: attachmentId })`
- Decodes the base64url-encoded data: `Buffer.from(data.data!, 'base64url')`
- Returns the raw Buffer

**Type for messageParts:** Use the type from googleapis:
```typescript
import type { gmail_v1 } from 'googleapis';
type MessagePart = gmail_v1.Schema$MessagePart;
```

Create `src/intake/__tests__/attachment-extractor.test.ts`:
- Test extractAttachments with a simple single-attachment message -> returns 1 AttachmentInfo
- Test extractAttachments with multiple attachments -> returns all
- Test extractAttachments with nested multipart parts (parts within parts) -> finds deeply nested attachments
- Test extractAttachments with no attachments (text-only email) -> returns empty array
- Test extractAttachments with .eml attachment (message/rfc822) -> includes it with correct mimeType
- Test extractAttachments skips parts without filename (inline text parts, HTML parts)
- Test downloadAttachment decodes base64url correctly (provide known base64url string, verify buffer content)

For test fixtures, create mock MessagePart objects matching the Gmail API shape:
```typescript
const mockPart: MessagePart = {
  partId: '1',
  mimeType: 'application/pdf',
  filename: 'document.pdf',
  body: { attachmentId: 'att-123', size: 1024 },
};
```

For nested structures, create parts with `parts` arrays containing sub-parts.
  </action>
  <verify>Run `npx vitest run src/intake/__tests__/attachment-extractor.test.ts` and confirm all tests pass. Run `npx tsc --noEmit` with no errors.</verify>
  <done>extractAttachments recursively walks MIME part tree and returns AttachmentInfo for all file attachments. downloadAttachment fetches and decodes base64url attachment data. .eml attachments are detected by mimeType. Parts without filename are skipped. Tests cover single attachment, multiple attachments, nested parts, no attachments, .eml detection, and base64url decoding.</done>
</task>

</tasks>

<verification>
- `npx vitest run src/intake/__tests__/` passes all gmail-reader and attachment-extractor tests
- `npx tsc --noEmit` passes with no errors
- pollForNewMessages + getMessageDetails + extractAttachments + downloadAttachment cover the full Gmail reading pipeline
- Stale historyId recovery is implemented and tested
- .eml attachments are detected (not silently dropped)
</verification>

<success_criteria>
- Gmail inbox can be polled efficiently using history API (delta reads, not full inbox scan)
- Attachments are extracted from arbitrarily nested MIME structures
- Attachment data is correctly decoded from base64url to Buffer
- Edge cases handled: stale historyId, no attachments, .eml files, duplicate messages
</success_criteria>

<output>
After completion, create `.planning/phases/06-document-intake/06-03-SUMMARY.md`
</output>
