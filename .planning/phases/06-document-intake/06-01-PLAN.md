---
phase: 06-document-intake
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/intake/types.ts
  - src/intake/config.ts
  - src/email/gmail-client.ts
autonomous: true

must_haves:
  truths:
    - "IntakeDocument type captures all fields needed for downstream Phase 7 processing"
    - "Gmail client can be instantiated with gmail.readonly scope for reading messages"
    - "Gmail client can impersonate a different mailbox (docs@ vs admin@)"
    - "Intake config provides polling interval, supported MIME types, and docs inbox address"
  artifacts:
    - path: "src/intake/types.ts"
      provides: "IntakeDocument, GmailMessageMeta, AttachmentInfo, ConversionStrategy types"
      exports: ["IntakeDocument", "GmailMessageMeta", "AttachmentInfo", "ConversionStrategy", "IntakeSource"]
    - path: "src/intake/config.ts"
      provides: "Intake configuration with polling interval, max attachment size, supported MIME types"
      exports: ["intakeConfig", "IntakeConfig", "SUPPORTED_MIME_TYPES", "getConversionStrategy"]
    - path: "src/email/gmail-client.ts"
      provides: "Refactored Gmail client supporting both compose and readonly scopes with impersonation"
      exports: ["getGmailClient", "getGmailReadonlyClient", "GmailAuthError"]
  key_links:
    - from: "src/intake/config.ts"
      to: "src/email/config.ts"
      via: "docInbox address reference"
      pattern: "docInbox"
    - from: "src/email/gmail-client.ts"
      to: "googleapis"
      via: "JWT with gmail.readonly scope"
      pattern: "gmail\\.readonly"
---

<objective>
Create the foundation types, configuration, and Gmail client infrastructure for the document intake module.

Purpose: All subsequent intake plans depend on these shared types and the ability to read from a Gmail inbox. The existing Gmail client only supports compose scope; Phase 6 requires readonly access to a potentially different mailbox (docs@venturemortgages.co). This plan establishes the type contracts and infrastructure before any feature code is built.

Output: src/intake/types.ts, src/intake/config.ts, refactored src/email/gmail-client.ts
</objective>

<execution_context>
@C:/Users/lucac/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/lucac/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-document-intake/06-RESEARCH.md
@src/email/gmail-client.ts
@src/email/config.ts
@src/email/types.ts
@src/config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create intake types and configuration module</name>
  <files>src/intake/types.ts, src/intake/config.ts</files>
  <action>
Create `src/intake/types.ts` with the following types:

```typescript
/** Where the document came from */
export type IntakeSource = 'gmail' | 'finmo';

/** Conversion strategy for a MIME type */
export type ConversionStrategy = 'pdf' | 'image-to-pdf' | 'word-to-pdf' | 'unsupported';

/** Metadata about a Gmail message (not the full message content) */
export interface GmailMessageMeta {
  messageId: string;
  threadId: string | null;
  from: string;
  subject: string;
  date: string;
  historyId: string;
}

/** Attachment info extracted from a Gmail message part */
export interface AttachmentInfo {
  filename: string;
  mimeType: string;
  attachmentId: string;
  size: number;
}

/** A document extracted from an intake source, ready for Phase 7 classification */
export interface IntakeDocument {
  /** Unique ID for deduplication (e.g., gmail-{messageId}-{attachmentIndex} or finmo-{docRequestId}) */
  id: string;
  /** Raw PDF bytes (already converted if needed) */
  pdfBuffer: Buffer;
  /** Original filename from email attachment or Finmo */
  originalFilename: string;
  /** Original MIME type before conversion */
  originalMimeType: string;
  /** Where the document came from */
  source: IntakeSource;
  /** Email address of the sender (for client matching in Phase 7) */
  senderEmail: string | null;
  /** Associated Finmo application ID (if from Finmo portal) */
  applicationId: string | null;
  /** Gmail message ID (for dedup and audit trail) */
  gmailMessageId: string | null;
  /** Timestamp of intake */
  receivedAt: string;
}

/** Job data for the intake BullMQ queue */
export interface IntakeJobData {
  source: IntakeSource;
  /** Gmail message ID (for gmail source) */
  gmailMessageId?: string;
  /** Finmo application ID (for finmo source) */
  applicationId?: string;
  /** Finmo document request ID (for finmo source) */
  documentRequestId?: string;
  receivedAt: string;
}

/** Result from processing an intake job */
export interface IntakeResult {
  documentsProcessed: number;
  documentIds: string[];
  errors: string[];
}
```

Create `src/intake/config.ts`:

```typescript
import 'dotenv/config';

export interface IntakeConfig {
  /** Polling interval in milliseconds (default: 120000 = 2 minutes) */
  pollIntervalMs: number;
  /** Maximum attachment size in bytes (default: 25MB, matching Gmail's limit) */
  maxAttachmentBytes: number;
  /** The inbox to monitor for incoming documents */
  docsInbox: string;
  /** Whether intake monitoring is enabled */
  enabled: boolean;
}

/** Supported MIME types and their conversion strategies */
export const SUPPORTED_MIME_TYPES = new Map<string, ConversionStrategy>([
  ['application/pdf', 'pdf'],
  ['image/jpeg', 'image-to-pdf'],
  ['image/png', 'image-to-pdf'],
  ['image/tiff', 'image-to-pdf'],
  ['image/webp', 'image-to-pdf'],
  ['application/vnd.openxmlformats-officedocument.wordprocessingml.document', 'word-to-pdf'],
  ['application/msword', 'word-to-pdf'],
]);

export function getConversionStrategy(mimeType: string): ConversionStrategy {
  return SUPPORTED_MIME_TYPES.get(mimeType) ?? 'unsupported';
}

const isDev = (process.env.APP_ENV ?? 'development') !== 'production';

export const intakeConfig: IntakeConfig = {
  pollIntervalMs: parseInt(process.env.INTAKE_POLL_INTERVAL_MS ?? '120000', 10),
  maxAttachmentBytes: parseInt(process.env.INTAKE_MAX_ATTACHMENT_BYTES ?? String(25 * 1024 * 1024), 10),
  docsInbox: process.env.DOC_INBOX ?? (isDev ? 'dev@venturemortgages.com' : 'docs@venturemortgages.co'),
  enabled: process.env.INTAKE_ENABLED !== 'false', // Enabled by default
};
```

Import `ConversionStrategy` from `./types.js` in config.ts. Use `.js` extensions for all local imports (NodeNext module resolution). Follow the same config pattern as `src/email/config.ts` and `src/config.ts` (dotenv/config import at top, isDev detection, optionalEnv via process.env with defaults).
  </action>
  <verify>Run `npx tsc --noEmit` and confirm no errors in the new files. Confirm src/intake/types.ts and src/intake/config.ts exist on disk.</verify>
  <done>IntakeDocument, GmailMessageMeta, AttachmentInfo, ConversionStrategy, IntakeJobData, IntakeResult types are defined. IntakeConfig with pollIntervalMs, maxAttachmentBytes, docsInbox, enabled is exported. SUPPORTED_MIME_TYPES map covers PDF, JPEG, PNG, TIFF, WebP, DOCX, DOC. getConversionStrategy returns correct strategy or 'unsupported'.</done>
</task>

<task type="auto">
  <name>Task 2: Refactor Gmail client to support readonly scope and mailbox impersonation</name>
  <files>src/email/gmail-client.ts</files>
  <action>
Refactor `src/email/gmail-client.ts` to support multiple Gmail client instances with different scopes and impersonation targets. The current client is hardcoded to `gmail.compose` scope and impersonates `emailConfig.senderAddress`.

**Changes needed:**

1. Extract a generic `createGmailClientForScope` internal function that accepts:
   - `scopes: string[]` - OAuth scopes to request
   - `impersonateAs: string` - Email address to impersonate (for service account delegation)

2. Keep the existing `getGmailClient()` function unchanged (returns compose-scoped client impersonating senderAddress). This preserves backward compatibility with Phase 5 email drafting.

3. Add a new `getGmailReadonlyClient(impersonateAs: string)` function that:
   - Creates a Gmail client with `gmail.readonly` scope
   - Impersonates the specified mailbox (e.g., docs@venturemortgages.co)
   - Uses lazy singleton pattern keyed by impersonateAs address (cache Map<string, gmail client>)
   - For OAuth2 mode: uses the same OAuth2 client (refresh token is per-user, so this may need a note that OAuth2 mode only works for the token's user)
   - For service account mode: creates JWT with gmail.readonly scope and specified subject

4. Update the singleton cache from a single variable to a Map<string, client> to support multiple cached clients (compose + readonly for different users).

**Important:** Do NOT change any existing exports or behavior. `getGmailClient()`, `createGmailDraft()`, `sendGmailDraft()`, `GmailAuthError`, and `wrapAuthError` must continue to work exactly as before. The existing tests must still pass.

**Auth mode notes for getGmailReadonlyClient:**
- Service account mode: Works with any user in the domain (specify impersonateAs)
- OAuth2 mode: The refresh token is tied to a specific user. `getGmailReadonlyClient` with OAuth2 can only read the inbox of the user who authorized the token. Log a warning if impersonateAs differs from the token's implicit user. Still create the client (it will fail at API call time if wrong user, which is acceptable for dev testing).
  </action>
  <verify>Run `npx vitest run` and confirm all 183 existing tests pass (no regressions). Run `npx tsc --noEmit` to confirm no type errors. Verify `getGmailReadonlyClient` is exported from the file.</verify>
  <done>getGmailReadonlyClient(impersonateAs) is exported and creates a Gmail client with gmail.readonly scope. getGmailClient() still works identically for compose operations. Service account mode creates JWT with readonly scope and specified subject. OAuth2 mode reuses existing credentials with a warning if impersonateAs differs. All 183 existing tests pass without modification.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with no errors in src/intake/ or src/email/
- `npx vitest run` passes all 183 existing tests (no regressions from gmail-client refactor)
- src/intake/types.ts exports IntakeDocument, GmailMessageMeta, AttachmentInfo, ConversionStrategy, IntakeSource, IntakeJobData, IntakeResult
- src/intake/config.ts exports intakeConfig, IntakeConfig, SUPPORTED_MIME_TYPES, getConversionStrategy
- src/email/gmail-client.ts exports getGmailReadonlyClient in addition to existing exports
</verification>

<success_criteria>
- Intake type system is established with all interfaces for downstream plans
- Gmail client supports readonly scope for inbox monitoring without breaking existing compose functionality
- Configuration provides all tunables (polling interval, max size, docs inbox, enable/disable)
- MIME type mapping covers all required document types (PDF, images, Word)
</success_criteria>

<output>
After completion, create `.planning/phases/06-document-intake/06-01-SUMMARY.md`
</output>
