---
phase: 03-checklist-generation
plan: 03
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/checklist/engine/generate-checklist.ts
  - src/checklist/engine/build-context.ts
  - src/checklist/engine/deduplicate.ts
  - src/checklist/engine/index.ts
autonomous: true

must_haves:
  truths:
    - "Engine iterates all borrowers and evaluates per_borrower rules for EACH borrower"
    - "Co-borrower application produces duplicate per-person items with borrower names (CHKL-04)"
    - "Multiple incomes per borrower are merged and document list is deduplicated"
    - "internalOnly items appear in internalFlags, NOT in borrower/property/shared items"
    - "All PRE and FULL items appear in a single output (CHKL-03)"
    - "Unknown field values produce warnings, not crashes"
  artifacts:
    - path: "src/checklist/engine/build-context.ts"
      provides: "Transforms raw Finmo response into per-borrower RuleContext objects"
      exports: ["buildBorrowerContexts", "buildSharedContext"]
    - path: "src/checklist/engine/deduplicate.ts"
      provides: "Deduplicates checklist items by ruleId within a borrower"
      exports: ["deduplicateItems"]
    - path: "src/checklist/engine/generate-checklist.ts"
      provides: "Main generateChecklist pure function"
      exports: ["generateChecklist"]
    - path: "src/checklist/engine/index.ts"
      provides: "Barrel export for engine"
      exports: ["generateChecklist"]
  key_links:
    - from: "src/checklist/engine/generate-checklist.ts"
      to: "src/checklist/rules/index.ts"
      via: "Imports allRules array"
      pattern: "import.*allRules.*from.*rules"
    - from: "src/checklist/engine/generate-checklist.ts"
      to: "src/checklist/engine/build-context.ts"
      via: "Uses buildBorrowerContexts to create per-borrower evaluation contexts"
      pattern: "buildBorrowerContexts"
    - from: "src/checklist/engine/generate-checklist.ts"
      to: "src/checklist/engine/deduplicate.ts"
      via: "Deduplicates items after evaluating all rules for a borrower"
      pattern: "deduplicateItems"
    - from: "src/checklist/engine/build-context.ts"
      to: "src/checklist/types/index.ts"
      via: "Uses Finmo types and RuleContext interface"
      pattern: "import.*from.*types"
---

<objective>
Build the checklist generation engine — the pure function that evaluates rules against a Finmo application and produces a structured GeneratedChecklist.

Purpose: This is the core execution logic. It takes a raw Finmo API response, builds evaluation contexts for each borrower, evaluates all rules, deduplicates results (critical for borrowers with multiple income types), separates internal-only items, groups output by borrower/property/shared, and produces the data structure consumed by Phase 4 (CRM) and Phase 5 (Email).

Output: A `generateChecklist(response: FinmoApplicationResponse, rules?: ChecklistRule[], currentDate?: Date): GeneratedChecklist` pure function.
</objective>

<execution_context>
@C:/Users/lucac/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/lucac/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-checklist-generation/03-RESEARCH.md
@.planning/phases/03-checklist-generation/03-01-SUMMARY.md
@DOC_CHECKLIST_RULES_V2.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build context factory and deduplication logic</name>
  <files>src/checklist/engine/build-context.ts, src/checklist/engine/deduplicate.ts</files>
  <action>
**`src/checklist/engine/build-context.ts`** — Transforms raw Finmo response into RuleContext objects.

Export `buildBorrowerContexts(response: FinmoApplicationResponse, currentDate: Date): RuleContext[]`:

1. Extract the subject property: find the property where `id === application.propertyId`. If not found, set to null and add a warning.

2. For each borrower in `response.borrowers`:
   a. Find their incomes: filter `response.incomes` where `borrowerId === borrower.id`
   b. Find their assets: filter `response.assets` where `owners` array includes `borrower.id`
   c. Find their liabilities: filter `response.liabilities` where `owners` array includes `borrower.id`
   d. Build a `RuleContext` object:
      ```
      {
        application: response.application,
        borrower: borrower,
        borrowerIncomes: borrowerIncomes,
        allBorrowers: response.borrowers,
        allIncomes: response.incomes,
        assets: response.assets,
        borrowerAssets: borrowerAssets,
        properties: response.properties,
        subjectProperty: subjectProperty,
        liabilities: response.liabilities,
        borrowerLiabilities: borrowerLiabilities,
        currentDate: currentDate,
      }
      ```

3. Return array of RuleContext objects (one per borrower, main borrower first).

Also export `findSubjectProperty(response: FinmoApplicationResponse): FinmoProperty | null` for reuse.

**`src/checklist/engine/deduplicate.ts`** — Handles multiple-income deduplication.

Export `deduplicateItems(items: ChecklistItem[]): ChecklistItem[]`:

When a borrower has multiple income entries (e.g., Karen has 2 jobs, both salaried), the engine evaluates income rules for EACH income entry. This can produce duplicate items (e.g., two "Recent pay stub" items). Deduplicate by `ruleId` — keep the first occurrence.

Also export `mergeNotes(items: ChecklistItem[]): ChecklistItem[]`:
If two items have the same ruleId but different notes (rare), merge notes with " / " separator.

The deduplication ensures CHKL-04 works correctly: co-borrowers each get their OWN items (not deduplicated across borrowers), but within a single borrower, duplicates from multiple income sources are collapsed.
  </action>
  <verify>Run `npx tsc --noEmit` — both files compile. Verify build-context.ts exports buildBorrowerContexts. Verify deduplicate.ts exports deduplicateItems.</verify>
  <done>Context factory correctly links borrowers to their incomes, assets, and liabilities. Deduplication operates within a single borrower only, preserving cross-borrower duplication for CHKL-04.</done>
</task>

<task type="auto">
  <name>Task 2: Build the main generateChecklist engine</name>
  <files>src/checklist/engine/generate-checklist.ts, src/checklist/engine/index.ts</files>
  <action>
**`src/checklist/engine/generate-checklist.ts`** — The core pure function.

Export `generateChecklist(response: FinmoApplicationResponse, rules?: ChecklistRule[], currentDate?: Date): GeneratedChecklist`:

Parameters:
- `response`: Full Finmo API response
- `rules`: Optional rule override (defaults to `allRules` from rules/index.ts). Allows testing with subsets.
- `currentDate`: Optional date override (defaults to `new Date()`). Allows deterministic testing.

Algorithm:

```
1. Build borrower contexts using buildBorrowerContexts(response, currentDate)

2. Initialize output:
   - borrowerChecklists: BorrowerChecklist[] = []
   - propertyChecklists: PropertyChecklist[] = []
   - sharedItems: ChecklistItem[] = []
   - internalFlags: InternalFlag[] = []
   - warnings: string[] = []

3. Separate rules by scope:
   - perBorrowerRules = rules.filter(r => r.scope === 'per_borrower')
   - perPropertyRules = rules.filter(r => r.scope === 'per_property')
   - sharedRules = rules.filter(r => r.scope === 'shared')

4. FOR EACH borrower context:
   a. Evaluate all perBorrowerRules against this context:
      - For each rule:
        - Try evaluating rule.condition(ctx)
        - If condition throws: add warning ("Rule {id} condition error: {message}"), skip rule
        - If condition returns true:
          - Check rule.excludeWhen: if defined and returns true, skip (CHKL-05)
          - Build ChecklistItem from rule
        - Set forEmail = !rule.internalOnly
   b. Deduplicate items using deduplicateItems()
   c. Separate: items with internalOnly go to internalFlags. Others go to borrowerChecklist.
   d. Create BorrowerChecklist:
      - borrowerId, borrowerName (firstName + " " + lastName), isMainBorrower
      - items: non-internal items only

5. FOR EACH property in response.properties:
   a. Build a property context (reuse main borrower's context with the property in focus)
   b. Evaluate perPropertyRules
   c. Same condition/excludeWhen/dedup logic
   d. Create PropertyChecklist:
      - propertyId, propertyDescription (build from address if available, else "Property")
      - items: non-internal items

6. Evaluate sharedRules against main borrower's context:
   a. Same condition/excludeWhen logic
   b. Deduplicate
   c. Separate internal flags
   d. Add non-internal to sharedItems

7. Build propertyDescription helper: use address data from response.addresses
   matched by property.addressId. Format: "{streetNumber} {streetName} {streetType}, {city}".
   If no address, use "Subject Property" or "Property {index}".

8. Compute ChecklistStats for the output.

9. Return GeneratedChecklist with all arrays + warnings.
```

Key implementation details:

- **CHKL-03 compliance**: All PRE and FULL stage items are in the output. No filtering by stage. Stage is metadata only.
- **CHKL-04 compliance**: per_borrower rules are evaluated per borrower. Each borrower gets their own BorrowerChecklist. The items are naturally duplicated per person.
- **CHKL-05 compliance**: `excludeWhen` prevents excluded items from appearing.
- **CHKL-06 compliance**: `internalOnly` items are routed to `internalFlags`, not to borrower/property/shared items.
- **Error resilience**: Wrap each rule evaluation in try/catch. Log warnings for rule errors instead of crashing.
- **No PII in warnings**: Warning messages reference rule IDs and field names, never borrower names or SIN numbers.

**`src/checklist/engine/index.ts`** — Barrel export:
Re-export `generateChecklist` from generate-checklist.ts. Also export `buildBorrowerContexts` for testing.
  </action>
  <verify>
Run `npx tsc --noEmit` — engine compiles with no errors.

Verify the function signature: `generateChecklist` accepts FinmoApplicationResponse and returns GeneratedChecklist.

Verify imports: engine imports from both types and rules.
  </verify>
  <done>
generateChecklist is a pure function: Finmo response in, structured checklist out. It iterates per-borrower for CHKL-04, includes all stages for CHKL-03, applies excludeWhen for CHKL-05, separates internalOnly for CHKL-06, deduplicates within borrowers for multi-income, and produces warnings for unknown data instead of crashing.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. `generateChecklist` is exported from `src/checklist/engine/index.ts`
3. Function accepts optional rules and currentDate parameters for testing
4. Per-borrower evaluation produces separate BorrowerChecklist per borrower
5. Deduplication happens within a borrower, not across borrowers
6. internalOnly items route to internalFlags array
7. No PII appears in warning messages
</verification>

<success_criteria>
- generateChecklist is a pure function with no side effects
- Co-borrower applications produce duplicate per-person checklists (CHKL-04)
- All PRE and FULL items in single output (CHKL-03)
- Excluded items never appear in output (CHKL-05)
- Internal-only items separated from client-facing items (CHKL-06)
- Multiple incomes per borrower are handled without duplication
- Unknown field values produce warnings, not crashes
</success_criteria>

<output>
After completion, create `.planning/phases/03-checklist-generation/03-03-SUMMARY.md`
</output>
