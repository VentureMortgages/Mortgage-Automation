---
phase: 03-checklist-generation
plan: 04
type: tdd
wave: 3
depends_on: ["03-02", "03-03"]
files_modified:
  - src/checklist/__tests__/fixtures/employed-purchase.json
  - src/checklist/__tests__/fixtures/self-employed-refi.json
  - src/checklist/__tests__/fixtures/retired-condo.json
  - src/checklist/__tests__/fixtures/co-borrower-mixed.json
  - src/checklist/__tests__/fixtures/gift-down-payment.json
  - src/checklist/__tests__/fixtures/minimal-application.json
  - src/checklist/__tests__/fixtures/index.ts
  - src/checklist/__tests__/generate-checklist.test.ts
  - src/checklist/__tests__/exclusions.test.ts
  - src/checklist/__tests__/co-borrower.test.ts
  - src/checklist/__tests__/down-payment.test.ts
  - src/checklist/__tests__/edge-cases.test.ts
autonomous: true

must_haves:
  truths:
    - "Employed borrower generates pay stubs, T4s, bank statements, and LOE (SC1)"
    - "Self-employed borrower generates NOAs, T1s, corporate docs, and bank statements (SC2)"
    - "Co-borrower application generates duplicate per-person items with names (SC3)"
    - "Excluded items (signed credit consent, T2125, bonus payment history, etc.) are NEVER in client-facing output (SC4)"
    - "Gift letter is in internalFlags but NOT in borrower/shared items (SC5)"
    - "All PRE and FULL items appear in single output (SC6)"
  artifacts:
    - path: "src/checklist/__tests__/fixtures/employed-purchase.json"
      provides: "Test fixture: single employed borrower purchasing property"
    - path: "src/checklist/__tests__/fixtures/co-borrower-mixed.json"
      provides: "Test fixture: two borrowers with different income types"
    - path: "src/checklist/__tests__/generate-checklist.test.ts"
      provides: "Core tests for all 6 success criteria"
      min_lines: 100
    - path: "src/checklist/__tests__/exclusions.test.ts"
      provides: "Negative tests for all 13 CHKL-05 excluded items"
      min_lines: 80
    - path: "src/checklist/__tests__/co-borrower.test.ts"
      provides: "CHKL-04 co-borrower duplication tests"
      min_lines: 50
  key_links:
    - from: "src/checklist/__tests__/generate-checklist.test.ts"
      to: "src/checklist/engine/index.ts"
      via: "Imports and calls generateChecklist"
      pattern: "import.*generateChecklist.*from.*engine"
    - from: "src/checklist/__tests__/fixtures/*.json"
      to: "src/checklist/types/finmo.ts"
      via: "Fixtures conform to FinmoApplicationResponse shape"
---

<objective>
Create comprehensive test fixtures and test suite validating all 6 success criteria and all CHKL requirements.

Purpose: The checklist engine is the most critical piece of the automation — if it generates wrong docs, Cat gets wrong emails. Tests are the safety net. Each of the 6 roadmap success criteria becomes a test. Each of the 13 excluded items gets a negative test. Co-borrower duplication and gift letter internal-only handling get dedicated test suites. This is a TDD plan: write tests first (RED), then fix any issues found (GREEN).

Output: ~25-35 test cases across 5 test files. All tests pass. The engine correctly implements CHKL-01 through CHKL-06.
</objective>

<execution_context>
@C:/Users/lucac/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/lucac/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-checklist-generation/03-RESEARCH.md
@.planning/phases/03-checklist-generation/03-01-SUMMARY.md
@.planning/phases/03-checklist-generation/03-02-SUMMARY.md
@.planning/phases/03-checklist-generation/03-03-SUMMARY.md
@DOC_CHECKLIST_RULES_V2.md
@.planning/finmo_app_sample.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create test fixtures for all major application profiles</name>
  <files>
    src/checklist/__tests__/fixtures/employed-purchase.json,
    src/checklist/__tests__/fixtures/self-employed-refi.json,
    src/checklist/__tests__/fixtures/retired-condo.json,
    src/checklist/__tests__/fixtures/co-borrower-mixed.json,
    src/checklist/__tests__/fixtures/gift-down-payment.json,
    src/checklist/__tests__/fixtures/minimal-application.json,
    src/checklist/__tests__/fixtures/index.ts
  </files>
  <action>
Create JSON test fixtures that represent different Finmo application profiles. Base the structure on the real sample at `.planning/finmo_app_sample.json` but simplify: only include fields needed for checklist generation (application, borrowers, incomes, properties, assets, liabilities). Other top-level keys can be empty arrays or null.

IMPORTANT: Use FAKE data only in fixtures. No real client names, emails, SINs, or addresses. Use obviously fake data (e.g., "John Test", "test@example.com", "000-000-000").

**Fixture 1: `employed-purchase.json`** (Success Criteria 1)
- Single borrower: "John Test", employed, salaried, full_time
- Application goal: "purchase", use: "owner_occupied"
- One income: source "employed", payType "salaried", bonuses false
- Assets: cash_savings for down payment
- Subject property: detached, freehold
- Expected output: base pack + Section 1 docs (pay stub, LOE, T4s, NOAs) + savings docs + purchase docs

**Fixture 2: `self-employed-refi.json`** (Success Criteria 2)
- Single borrower: "Jane SelfEmp", self-employed
- Application goal: "refinance"
- One income: source "self_employed", businessType: null (ambiguous — should trigger broader set)
- Assets: cash_savings
- Subject property: detached, freehold, mortgaged true with existing mortgage
- Expected output: base pack + Section 3 docs (T1s, NOAs) + sole prop OR incorporated docs (broader set) + refinance docs

**Fixture 3: `retired-condo.json`** (Retirement + Condo refinance)
- Single borrower: "Bob Retired", retired
- Application goal: "refinance"
- One income: source "retired"
- Subject property: condo (type "condo" or monthlyFees > 0), mortgaged true
- Expected output: base pack + Section 7 docs (pension letter, CPP T4As, bank statements, T5s) + refinance docs + condo fee confirmation (refinance only)
- Should NOT include: NOA (removed), RRIF/Annuity (removed)

**Fixture 4: `co-borrower-mixed.json`** (Success Criteria 3 + CHKL-04)
- Two borrowers: "Alice Main" (main, employed salaried) and "Bob Co" (not main, employed hourly with bonuses)
- Application goal: "purchase"
- Alice has 1 income: employed, salaried
- Bob has 1 income: employed, hourly, bonuses: true
- Assets: cash_savings (shared)
- Expected output: base pack for BOTH borrowers, Section 1 docs for BOTH, Bob gets bonus docs (Section 10), separate BorrowerChecklist entries with correct names

**Fixture 5: `gift-down-payment.json`** (Success Criteria 5 + CHKL-06)
- Single borrower: "Carol Gift"
- Application goal: "purchase", process: "found_property"
- Assets: one with type "other", description containing "Gift from parents"
- Expected output: gift donor info + amount in shared items (forEmail: true), gift proof of funds (CONDITIONAL, forEmail: true because process is found_property), gift letter in internalFlags (NOT in shared/borrower items)

**Fixture 6: `minimal-application.json`** (Edge case — minimal data)
- Single borrower with minimal fields
- No incomes, no assets, no liabilities
- Application goal: "purchase"
- Expected output: base pack only + purchase docs. No crashes. Warnings for missing income data.

**`src/checklist/__tests__/fixtures/index.ts`**:
Import all fixtures and export them as named constants with proper TypeScript typing:
```typescript
import employedPurchase from './employed-purchase.json' assert { type: 'json' };
// ... etc
export const fixtures = { employedPurchase, selfEmployedRefi, retiredCondo, coBorrowerMixed, giftDownPayment, minimalApplication };
```

Each fixture must be a valid FinmoApplicationResponse shape (type-check in the index.ts). If JSON import assertions are not supported, use a helper function that reads and parses the JSON.
  </action>
  <verify>Run `npx tsc --noEmit` — fixtures compile and are properly typed. Each fixture has all required top-level keys.</verify>
  <done>6 test fixtures covering: employed purchase, self-employed refinance, retired condo, co-borrower mixed income, gift down payment, and minimal/edge-case application. All use fake data. All conform to FinmoApplicationResponse type.</done>
</task>

<task type="auto">
  <name>Task 2: Write test suite for all success criteria and requirements</name>
  <files>
    src/checklist/__tests__/generate-checklist.test.ts,
    src/checklist/__tests__/exclusions.test.ts,
    src/checklist/__tests__/co-borrower.test.ts,
    src/checklist/__tests__/down-payment.test.ts,
    src/checklist/__tests__/edge-cases.test.ts
  </files>
  <action>
Write comprehensive tests using Vitest. Import `generateChecklist` from the engine and fixtures from the fixtures index. Use a fixed `currentDate` (e.g., `new Date('2026-02-15')`) for deterministic tax year calculation.

**`generate-checklist.test.ts`** — Core success criteria tests (~10 tests):

```
describe('Success Criteria', () => {
  describe('SC1: Employed borrower', () => {
    // Use employedPurchase fixture
    - test: result has BorrowerChecklist for "John Test"
    - test: borrower items include rule IDs: s1_paystub, s1_loe, s1_t4_previous, s1_t4_current
    - test: borrower items include rule IDs: s1_noa_previous, s1_noa_current
    - test: shared items include: s14_savings_bank (90-day bank statements)
    - test: base pack items present (s0_photo_id, s0_second_id, s0_void_cheque)
  })

  describe('SC2: Self-employed borrower', () => {
    // Use selfEmployedRefi fixture
    - test: borrower items include: s3_t1_current, s3_t1_previous, s3_noa_current, s3_noa_previous
    - test: borrower items include corporate docs (articles, financials) OR sole prop docs
    - test: shared items include: s14_savings_bank
  })

  describe('SC6: All PRE and FULL in single output', () => {
    // Use any fixture
    - test: result contains items with stage 'PRE'
    - test: result contains items with stage 'FULL'
    - test: both PRE and FULL items in same arrays (not separated)
  })
})

describe('CHKL-01: Generates personalized checklist from Finmo data', () => {
  - test: employed fixture produces employed-specific docs
  - test: self-employed fixture produces self-employed-specific docs
  - test: retired fixture produces retired-specific docs
  - test: employed fixture does NOT produce self-employed docs
})

describe('CHKL-02: Rules match DOC_CHECKLIST_RULES_V2', () => {
  - test: base pack has exactly 3 items (2 IDs + void cheque)
  - test: employed salary/hourly produces 6 items (paystub, LOE, 2 T4s, 2 NOAs)
  - test: retired produces pension letter, CPP T4As, bank statements, T5s (Cat's additions)
  - test: retired does NOT produce NOA or RRIF (Cat's removals)
})

describe('CHKL-03: PRE + FULL upfront', () => {
  - test: items array contains both stage:'PRE' and stage:'FULL' items
  - test: no filtering or separation by stage in the output
})
```

**`exclusions.test.ts`** — Negative tests for CHKL-05 (~13 tests):

```
describe('CHKL-05: Excluded items', () => {
  // For each test, use a fixture that WOULD trigger the rule if it existed

  test('Signed credit consent is NOT in output', () => {
    // Any fixture — credit consent should never appear
    // Assert: no item with ruleId containing 'credit_consent' and forEmail:true
  })

  test('Bonus payment history is NOT in output', () => {
    // Use co-borrower fixture (Bob has bonuses:true)
    // Assert: no item with ruleId 'bonus_payment_history'
    // Assert: bonus T4s ARE present (bonus_t4s rule exists)
  })

  test('T2125 is NOT requested separately', () => {
    // Use self-employed fixture
    // Assert: no item with ruleId 's4_t2125' where forEmail:true
    // Assert: s4_t2125_check IS in internalFlags
  })

  test('T776 is NOT requested separately', () => {
    // Create inline fixture with rental income
    // Assert: no T776 item in client-facing output
    // Assert: T776 internal check IS in internalFlags
  })

  test('Equifax/TransUnion reports NOT requested for bankruptcy', () => {
    // Bankruptcy rules are manual-flag, but if they were triggered:
    // Assert no credit report request rule
  })

  test('Evidence of strong credit history NOT in borrowed down payment', () => {
    // Assert no credit_history_evidence rule in output
  })

  test('Home inspection report NOT in purchase', () => {
    // Use employedPurchase fixture
    // Assert: no home_inspection item
  })

  test('Payout statement NOT in refinance', () => {
    // Use selfEmployedRefi fixture
    // Assert: no payout_statement item
  })

  test('International credit NOT in work permit section', () => {
    // Residency rules are manual, but verify rule set
  })

  test('Foreign bank letter NOT in non-resident section', () => {
    // Verify rule set
  })

  test('First-time buyer declaration NOT requested', () => {
    // Use fixture with firstTime:true borrower
    // Assert: no ftb_declaration item in client-facing output
  })

  test('Retired NOA is NOT requested', () => {
    // Use retiredCondo fixture
    // Assert: no NOA item in retired borrower's checklist
  })

  test('RRIF/Annuity NOT requested for retired', () => {
    // Use retiredCondo fixture
    // Assert: no rrif or annuity item
  })
})
```

**`co-borrower.test.ts`** — CHKL-04 tests (~5 tests):

```
describe('CHKL-04: Co-borrower duplication', () => {
  // Use coBorrowerMixed fixture

  test('generates separate BorrowerChecklist for each borrower', () => {
    // Assert: result.borrowerChecklists.length === 2
  })

  test('each borrower has correct name', () => {
    // Assert: one with "Alice Main", one with "Bob Co"
  })

  test('both borrowers get base pack items', () => {
    // Assert: both have s0_photo_id, s0_second_id
  })

  test('both borrowers get their own income docs', () => {
    // Assert: Alice has s1_paystub, s1_loe, etc.
    // Assert: Bob has s1_paystub, s1_loe, etc.
  })

  test('bonus-specific docs only appear for borrower with bonuses', () => {
    // Assert: Bob (bonuses:true) has s10_bonus_t4s, s10_bonus_letter
    // Assert: Alice (bonuses:false) does NOT have bonus items
  })
})
```

**`down-payment.test.ts`** — Section 14 + CHKL-06 tests (~8 tests):

```
describe('Down payment rules', () => {
  test('cash savings triggers 90-day bank statement', () => {})
  test('RRSP triggers RRSP statement', () => {})
  test('TFSA triggers TFSA statement', () => {})
  test('TFSA detected from description when type is cash_savings', () => {
    // Fixture: asset type "cash_savings", description "TFSA"
  })
})

describe('CHKL-06: Gift letter handling', () => {
  // Use giftDownPayment fixture

  test('gift donor info is in shared items (forEmail: true)', () => {
    // Assert: s14_gift_donor_info in sharedItems with forEmail:true
  })

  test('gift amount is in shared items (forEmail: true)', () => {
    // Assert: s14_gift_amount in sharedItems with forEmail:true
  })

  test('gift letter is in internalFlags, NOT in shared items', () => {
    // Assert: internalFlags contains entry with ruleId s14_gift_letter
    // Assert: sharedItems does NOT contain s14_gift_letter
    // Assert: no borrowerChecklist contains s14_gift_letter
  })

  test('gift proof of funds included when process is found_property', () => {
    // Assert: s14_gift_proof_of_funds in shared items
  })

  test('gift proof of funds NOT included when process is searching', () => {
    // Modify fixture or create inline: process: "searching"
    // Assert: s14_gift_proof_of_funds NOT in shared items
  })
})
```

**`edge-cases.test.ts`** — Robustness tests (~5 tests):

```
describe('Edge cases', () => {
  test('minimal application produces base pack without crashing', () => {
    // Use minimalApplication fixture
    // Assert: result is valid GeneratedChecklist
    // Assert: base pack items present
    // Assert: no income-specific items (no income data)
  })

  test('unknown income source produces warning', () => {
    // Create inline fixture with source: "unknown_type"
    // Assert: result.warnings includes message about unknown income source
  })

  test('borrower with multiple incomes deduplicates items', () => {
    // Create inline fixture: one borrower with 2 salaried jobs
    // Assert: only ONE s1_paystub item (not two)
  })

  test('empty borrowers array produces empty checklists', () => {
    // Edge case: no borrowers
    // Assert: borrowerChecklists is empty, shared items still generated
  })

  test('tax year calculation is dynamic', () => {
    // Run with currentDate in January vs June
    // Assert: T4 display names reference different years
  })
})
```

**TDD Flow:**
1. Write ALL tests first (they should fail because they test specific behaviors)
2. Run `npx vitest run` — expect some failures
3. Fix any engine/rule issues found by the tests
4. Run `npx vitest run` again — all should pass
5. If any test reveals a bug in the rules or engine, fix the source code in the appropriate file

Common fixes you may need to make:
- Rule condition functions that don't handle missing data (null checks)
- Engine not properly filtering borrower incomes
- Deduplication not working for multi-income borrowers
- Gift letter appearing in shared items instead of internalFlags
- Tax year helper returning wrong years for the test date
  </action>
  <verify>
Run `npx vitest run` — ALL tests pass.

Run `npx vitest run --reporter=verbose` to see individual test names.

Expected: ~25-35 tests, 0 failures.
  </verify>
  <done>
Comprehensive test suite validates all 6 success criteria:
- SC1: Employed borrower gets correct docs (PASS)
- SC2: Self-employed borrower gets correct docs (PASS)
- SC3: Co-borrower gets duplicate per-person items (PASS)
- SC4: All 13 excluded items are absent from output (PASS)
- SC5: Gift letter is internal-only (PASS)
- SC6: PRE + FULL in single output (PASS)

All CHKL requirements tested. Edge cases handled. 0 failures.
  </done>
</task>

</tasks>

<verification>
1. `npx vitest run` — all tests pass (0 failures)
2. Test count is ~25-35 cases
3. Every success criteria from ROADMAP Phase 3 has at least one dedicated test
4. Every CHKL-05 exclusion has a negative test
5. CHKL-06 gift letter has dedicated positive and negative tests
6. Co-borrower tests verify per-person duplication
7. Edge case tests verify graceful handling of missing/unexpected data
</verification>

<success_criteria>
- All tests pass with 0 failures
- Each of the 6 roadmap success criteria is covered by at least one test
- Each of the 13 excluded items (CHKL-05) has a negative test
- Gift letter is proven to be in internalFlags and NOT in client-facing output (CHKL-06)
- Co-borrower duplication is proven correct (CHKL-04)
- Engine handles edge cases without crashing
</success_criteria>

<output>
After completion, create `.planning/phases/03-checklist-generation/03-04-SUMMARY.md`
</output>
