---
phase: 08-tracking-integration
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - src/crm/tracking-sync.ts
  - src/crm/__tests__/tracking-sync.test.ts
  - src/classification/classification-worker.ts
  - src/classification/__tests__/classification-worker.test.ts
  - src/crm/index.ts
autonomous: true

must_haves:
  truths:
    - "When a document is classified and filed to Drive, the CRM contact's checklist status updates from missing to received (TRACK-01)"
    - "An audit note is created on the contact for every successfully tracked document (TRACK-02)"
    - "When all PRE documents are received, a task is created for Taylor (CRM-05 / budget call readiness)"
    - "When all documents are received, pipeline stage advances to All Docs Received"
    - "Cat can see per-client doc status in CRM custom fields without manual updates (TRACK-03)"
    - "Tracking failures are non-fatal — documents are still filed to Drive even if CRM update fails"
  artifacts:
    - path: "src/crm/tracking-sync.ts"
      provides: "updateDocTracking() orchestrator for document-received CRM updates"
      exports: ["updateDocTracking"]
    - path: "src/crm/__tests__/tracking-sync.test.ts"
      provides: "Tests for tracking orchestrator"
      contains: "updateDocTracking"
    - path: "src/crm/index.ts"
      provides: "Updated barrel with tracking-sync, notes, doc-type-matcher exports"
      contains: "updateDocTracking"
  key_links:
    - from: "src/classification/classification-worker.ts"
      to: "src/crm/tracking-sync.ts"
      via: "calls updateDocTracking after successful filing"
      pattern: "updateDocTracking"
    - from: "src/crm/tracking-sync.ts"
      to: "src/crm/contacts.ts"
      via: "getContact + findContactByEmail for read-modify-write"
      pattern: "getContact.*findContactByEmail"
    - from: "src/crm/tracking-sync.ts"
      to: "src/crm/notes.ts"
      via: "createAuditNote for audit trail"
      pattern: "createAuditNote"
    - from: "src/crm/tracking-sync.ts"
      to: "src/crm/tasks.ts"
      via: "createPreReadinessTask on PRE Complete"
      pattern: "createPreReadinessTask"
    - from: "src/crm/tracking-sync.ts"
      to: "src/crm/opportunities.ts"
      via: "moveToAllDocsReceived on All Complete"
      pattern: "moveToAllDocsReceived"
---

<objective>
Build the tracking sync orchestrator that updates CRM status when documents are received, wire it into the classification worker, and update the barrel export — completing Phase 8's core loop from document filing to CRM status visibility.

Purpose: This is the Phase 8 capstone. When the classification worker files a document to Drive, `updateDocTracking()` updates the contact's custom fields (moves doc from missingDocs to receivedDocs, increments counters, recomputes status), creates an audit note, and triggers milestone actions (PRE readiness task, pipeline stage advance). Cat can then see real-time status in MyBrokerPro without manual updates.

Output: tracking-sync.ts orchestrator, updated classification worker, barrel export, and comprehensive tests.
</objective>

<execution_context>
@C:/Users/lucac/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/lucac/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-tracking-integration/08-RESEARCH.md
@.planning/phases/08-tracking-integration/08-01-SUMMARY.md
@src/crm/contacts.ts
@src/crm/notes.ts
@src/crm/doc-type-matcher.ts
@src/crm/checklist-mapper.ts
@src/crm/types/index.ts
@src/crm/tasks.ts
@src/crm/opportunities.ts
@src/crm/config.ts
@src/crm/index.ts
@src/classification/classification-worker.ts
@src/classification/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create tracking-sync orchestrator with tests</name>
  <files>
    src/crm/tracking-sync.ts
    src/crm/__tests__/tracking-sync.test.ts
  </files>
  <action>
**Create `src/crm/tracking-sync.ts`:**

This is the Phase 8 orchestrator — the single function that takes a document receipt event and performs all CRM updates. Pattern follows `syncChecklistToCrm` (critical/non-critical split).

Import from plan 01 modules:
- `findContactByEmail`, `getContact` from `./contacts.js`
- `upsertContact` from `./contacts.js` (for field update via upsert)
- `createAuditNote` from `./notes.js`
- `findMatchingChecklistDoc` from `./doc-type-matcher.js`
- `computeDocStatus` from `./checklist-mapper.js`
- `createPreReadinessTask` from `./tasks.js`
- `moveToAllDocsReceived` from `./opportunities.js`
- `crmConfig` from `./config.js`
- `MissingDocEntry`, `CrmContact` from `./types/index.js`
- `DocumentType` from `../classification/types.js`

**Types:**
```typescript
export interface TrackingUpdateInput {
  senderEmail: string;
  documentType: DocumentType;
  driveFileId: string;
  source: 'gmail' | 'finmo';
  receivedAt: string;
}

export interface TrackingUpdateResult {
  updated: boolean;
  reason?: 'no-contact' | 'no-match-in-checklist' | 'already-received';
  contactId?: string;
  newStatus?: string;
  noteId?: string;
  errors: string[];
}
```

**Main function `updateDocTracking()`:**

1. **Find contact by email** — call `findContactByEmail(input.senderEmail)`. If null, return `{ updated: false, reason: 'no-contact', errors: [] }`.

2. **Get contact record** — call `getContact(contactId)` to read current custom field values.

3. **Parse current field values** — extract from `contact.customFields`:
   - `missingDocs`: parse JSON string from field matching `crmConfig.fieldIds.missingDocs` into `MissingDocEntry[]`. Default to `[]` if missing/unparseable.
   - `receivedDocs`: parse JSON string from field matching `crmConfig.fieldIds.receivedDocs` into `string[]`. Default to `[]`.
   - `preDocsTotal`, `preDocsReceived`, `fullDocsTotal`, `fullDocsReceived`: parse numeric fields. Default to 0.

   Create a helper `parseContactTrackingFields(contact: CrmContact, fieldIds: CrmConfig['fieldIds'])` that does this extraction. Make it a pure exported function for testability.

4. **Find matching checklist doc** — call `findMatchingChecklistDoc(input.documentType, missingDocs)`. If null, return `{ updated: false, reason: 'no-match-in-checklist', errors: [] }` (document type not in this client's checklist — might be a different client's doc or a doc type we don't track).

5. **Check if already received** — if the matched doc name is already in `receivedDocs`, return `{ updated: false, reason: 'already-received', errors: [] }`. This prevents duplicate tracking on re-uploads (FILE-04 versioning).

6. **Compute new field values:**
   - Remove matched doc from `missingDocs` array
   - Add matched doc name (string, not MissingDocEntry) to `receivedDocs` array
   - Increment the correct counter based on `matchedDoc.stage`:
     - If stage is `'PRE'`: `preDocsReceived + 1`
     - If stage is `'FULL'`: `fullDocsReceived + 1`
     - If stage is `'LATER'` or `'CONDITIONAL'`: don't increment either counter
   - Compute new status using `computeDocStatus(preDocsTotal, newPreReceived, fullDocsTotal, newFullReceived)`
   - Set `lastDocReceived` to today's date (ISO format, date only)

7. **Write updated fields to contact** — use `upsertContact()` with the borrower's email and updated custom fields:
   ```typescript
   await upsertContact({
     email: contact.email,
     firstName: contact.firstName,
     lastName: contact.lastName,
     customFields: [
       { id: fieldIds.missingDocs, field_value: JSON.stringify(updatedMissing) },
       { id: fieldIds.receivedDocs, field_value: JSON.stringify(updatedReceived) },
       { id: fieldIds.preDocsReceived, field_value: newPreReceived },
       { id: fieldIds.fullDocsReceived, field_value: newFullReceived },
       { id: fieldIds.docStatus, field_value: newStatus },
       { id: fieldIds.lastDocReceived, field_value: new Date().toISOString().split('T')[0] },
     ],
   });
   ```

8. **Create audit note** (non-critical — wrap in try/catch):
   ```typescript
   let noteId: string | undefined;
   try {
     noteId = await createAuditNote(contactId, {
       documentType: matchedDoc.name,
       source: input.source,
       driveFileId: input.driveFileId,
     });
   } catch (err) {
     errors.push(`Audit note failed: ${err instanceof Error ? err.message : String(err)}`);
   }
   ```

9. **Trigger milestone actions** (non-critical — wrap each in try/catch):
   - If `newStatus === 'PRE Complete'`: call `createPreReadinessTask(contactId, `${contact.firstName} ${contact.lastName}`)`. Log and add to errors if fails.
   - If `newStatus === 'All Complete'`: call `moveToAllDocsReceived(contactId, `${contact.firstName} ${contact.lastName}`)`. Log and add to errors if fails.

10. **Return result:**
    ```typescript
    return {
      updated: true,
      contactId,
      newStatus,
      noteId,
      errors,
    };
    ```

**Create `src/crm/__tests__/tracking-sync.test.ts`:**

Mock all dependencies (vi.mock for contacts, notes, doc-type-matcher, checklist-mapper, tasks, opportunities).

Test cases (aim for 15-18 tests):

**Happy path tests:**
- PRE document received: missingDocs shrinks by 1, receivedDocs grows by 1, preDocsReceived increments, status recomputed
- FULL document received: fullDocsReceived increments
- Last PRE doc received: status becomes "PRE Complete", createPreReadinessTask called
- Last doc overall received: status becomes "All Complete", moveToAllDocsReceived called
- Audit note created with correct document name and source

**Edge case tests:**
- No contact found: returns `{ updated: false, reason: 'no-contact' }`
- Doc type not in checklist: returns `{ updated: false, reason: 'no-match-in-checklist' }`
- Doc already received: returns `{ updated: false, reason: 'already-received' }`
- LATER/CONDITIONAL stage doc: neither PRE nor FULL counter incremented

**Error handling tests:**
- Audit note creation fails: result still has `updated: true`, error in `errors` array
- PRE readiness task creation fails: result still has `updated: true`, error in `errors` array
- moveToAllDocsReceived fails: result still has `updated: true`, error in `errors` array

**parseContactTrackingFields tests:**
- Parses valid JSON from customFields
- Handles missing fields (defaults to empty/zero)
- Handles malformed JSON gracefully (defaults)
  </action>
  <verify>
    Run `npx vitest run` — all tests pass including 15+ new tracking-sync tests.
    Run `npx tsc --noEmit` — zero errors.
  </verify>
  <done>
    - `updateDocTracking()` reads contact, matches doc type, updates fields, writes audit note, triggers milestones
    - Non-fatal error handling: audit note, PRE task, and pipeline failures don't block tracking update
    - "no-contact", "no-match-in-checklist", and "already-received" edge cases handled gracefully
    - At least 15 tests covering happy path, edge cases, and error scenarios
    - `parseContactTrackingFields` tested independently with malformed data
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire tracking into classification worker and update barrel export</name>
  <files>
    src/classification/classification-worker.ts
    src/classification/__tests__/classification-worker.test.ts
    src/crm/index.ts
  </files>
  <action>
**1. Update `src/classification/classification-worker.ts`:**

Add import at the top:
```typescript
import { updateDocTracking } from '../crm/tracking-sync.js';
```

In `processClassificationJob()`, AFTER the successful filing block (after step i where driveFileId is set, before step j cleanup), add the tracking call:

```typescript
    // j. Update CRM tracking (Phase 8 — non-fatal)
    if (senderEmail) {
      try {
        const trackingResult = await updateDocTracking({
          senderEmail,
          documentType: classification.documentType,
          driveFileId,
          source,
          receivedAt: job.data.receivedAt,
        });

        if (trackingResult.updated) {
          console.log('[classification] CRM tracking updated:', {
            contactId: trackingResult.contactId,
            newStatus: trackingResult.newStatus,
          });
        } else {
          console.log('[classification] CRM tracking skipped:', {
            reason: trackingResult.reason,
          });
        }

        if (trackingResult.errors.length > 0) {
          console.warn('[classification] Tracking partial errors:', {
            errors: trackingResult.errors,
          });
        }
      } catch (trackingErr) {
        // Tracking failure is NON-FATAL — doc is already filed to Drive
        console.error('[classification] Tracking update failed:', {
          error: trackingErr instanceof Error ? trackingErr.message : String(trackingErr),
          intakeDocumentId,
        });
      }
    }
```

Move the temp file cleanup (unlink) AFTER the tracking call (it was step j, now becomes step k). The return statement becomes step l.

IMPORTANT: The tracking call must be INSIDE the try block but wrapped in its OWN try/catch so a tracking failure does not trigger the top-level catch and report the job as failed.

**2. Update `src/classification/__tests__/classification-worker.test.ts`:**

Add mock for `../crm/tracking-sync.js`:
```typescript
vi.mock('../crm/tracking-sync.js', () => ({
  updateDocTracking: vi.fn().mockResolvedValue({
    updated: true,
    contactId: 'mock-contact-id',
    newStatus: 'In Progress',
    noteId: 'mock-note-id',
    errors: [],
  }),
}));
```

Add test cases:
- Successful filing calls `updateDocTracking` with correct parameters (senderEmail, documentType, driveFileId, source, receivedAt)
- `updateDocTracking` not called when `senderEmail` is null
- `updateDocTracking` not called when filing fails (low confidence manual review path)
- `updateDocTracking` failure does not affect the job result (still returns `filed: true`)

Update existing test expectations if needed — the worker flow now has an additional step between filing and cleanup/return.

**3. Update `src/crm/index.ts` barrel export:**

Add exports for all new modules:
```typescript
// Contact notes (audit trail)
export { createAuditNote } from './notes.js';

// Document type matching
export { findMatchingChecklistDoc } from './doc-type-matcher.js';

// Tracking sync orchestrator (Phase 8)
export { updateDocTracking } from './tracking-sync.js';
export type { TrackingUpdateInput, TrackingUpdateResult } from './tracking-sync.js';

// Updated type exports
export type { CrmContact, MissingDocEntry, CrmNoteInput } from './types/index.js';

// New checklist mapper export
export { mapChecklistToDocEntries } from './checklist-mapper.js';
```

Also add `getContact` to the existing contacts export line:
```typescript
export { upsertContact, findContactByEmail, getContact } from './contacts.js';
```
  </action>
  <verify>
    Run `npx vitest run` — all tests pass (existing + new classification worker tests + tracking-sync tests).
    Run `npx tsc --noEmit` — zero errors.
    Verify `updateDocTracking` is called in the classification worker by checking test output.
  </verify>
  <done>
    - Classification worker calls `updateDocTracking()` after successful Drive filing
    - Tracking call is non-fatal (wrapped in try/catch, does not affect job result)
    - Tracking skipped when senderEmail is null
    - Tracking not called on manual review or error paths
    - CRM barrel export updated with all Phase 8 modules (notes, doc-type-matcher, tracking-sync, new types)
    - All tests pass (no regressions in existing classification worker tests)
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` — zero errors
2. `npx vitest run` — all tests pass (354+ existing + 30-40 new)
3. End-to-end flow: classification worker -> file to Drive -> updateDocTracking -> CRM field update + audit note
4. Non-fatal tracking: classification worker still returns `filed: true` even if tracking fails
5. Milestone triggers: PRE Complete -> Taylor task, All Complete -> pipeline advance
6. Barrel export includes all Phase 8 modules
</verification>

<success_criteria>
- TRACK-01: CRM checklist status updates from missing to received when document is classified and filed
- TRACK-02: Audit trail note created on contact for every successfully tracked document
- TRACK-03: Cat can see per-client status in CRM (missingDocs, receivedDocs, counters, status picklist all updated automatically)
- CRM-05: PRE readiness task created for Taylor when all PRE docs received
- Tracking failures never cause document filing to fail (non-fatal pattern)
- All tests pass with no regressions
</success_criteria>

<output>
After completion, create `.planning/phases/08-tracking-integration/08-02-SUMMARY.md`
</output>
