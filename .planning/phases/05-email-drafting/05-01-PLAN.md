---
phase: 05-email-drafting
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/email/types.ts
  - src/email/config.ts
  - src/email/body.ts
  - src/email/mime.ts
  - src/email/__tests__/body.test.ts
  - src/email/__tests__/mime.test.ts
autonomous: true

must_haves:
  truths:
    - "generateEmailBody produces email text matching Cat's tone and structure from EMAIL_TEMPLATE_REFERENCE.md"
    - "Per-borrower sections use first names as headers with their doc items listed below"
    - "Per-property sections use property descriptions as headers"
    - "Shared items appear under 'Other' section"
    - "Only forEmail=true items appear in email body"
    - "encodeMimeMessage produces valid base64url-encoded RFC 2822 MIME content with CRLF line endings"
    - "Dev mode overrides recipient to dev@venturemortgages.com and prefixes subject with [TEST]"
  artifacts:
    - path: "src/email/types.ts"
      provides: "EmailConfig, EmailContext, MimeMessageInput, EmailDraft, CreateEmailDraftInput, CreateEmailDraftResult, SendResult types"
    - path: "src/email/config.ts"
      provides: "emailConfig object with dev mode safety (recipientOverride, subjectPrefix, senderAddress)"
    - path: "src/email/body.ts"
      provides: "generateEmailBody pure function: GeneratedChecklist + EmailContext -> string"
      exports: ["generateEmailBody"]
    - path: "src/email/mime.ts"
      provides: "encodeMimeMessage function: MimeMessageInput -> base64url string"
      exports: ["encodeMimeMessage"]
    - path: "src/email/__tests__/body.test.ts"
      provides: "Tests for email body generation covering all 6 sections of Cat's template"
    - path: "src/email/__tests__/mime.test.ts"
      provides: "Tests for MIME encoding: CRLF line endings, base64url format, header correctness"
  key_links:
    - from: "src/email/body.ts"
      to: "src/checklist/types/checklist.ts"
      via: "imports GeneratedChecklist, BorrowerChecklist, PropertyChecklist, ChecklistItem"
      pattern: "import type.*GeneratedChecklist.*from.*checklist/types"
    - from: "src/email/config.ts"
      to: "src/crm/config.ts"
      via: "reads APP_ENV from process.env (same pattern as crmConfig)"
      pattern: "optionalEnv.*APP_ENV"
---

<objective>
Create the pure-function email body generator and MIME encoder for transforming Phase 3 GeneratedChecklist output into a formatted, personalized doc request email matching Cat's exact tone and structure.

Purpose: These are the core value-add functions of Phase 5. The email body generator is a pure function with defined I/O — perfect TDD candidate. MIME encoding is deterministic and testable. Together they produce the raw email content that Gmail API will use in Plan 02.

Output: Tested email body generator + MIME encoder with full type definitions and config.
</objective>

<execution_context>
@C:/Users/lucac/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/lucac/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/EMAIL_TEMPLATE_REFERENCE.md
@.planning/phases/05-email-drafting/05-RESEARCH.md
@src/checklist/types/checklist.ts
@src/crm/config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create email types, config, body generator, and MIME encoder with TDD</name>
  <files>
    src/email/types.ts
    src/email/config.ts
    src/email/body.ts
    src/email/mime.ts
    src/email/__tests__/body.test.ts
    src/email/__tests__/mime.test.ts
  </files>
  <action>
**RED phase — Write failing tests first:**

Create `src/email/__tests__/body.test.ts`:
- Import `generateEmailBody` from `../body.js` (function doesn't exist yet — this is TDD)
- Import `GeneratedChecklist` type from `../../checklist/types/index.js`
- Build a test fixture `GeneratedChecklist` inline (use spread pattern from Phase 3 tests):
  - 2 borrowers: "Megan Smith" (main) and "Cory Johnson" (co-borrower)
  - Each with 2-3 items (mix of forEmail=true and forEmail=false)
  - 2 properties: "Smoke Bluff Rd, Squamish" and "Keefer Place, Vancouver" each with 1-2 items
  - 2 shared items (forEmail=true)
  - 1 internal flag (should NOT appear in email)
- Test cases:
  1. "starts with greeting using both first names" — expect `Hey Megan and Cory!`
  2. "includes intro paragraph" — expect contains "Thanks for filling out the application"
  3. "has per-borrower section with first name header" — expect contains `Megan\n` followed by doc items, `Cory\n` followed by doc items
  4. "excludes forEmail=false items" — expect NOT to contain any internalOnly item displayNames
  5. "has per-property sections with address headers" — expect contains "Smoke Bluff Rd" and "Keefer Place" as section headers
  6. "has shared Other section" — expect contains `Other\n` followed by shared item displayNames
  7. "includes notes inline under items" — expect item with notes shows notes indented below displayName
  8. "ends with closing referencing doc inbox email" — expect contains "send these documents directly to"
  9. "single borrower uses just first name in greeting" — build single-borrower variant, expect `Hey Megan!` (no "and")
  10. "omits Other section when no shared items have forEmail=true" — build variant with no shared items, expect NOT to contain "Other"
  11. "omits property sections when no property checklists" — build variant with empty propertyChecklists array, expect no property headers

Create `src/email/__tests__/mime.test.ts`:
- Import `encodeMimeMessage` from `../mime.js`
- Test cases:
  1. "produces base64url-safe output (no +, /, or = padding)" — encode a message, verify regex `/^[A-Za-z0-9_-]+$/`
  2. "decoded output contains CRLF line endings in headers" — decode the base64url back, verify `\r\n` between headers
  3. "decoded output contains From header" — decode, verify `From: sender@test.com`
  4. "decoded output contains To header" — decode, verify `To: recipient@test.com`
  5. "decoded output contains Subject header" — decode, verify `Subject: Test Subject`
  6. "decoded output contains MIME-Version header" — decode, verify `MIME-Version: 1.0`
  7. "decoded output contains Content-Type header" — decode, verify `Content-Type: text/plain; charset=utf-8`
  8. "decoded output contains body after blank line" — decode, verify body text appears after `\r\n\r\n`
  9. "handles special characters in body" — include accented chars, emoji, verify they survive round-trip
  10. "handles multi-line body" — include `\n` in body, verify it appears in decoded output

Run tests: `npx vitest run src/email/__tests__/` — ALL should FAIL (RED).

**GREEN phase — Implement to make tests pass:**

Create `src/email/types.ts`:
```typescript
import type { GeneratedChecklist } from '../checklist/types/index.js';

/** Context needed to generate the email body */
export interface EmailContext {
  /** Borrower first names for greeting, e.g., ["Megan", "Cory"] */
  borrowerFirstNames: string[];
  /** The email address clients should send docs to */
  docInboxEmail: string;
}

/** Input for MIME message construction */
export interface MimeMessageInput {
  to: string;
  from: string;
  subject: string;
  body: string;
}

/** Email configuration (dev safety + sender info) */
export interface EmailConfig {
  isDev: boolean;
  senderAddress: string;
  recipientOverride: string | null;
  subjectPrefix: string;
  docInbox: string;
}

/** Result of creating a Gmail draft */
export interface CreateEmailDraftInput {
  checklist: GeneratedChecklist;
  recipientEmail: string;
  borrowerFirstNames: string[];
  contactId: string;
}

export interface CreateEmailDraftResult {
  draftId: string;
  subject: string;
  recipientEmail: string;
  bodyPreview: string;
}

/** Result of sending a draft */
export interface SendResult {
  messageId: string;
  threadId?: string;
}
```

Create `src/email/config.ts`:
```typescript
import 'dotenv/config';

import type { EmailConfig } from './types.js';

const isDev = (process.env.APP_ENV ?? 'development') === 'development';

export const emailConfig: EmailConfig = {
  isDev,
  senderAddress: 'admin@venturemortgages.com',
  recipientOverride: isDev ? 'dev@venturemortgages.com' : null,
  subjectPrefix: isDev ? '[TEST] ' : '',
  docInbox: process.env.DOC_INBOX ?? 'dev@venturemortgages.com',
};
```

Create `src/email/body.ts`:
- `generateEmailBody(checklist: GeneratedChecklist, context: EmailContext): string`
- Follow Cat's exact email structure from EMAIL_TEMPLATE_REFERENCE.md:
  1. Greeting: `Hey ${names.join(' and ')}!` (single name = `Hey Megan!`, two+ = `Hey Megan and Cory!`)
  2. Intro paragraph (the standard one from the template — hardcode for now but make it a const at top of file so it's easy to change)
  3. Per-borrower: iterate `checklist.borrowerChecklists`, use `bc.borrowerName.split(' ')[0]` for first name as header, list `bc.items.filter(i => i.forEmail)` — each item: `item.displayName` on its own line, if `item.notes` then `  ${item.notes}` indented on next line
  4. Per-property: iterate `checklist.propertyChecklists`, use `pc.propertyDescription + ':'` as header, same item listing pattern
  5. "Other" section: if `checklist.sharedItems.filter(i => i.forEmail).length > 0`, add `Other` header and list items
  6. Closing: `You can send these documents directly to ${context.docInboxEmail} and if you have any questions let me know!` then blank line then `Thanks!`
- Use `\n` for line breaks in the body (NOT `\r\n` — MIME encoder handles CRLF conversion)
- Blank line between sections

Create `src/email/mime.ts`:
- `encodeMimeMessage(input: MimeMessageInput): string`
- Build MIME headers joined with `\r\n`:
  ```
  From: {input.from}
  To: {input.to}
  Subject: {input.subject}
  MIME-Version: 1.0
  Content-Type: text/plain; charset=utf-8
  Content-Transfer-Encoding: 7bit
  ```
- Then `\r\n\r\n` (blank line separating headers from body)
- Then `input.body` (convert any `\n` in body to `\r\n` for RFC 2822 compliance)
- Base64url encode the entire string: `Buffer.from(mimeMessage).toString('base64').replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '')`

Run tests: `npx vitest run src/email/__tests__/` — ALL should PASS (GREEN).

**REFACTOR phase:**
- Ensure consistent `\n` blank lines between sections (no double blanks, no missing blanks)
- Extract the intro paragraph and closing paragraph as named constants at module scope for easy editing
- Add JSDoc comments on all public functions
- Run `npx tsc --noEmit` to verify type correctness
- Run tests again to confirm still green
  </action>
  <verify>
1. `npx vitest run src/email/__tests__/body.test.ts` — all tests pass
2. `npx vitest run src/email/__tests__/mime.test.ts` — all tests pass
3. `npx tsc --noEmit` — zero errors
4. Visual inspection: `generateEmailBody` output for the 2-borrower fixture matches the structure in EMAIL_TEMPLATE_REFERENCE.md
  </verify>
  <done>
- generateEmailBody produces email text with greeting, intro, per-borrower sections, per-property sections, shared "Other" section, and closing — matching Cat's template structure
- forEmail=false items do not appear in email body
- Single borrower greeting says "Hey Name!" not "Hey Name and !"
- Empty property/shared sections are omitted entirely
- encodeMimeMessage produces valid base64url with CRLF headers and proper MIME structure
- All tests pass, TypeScript compiles cleanly
  </done>
</task>

</tasks>

<verification>
1. `npx vitest run src/email/` — all email tests pass
2. `npx tsc --noEmit` — zero type errors
3. `npx vitest run` — all 93+ tests pass (no regressions)
</verification>

<success_criteria>
- Pure email body generator matches Cat's EMAIL_TEMPLATE_REFERENCE.md structure
- MIME encoder produces valid base64url RFC 2822 content
- All tests written TDD-style (RED -> GREEN -> REFACTOR)
- No new npm dependencies required (pure Node.js Buffer for base64)
- Types exported for Plan 02 consumption
</success_criteria>

<output>
After completion, create `.planning/phases/05-email-drafting/05-01-SUMMARY.md`
</output>
