---
phase: 05-email-drafting
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - package.json
  - src/email/gmail-client.ts
  - src/email/draft.ts
  - src/email/send.ts
  - src/email/index.ts
  - src/email/__tests__/draft.test.ts
  - .env.example
autonomous: true
user_setup:
  - service: google-cloud
    why: "Gmail API access via service account with domain-wide delegation for sending email as admin@venturemortgages.com"
    env_vars:
      - name: GOOGLE_SERVICE_ACCOUNT_KEY
        source: "Google Cloud Console -> IAM & Admin -> Service Accounts -> Keys -> Create key (JSON) -> base64 encode the file"
    dashboard_config:
      - task: "Create GCP project (if not existing) and enable Gmail API"
        location: "Google Cloud Console -> APIs & Services -> Enable APIs -> Gmail API"
      - task: "Create service account with domain-wide delegation enabled"
        location: "Google Cloud Console -> IAM & Admin -> Service Accounts -> Create -> Check 'Enable G Suite domain-wide delegation'"
      - task: "Authorize service account for Gmail compose scope"
        location: "Google Workspace Admin Console (admin.google.com) -> Security -> API controls -> Domain-wide Delegation -> Add: Client ID + scope https://www.googleapis.com/auth/gmail.compose"

must_haves:
  truths:
    - "Gmail client authenticates using service account with domain-wide delegation to impersonate admin@venturemortgages.com"
    - "createEmailDraft creates a visible draft in admin@venturemortgages.com's Gmail drafts folder"
    - "sendDraft sends a previously created draft by its ID"
    - "Dev mode overrides recipient email to dev@venturemortgages.com"
    - "Auth errors are caught and reported with specific error type for downstream alerting (INFRA-05)"
    - "Email barrel export provides clean import surface for Phase 1 webhook handler"
  artifacts:
    - path: "src/email/gmail-client.ts"
      provides: "Authenticated Gmail API client via service account + domain-wide delegation"
      exports: ["getGmailClient", "createGmailDraft", "sendGmailDraft"]
    - path: "src/email/draft.ts"
      provides: "createEmailDraft orchestrator: checklist -> email body -> MIME -> Gmail draft"
      exports: ["createEmailDraft"]
    - path: "src/email/send.ts"
      provides: "sendEmailDraft function: draft ID -> sent message ID"
      exports: ["sendEmailDraft"]
    - path: "src/email/index.ts"
      provides: "Email module barrel export"
    - path: "src/email/__tests__/draft.test.ts"
      provides: "Tests for draft orchestrator with mocked Gmail client"
  key_links:
    - from: "src/email/draft.ts"
      to: "src/email/body.ts"
      via: "imports generateEmailBody"
      pattern: "import.*generateEmailBody.*from.*body"
    - from: "src/email/draft.ts"
      to: "src/email/mime.ts"
      via: "imports encodeMimeMessage"
      pattern: "import.*encodeMimeMessage.*from.*mime"
    - from: "src/email/draft.ts"
      to: "src/email/gmail-client.ts"
      via: "imports createGmailDraft"
      pattern: "import.*createGmailDraft.*from.*gmail-client"
    - from: "src/email/gmail-client.ts"
      to: "googleapis"
      via: "JWT auth + gmail.users.drafts API"
      pattern: "import.*google.*from.*googleapis"
---

<objective>
Build the Gmail API integration layer: authenticated client via service account, draft creation orchestrator, send function, and barrel export. This connects the pure email body/MIME functions from Plan 01 to the Gmail API to create actual email drafts in admin@venturemortgages.com's mailbox.

Purpose: This is the glue that makes the automation real — the draft orchestrator is the main entry point that the Phase 1 webhook handler will call after CRM sync. Cat can then review the draft in Gmail before approving it.

Output: Working Gmail client, draft orchestrator, send function, barrel export, and tests with mocked Gmail API.
</objective>

<execution_context>
@C:/Users/lucac/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/lucac/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-email-drafting/05-RESEARCH.md
@.planning/phases/05-email-drafting/05-01-SUMMARY.md
@src/email/types.ts
@src/email/config.ts
@src/email/body.ts
@src/email/mime.ts
@src/crm/config.ts
@src/crm/checklist-sync.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install googleapis, create Gmail client and draft/send modules</name>
  <files>
    package.json
    src/email/gmail-client.ts
    src/email/draft.ts
    src/email/send.ts
    .env.example
  </files>
  <action>
**Install dependencies:**
```bash
npm install googleapis google-auth-library
```

**Create `src/email/gmail-client.ts`:**

Gmail API client using service account with domain-wide delegation.

```typescript
import { google } from 'googleapis';
import { JWT } from 'google-auth-library';
import { emailConfig } from './config.js';
```

- `loadServiceAccountKey(): { client_email: string; private_key: string }` — reads `GOOGLE_SERVICE_ACCOUNT_KEY` env var (base64-encoded JSON), decodes, parses. Throws descriptive error if missing or malformed.
- Lazy singleton pattern for Gmail client (same as GHL SDK in crm/client.ts):
  ```
  let gmailClient: ReturnType<typeof google.gmail> | null = null;
  ```
- `getGmailClient()` — creates JWT auth with:
  - `email`: from service account key `client_email`
  - `key`: from service account key `private_key`
  - `scopes`: `['https://www.googleapis.com/auth/gmail.compose']` (minimum privilege per research)
  - `subject`: `emailConfig.senderAddress` (impersonates admin@venturemortgages.com)
  - Returns `google.gmail({ version: 'v1', auth })`
- `createGmailDraft(rawMessage: string): Promise<string>` — calls `gmail.users.drafts.create({ userId: 'me', requestBody: { message: { raw: rawMessage } } })`. Returns `response.data.id`. Throws if no ID returned. Wrap in try/catch for auth errors — if auth error detected (401, 403, "Delegation denied"), throw a specific `GmailAuthError` (defined in this file as a simple class extending Error with a `code` property) so downstream can alert per INFRA-05.
- `sendGmailDraft(draftId: string): Promise<{ messageId: string; threadId?: string }>` — calls `gmail.users.drafts.send({ userId: 'me', requestBody: { id: draftId } })`. Returns `{ messageId: response.data.id, threadId: response.data.threadId }`. Same auth error handling.
- Export `GmailAuthError` class for downstream error detection.

**Create `src/email/draft.ts`:**

Draft creation orchestrator — the main entry point for email automation.

```typescript
import type { CreateEmailDraftInput, CreateEmailDraftResult } from './types.js';
import { emailConfig } from './config.js';
import { generateEmailBody } from './body.js';
import { encodeMimeMessage } from './mime.js';
import { createGmailDraft } from './gmail-client.js';
```

- `createEmailDraft(input: CreateEmailDraftInput): Promise<CreateEmailDraftResult>`:
  1. Generate email body: `generateEmailBody(input.checklist, { borrowerFirstNames: input.borrowerFirstNames, docInboxEmail: emailConfig.docInbox })`
  2. Determine recipient: `emailConfig.recipientOverride ?? input.recipientEmail`
  3. Build subject: `${emailConfig.subjectPrefix}Documents Needed — ${input.borrowerFirstNames.join(' & ')}`
  4. Encode MIME: `encodeMimeMessage({ to: recipient, from: emailConfig.senderAddress, subject, body })`
  5. Create Gmail draft: `const draftId = await createGmailDraft(raw)`
  6. Return `{ draftId, subject, recipientEmail: recipient, bodyPreview: body.substring(0, 200) }`
  7. Log only metadata: `console.log('[email] Draft created', { draftId, subject, recipientDomain: recipient.split('@')[1], itemCount: input.checklist.stats.totalItems })` — NO PII in logs per CLAUDE.md

**Create `src/email/send.ts`:**

Send a previously created draft (called after Cat approves).

```typescript
import type { SendResult } from './types.js';
import { sendGmailDraft } from './gmail-client.js';
```

- `sendEmailDraft(draftId: string): Promise<SendResult>`:
  1. Call `sendGmailDraft(draftId)`
  2. Log metadata: `console.log('[email] Draft sent', { draftId, messageId })`
  3. Return `{ messageId, threadId }`

**Update `.env.example`:**
Add at the bottom, below the existing DOC_INBOX section:
```
# Google Service Account (base64-encoded JSON key file)
# Generate: base64 -w0 service-account-key.json (Linux) or [Convert]::ToBase64String([IO.File]::ReadAllBytes("service-account-key.json")) (PowerShell)
# Required for Gmail API draft creation and sending
GOOGLE_SERVICE_ACCOUNT_KEY=
```

Use .js extension on all local imports per NodeNext convention established in Phase 3/4.
  </action>
  <verify>
1. `npx tsc --noEmit` — zero type errors (new modules compile cleanly)
2. `npm ls googleapis google-auth-library` — both installed
3. `.env.example` contains `GOOGLE_SERVICE_ACCOUNT_KEY=` entry
  </verify>
  <done>
- Gmail client authenticates via service account JWT with domain-wide delegation
- GmailAuthError class enables downstream INFRA-05 alerting
- Draft orchestrator ties together body generation, MIME encoding, and Gmail API
- Send function provides simple draft-to-sent pathway
- .env.example documents the new env var with generation instructions
- No PII in any log statements
  </done>
</task>

<task type="auto">
  <name>Task 2: Create barrel export and draft orchestrator tests</name>
  <files>
    src/email/index.ts
    src/email/__tests__/draft.test.ts
  </files>
  <action>
**Create `src/email/index.ts`:**

Barrel export following the pattern from `src/crm/index.ts`:

```typescript
// Email types
export type {
  EmailConfig,
  EmailContext,
  MimeMessageInput,
  CreateEmailDraftInput,
  CreateEmailDraftResult,
  SendResult,
} from './types.js';

// Configuration
export { emailConfig } from './config.js';

// Pure functions
export { generateEmailBody } from './body.js';
export { encodeMimeMessage } from './mime.js';

// Gmail API operations
export { createEmailDraft } from './draft.js';
export { sendEmailDraft } from './send.js';
export { GmailAuthError } from './gmail-client.js';
```

Do NOT export `getGmailClient`, `createGmailDraft`, `sendGmailDraft` from the barrel — those are internal implementation details (same pattern as crm/client.ts not being exported from crm/index.ts).

**Create `src/email/__tests__/draft.test.ts`:**

Test the draft orchestrator with mocked Gmail client. Use `vi.mock()` to mock `../gmail-client.js`.

```typescript
import { describe, it, expect, vi, beforeEach } from 'vitest';
import type { GeneratedChecklist } from '../../checklist/types/index.js';
```

Mock setup:
- `vi.mock('../gmail-client.js', () => ({ createGmailDraft: vi.fn(), sendGmailDraft: vi.fn() }))` — mock before imports
- Import `createEmailDraft` from `../draft.js`
- Import mocked `createGmailDraft` from `../gmail-client.js`
- Mock `createGmailDraft` to resolve with `'draft-123'`

Build a minimal test fixture (inline, use same pattern as body tests — 1 borrower, 1 property, 1 shared item, all forEmail=true).

Test cases:
1. "calls createGmailDraft with base64url-encoded content" — invoke createEmailDraft, verify createGmailDraft was called once with a string matching `/^[A-Za-z0-9_-]+$/`
2. "returns draftId from Gmail API" — verify result.draftId === 'draft-123'
3. "uses dev recipient override when isDev=true" — verify result.recipientEmail === 'dev@venturemortgages.com' (since APP_ENV defaults to 'development' in test)
4. "subject contains borrower names" — verify result.subject contains the borrower first names joined with ' & '
5. "subject has [TEST] prefix in dev mode" — verify result.subject starts with '[TEST] '
6. "bodyPreview is first 200 chars of email body" — verify result.bodyPreview.length <= 200 and starts with 'Hey'
7. "passes checklist to generateEmailBody" — decode the raw argument passed to createGmailDraft from base64url, verify it contains the borrower's doc items

Test `sendEmailDraft` separately:
- Import `sendEmailDraft` from `../send.js`
- Mock `sendGmailDraft` to resolve with `{ messageId: 'msg-456', threadId: 'thread-789' }`
- Test: "returns messageId and threadId from Gmail API" — verify result

beforeEach: `vi.clearAllMocks()` to reset mock state between tests.

Run all email tests: `npx vitest run src/email/` — all pass.
Run full test suite: `npx vitest run` — all tests pass (no regressions).
  </action>
  <verify>
1. `npx vitest run src/email/__tests__/draft.test.ts` — all tests pass
2. `npx vitest run src/email/` — all email tests pass (body + mime + draft)
3. `npx vitest run` — all tests pass (93+ existing + new email tests)
4. `npx tsc --noEmit` — zero type errors
5. Verify barrel: `import { createEmailDraft, sendEmailDraft, generateEmailBody, encodeMimeMessage, GmailAuthError } from './index.js'` compiles
  </verify>
  <done>
- Email barrel export provides clean import surface for downstream consumers (Phase 1 webhook handler)
- Draft orchestrator tests verify end-to-end flow with mocked Gmail API
- Send function tests verify draft-to-sent pathway
- Dev mode safety verified in tests (recipient override, subject prefix)
- No regressions in existing test suite
- Phase 5 Email Drafting is complete
  </done>
</task>

</tasks>

<verification>
1. `npx vitest run src/email/` — all email tests pass
2. `npx vitest run` — all tests pass (no regressions from Phase 3/4)
3. `npx tsc --noEmit` — zero type errors
4. `.env.example` contains `GOOGLE_SERVICE_ACCOUNT_KEY` entry
5. `src/email/index.ts` exports: createEmailDraft, sendEmailDraft, generateEmailBody, encodeMimeMessage, GmailAuthError, emailConfig
</verification>

<success_criteria>
- Gmail client authenticates via service account with domain-wide delegation (googleapis + google-auth-library)
- Draft orchestrator creates email drafts in admin@venturemortgages.com's Gmail
- Send function sends drafts by ID after Cat's approval
- Dev mode overrides recipient and prefixes subject (safety guard)
- Auth errors are typed (GmailAuthError) for INFRA-05 alerting
- Barrel export provides single import point for Phase 1 webhook handler
- All tests pass including existing Phase 3/4 tests
</success_criteria>

<output>
After completion, create `.planning/phases/05-email-drafting/05-02-SUMMARY.md`
</output>
