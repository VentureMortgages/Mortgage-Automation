---
phase: 12-crm-pipeline-automation
task: 0
total_tasks: 3
status: bug_fix_needed
last_updated: 2026-02-26T01:22:12.231Z
---

<current_state>
Phase 12 is COMPLETE (3/3 plans executed, verified). Milestone v1.1 audit done (2/19 reqs satisfied — phases 13-16 not started).

We hit a LIVE CLIENT ISSUE: Fernando Roldan (BRXM-F050844, goal: renew/switch, use: null) submitted an application this morning. The checklist engine returns 0 items because `use` is null. The webhook was also blocked by BullMQ dedup (jobId already in Redis).

We were debugging WHY 0 items are generated. The engine code (generate-checklist.ts, build-context.ts) does NOT filter on `use` directly. Only one rule in property.ts checks `use`. The issue is likely in the rule conditions — most rules may be returning false for this specific combination of data, OR the borrower/income data shape is unexpected for a renewal.
</current_state>

<completed_work>
- Phase 12 execution: 3/3 plans, 9 commits, 743 tests passing
  - 12-01: Task dedup + auto-completion (findReviewTask, completeTask, createOrUpdateReviewTask)
  - 12-02: Sent-detector refactored for opportunity-level stage move + task auto-complete
  - 12-03: Professional contact type assignment (FinmoAgent typed, assignContactType)
- Phase 12 verification: PASSED (13/13 must-haves)
- Milestone v1.1 audit: gaps_found (2/19 satisfied, phases 13-16 not started)
- Fernando Roldan webhook triggered (accepted but BullMQ dedup blocked processing)
- Debugged checklist engine: confirmed engine doesn't filter on `use`, rules don't broadly block on null use
</completed_work>

<remaining_work>
**PRIORITY 1 — Live client fix:**
- Debug why generateChecklist returns 0 items for Fernando Roldan (app 003b1280-3b76-48a6-8db9-192e62839dd0)
- Run the diagnostic script that was written but didn't produce output (context exhausted before seeing results):
  ```
  npx tsx -e "... debug script checking borrowers, incomes, checklist output ..."
  ```
- User's instruction: "any time someone submits the application, we should generate the checklist based on the information we do have, we should not default to nothing if 1 or more items are missing"
- Fix the engine to be resilient to null/missing fields
- Re-trigger the draft for Fernando (need /admin/reprocess-webhook endpoint OR use test-real-apps.ts locally)

**PRIORITY 2 — Phase 12 integration fixes (from audit):**
- checklist-sync.ts:155 moves stage to "Collecting Documents" at webhook time — should only move on email send (PIPE-02)
- classification-worker.ts:103,169 calls createReviewTask instead of createOrUpdateReviewTask (PIPE-01 dedup bypass)

**PRIORITY 3 — Infrastructure:**
- Add /admin/reprocess-webhook endpoint (like existing /admin/reprocess-message) to bypass BullMQ dedup
- Milestone v1.1: phases 13-16 not started (15 requirements pending)
</remaining_work>

<decisions_made>
- Phase 12 plans: 3 plans in 2 waves, all autonomous, all verified
- Stage move triggers on email SEND (BCC detection in sent-detector), not on draft creation
- All CRM operations are non-fatal (per CONTEXT.md)
- Professional type assignment applies to ALL types (realtor, lawyer, etc.), not just realtors
- User set env to live/production — drafts now go to admin@venturemortgages.com
</decisions_made>

<blockers>
- Fernando Roldan draft NOT generated — checklist engine returns 0 items for goal:renew, use:null
- BullMQ dedup prevents re-triggering webhook for same applicationId (need admin endpoint)
- Railway CLI was not logged in initially (user ran `railway link` to fix)
</blockers>

<context>
The user (Luca) is actively working with Taylor's team — this is a live client need. Fernando Roldan submitted a Switch/Transfer application this morning and needs a doc request email draft. The system is now in production mode (APP_ENV=production on Railway).

The checklist engine bug affects any renewal/switch where Finmo doesn't populate the `use` field. The engine should generate items based on available data (incomes, assets, borrower info) even when some fields are null.

Key files to investigate:
- src/checklist/engine/generate-checklist.ts (main engine — looks clean)
- src/checklist/engine/build-context.ts (context builder — looks clean)
- src/checklist/rules/ (individual rules — need to check which conditions fail for renew+null use)
- src/checklist/rules/income-employment.ts (likely the main source of items for any application)

Finmo app details: 003b1280-3b76-48a6-8db9-192e62839dd0, borrower: Fernando Roldan, goal: renew, use: null, incomes: 2, properties: 1
</context>

<next_action>
1. Run diagnostic: fetch Fernando's Finmo app, call generateChecklist, log borrowerChecklists length, items per borrower, warnings, and internalFlags to find where items are being lost
2. Check if borrowerContexts is being built correctly (borrowers array may be empty or incomes not matching borrowerIds)
3. Fix the engine/rules to handle null `use` gracefully
4. Re-generate Fernando's draft using test-real-apps.ts locally
5. Then fix the two Phase 12 integration issues (checklist-sync stage move, classification-worker dedup)
</next_action>
