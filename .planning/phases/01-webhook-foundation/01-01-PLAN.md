---
phase: 01-webhook-foundation
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/config.ts
  - src/webhook/types.ts
  - src/webhook/sanitize.ts
  - src/webhook/__tests__/sanitize.test.ts
autonomous: true

must_haves:
  truths:
    - "PII fields (sinNumber, income, addresses, phone, email, birthDate, creditScore) are replaced with [REDACTED] before logging"
    - "Non-PII metadata (applicationId, goal, applicationStatus, borrower count) passes through sanitizer unchanged"
    - "Kill switch env var name and Redis connection config are defined in shared config"
    - "Webhook payload type and job data type are defined for downstream consumers"
  artifacts:
    - path: "src/config.ts"
      provides: "Shared config with kill switch, Redis connection, Finmo API key"
      contains: "AUTOMATION_KILL_SWITCH"
    - path: "src/webhook/types.ts"
      provides: "WebhookPayload, JobData, ProcessingResult types"
      exports: ["WebhookPayload", "JobData", "ProcessingResult"]
    - path: "src/webhook/sanitize.ts"
      provides: "PII sanitization function for safe logging"
      exports: ["sanitizeForLog", "PII_FIELDS"]
    - path: "src/webhook/__tests__/sanitize.test.ts"
      provides: "Tests for PII sanitization"
      min_lines: 40
  key_links:
    - from: "src/webhook/sanitize.ts"
      to: "src/webhook/types.ts"
      via: "uses PII_FIELDS set to strip sensitive Finmo API fields"
      pattern: "PII_FIELDS"
    - from: "src/config.ts"
      to: "process.env"
      via: "reads AUTOMATION_KILL_SWITCH, REDIS_URL, FINMO_API_KEY"
      pattern: "process\\.env"
---

<objective>
Create the foundational types, shared configuration, and PII sanitization layer for the webhook infrastructure.

Purpose: Everything in Phase 1 depends on these shared modules. The PII sanitizer is the safety-critical piece that prevents sensitive mortgage data from leaking into logs (INFRA-04). Config centralizes all environment variable access. Types define the contract between webhook receiver, queue, and worker.

Output: src/config.ts, src/webhook/types.ts, src/webhook/sanitize.ts with comprehensive tests for the sanitizer.
</objective>

<execution_context>
@C:/Users/lucac/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/lucac/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-webhook-foundation/01-RESEARCH.md
@src/crm/config.ts
@src/email/config.ts
@src/checklist/types/finmo.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create shared config and webhook types</name>
  <files>src/config.ts, src/webhook/types.ts</files>
  <action>
Create `src/config.ts` — shared application config module. Follow the same pattern as `src/crm/config.ts` and `src/email/config.ts` (dotenv import, isDev check, requiredEnv/optionalEnv helpers if not already shared).

Config must export:

```typescript
export interface AppConfig {
  isDev: boolean;
  killSwitch: boolean;          // process.env.AUTOMATION_KILL_SWITCH === 'true'
  redis: {
    url: string | undefined;    // REDIS_URL (Railway provides this)
    host: string;               // REDIS_HOST fallback, default 'localhost'
    port: number;               // REDIS_PORT fallback, default 6379
    password: string | undefined; // REDIS_PASSWORD
  };
  finmo: {
    apiKey: string;             // FINMO_API_KEY (required)
    apiBase: string;            // FINMO_API_BASE, default 'https://app.finmo.ca/api/v1'
    resthookPublicKey: string | undefined; // FINMO_RESTHOOK_PUBLIC_KEY (optional)
  };
  server: {
    port: number;               // PORT, default 3000
  };
}

export const appConfig: AppConfig;
```

The `appConfig` should use `process.env.NODE_ENV !== 'production'` for isDev (same pattern as CRM/email).

Create `src/webhook/types.ts` — webhook-specific types:

```typescript
/** Raw webhook payload from Finmo resthook (shape may vary) */
export interface WebhookPayload {
  applicationId?: string;
  [key: string]: unknown;       // Allow any shape — we extract applicationId flexibly
}

/** Data stored in BullMQ job */
export interface JobData {
  applicationId: string;
  receivedAt: string;           // ISO timestamp of webhook receipt
}

/** Result returned by worker after processing a job */
export interface ProcessingResult {
  applicationId: string;
  contactId: string;
  draftId: string;
  warnings: string[];
  errors: string[];
}
```

Use .js extensions on all local imports per NodeNext convention. Import `dotenv/config` at top of config.ts (side-effect import for env loading). Do NOT import dotenv in types.ts.
  </action>
  <verify>Run `npx tsc --noEmit` — no type errors in new files. Verify config.ts reads from process.env correctly by inspecting the file.</verify>
  <done>appConfig exported with killSwitch, redis, finmo, server sections. WebhookPayload, JobData, ProcessingResult types exported from src/webhook/types.ts. All imports use .js extensions.</done>
</task>

<task type="auto">
  <name>Task 2: TDD PII sanitization function</name>
  <files>src/webhook/sanitize.ts, src/webhook/__tests__/sanitize.test.ts</files>
  <action>
**RED phase:** Create test file first at `src/webhook/__tests__/sanitize.test.ts`. Write tests for `sanitizeForLog`:

Test cases (at minimum):
1. Returns primitive values unchanged (string, number, boolean, null, undefined)
2. Redacts known PII fields: sinNumber, email, phone, workPhone, phoneNumber, birthDate, income, incomePeriodAmount, balance, creditLimit, monthlyPayment, creditScore, line1, line2, streetNumber, streetName, postCode, ipAddress, location
3. Preserves non-PII fields: applicationId, id, goal, applicationStatus, isMainBorrower, employmentType, firstName (borderline but needed for logging borrower count), lastName
4. Handles nested objects: `{ borrower: { sinNumber: '123', firstName: 'John' } }` -> `{ borrower: { sinNumber: '[REDACTED]', firstName: 'John' } }`
5. Handles arrays: replaces arrays with `[Array(N)]` summary (never iterate into array contents — arrays could contain PII objects)
6. Handles depth limit: stops recursing at depth 10, returns `[Object]` for deeper nesting
7. Handles null/undefined input: returns as-is
8. Real-world test: sanitize a mock Finmo borrower object (with sinNumber, email, phone, income fields) and verify ALL PII fields are redacted while metadata survives

Run tests — they MUST fail (functions don't exist yet).

**GREEN phase:** Create `src/webhook/sanitize.ts`:

```typescript
export const PII_FIELDS = new Set([
  'sinNumber', 'email', 'phone', 'workPhone', 'phoneNumber',
  'birthDate', 'income', 'incomePeriodAmount', 'balance',
  'creditLimit', 'monthlyPayment', 'creditScore',
  'line1', 'line2', 'streetNumber', 'streetName', 'postCode',
  'ipAddress', 'location',
]);

export function sanitizeForLog(obj: unknown, depth = 0): unknown {
  // Implementation per research Pattern 4
  // - null/undefined: return as-is
  // - primitives: return as-is
  // - arrays: return `[Array(N)]` string (don't iterate)
  // - depth > 10: return '[Object]'
  // - objects: iterate keys, redact PII_FIELDS with '[REDACTED]', recurse non-PII object values
}
```

Run tests — they MUST pass.

**REFACTOR:** If any cleanup needed, do it and re-run tests.

Important: Do NOT include `firstName` or `lastName` in PII_FIELDS — these are needed for logging context (e.g., "Processing application for John D."). The sanitizer's job is to catch high-sensitivity fields (SIN, income, address details). Names are acceptable in structured logs at metadata level.
  </action>
  <verify>Run `npx vitest run src/webhook/__tests__/sanitize.test.ts` — all tests pass. Run `npx tsc --noEmit` — no type errors.</verify>
  <done>sanitizeForLog correctly redacts all PII_FIELDS values, preserves non-PII metadata, handles arrays as summaries, handles nested objects, and has 8+ passing test cases.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. `npx vitest run src/webhook/__tests__/sanitize.test.ts` — all tests pass
3. `src/config.ts` exports `appConfig` with killSwitch, redis, finmo, server sections
4. `src/webhook/types.ts` exports WebhookPayload, JobData, ProcessingResult
5. `src/webhook/sanitize.ts` exports sanitizeForLog and PII_FIELDS
6. No PII field names appear outside of the PII_FIELDS set definition
</verification>

<success_criteria>
- PII sanitizer redacts sinNumber, email, phone, income, addresses, creditScore and all other PII fields
- Non-PII metadata (applicationId, goal, status) passes through unchanged
- Shared config reads all required env vars (kill switch, Redis, Finmo, port)
- All types defined for webhook payload, job data, and processing result
- Tests pass and TypeScript compiles
</success_criteria>

<output>
After completion, create `.planning/phases/01-webhook-foundation/01-01-SUMMARY.md`
</output>
