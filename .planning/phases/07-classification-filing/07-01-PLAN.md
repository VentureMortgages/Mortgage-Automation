---
phase: 07-classification-filing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/classification/types.ts
  - src/classification/config.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "Classification types define all mortgage document types and structured output schema"
    - "Classification config loads Anthropic API key, confidence threshold, Drive root folder ID, and model settings from env vars"
    - "Zod schema for classification output is defined and exported"
    - "@anthropic-ai/sdk and zod are installed as production dependencies"
  artifacts:
    - path: "src/classification/types.ts"
      provides: "DocumentType union, ClassificationResult, FilingDecision, ClassificationJobData, DOCUMENT_TYPES, SUBFOLDER_ROUTING, DOC_TYPE_LABELS"
      min_lines: 80
    - path: "src/classification/config.ts"
      provides: "ClassificationConfig with anthropicApiKey, model, confidenceThreshold, maxClassificationPages, driveRootFolderId, driveFolderFieldId"
      min_lines: 30
  key_links:
    - from: "src/classification/types.ts"
      to: "src/intake/types.ts"
      via: "IntakeDocument referenced in ClassificationJobData"
      pattern: "IntakeDocument|IntakeSource"
---

<objective>
Install dependencies and create the classification module's type definitions, Zod schema, and configuration.

Purpose: Establishes the type foundation for all Phase 7 plans. The DOCUMENT_TYPES constant, ClassificationResult schema, subfolder routing table, and doc type labels are consumed by classifier, naming, router, filer, and worker modules.

Output: `src/classification/types.ts`, `src/classification/config.ts`, updated `package.json`
</objective>

<execution_context>
@C:/Users/lucac/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/lucac/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-classification-filing/07-RESEARCH.md
@.planning/DRIVE_STRUCTURE.md
@src/intake/types.ts
@src/config.ts
@src/crm/config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install @anthropic-ai/sdk and zod dependencies</name>
  <files>package.json</files>
  <action>
Run `npm install @anthropic-ai/sdk zod` to add both as production dependencies.

These are needed for:
- `@anthropic-ai/sdk`: Claude API client for document classification (PDF analysis with structured output)
- `zod`: Schema definition used by `zodOutputFormat` helper from the SDK for guaranteed-valid JSON responses

Verify installation succeeds and both appear in package.json dependencies.
  </action>
  <verify>`npm ls @anthropic-ai/sdk zod` shows both installed without errors. `npm test` still passes (241 existing tests).</verify>
  <done>Both `@anthropic-ai/sdk` and `zod` are in package.json dependencies and installed in node_modules.</done>
</task>

<task type="auto">
  <name>Task 2: Create classification types and config modules</name>
  <files>src/classification/types.ts, src/classification/config.ts</files>
  <action>
**Create `src/classification/types.ts`:**

1. Define `DOCUMENT_TYPES` as a const array with all mortgage document types from the research:
   - Base: `photo_id`, `second_id`, `void_cheque`
   - Income-Employed: `pay_stub`, `loe`, `t4`, `noa`
   - Income-Self-employed: `t1`, `t2`, `articles_of_incorporation`, `financial_statement`
   - Income-Other: `pension_letter`, `t4a`, `employment_contract`
   - Variable income: `commission_statement`, `lease_agreement`
   - Down payment: `bank_statement`, `rrsp_statement`, `tfsa_statement`, `fhsa_statement`, `gift_letter`
   - Property: `purchase_agreement`, `mls_listing`, `mortgage_statement`, `property_tax_bill`, `home_insurance`
   - Tax: `t5`, `cra_statement_of_account`, `t4rif`
   - Situations: `separation_agreement`, `divorce_decree`, `discharge_certificate`
   - Residency: `pr_card`, `passport`, `work_permit`
   - Catch-all: `other`

2. Export `DocumentType` as `typeof DOCUMENT_TYPES[number]`

3. Define and export Zod `ClassificationResultSchema` using `z.object`:
   - `documentType`: `z.enum(DOCUMENT_TYPES)`
   - `confidence`: `z.number()` (0.0-1.0)
   - `borrowerFirstName`: `z.string().nullable()`
   - `borrowerLastName`: `z.string().nullable()`
   - `taxYear`: `z.number().nullable()`
   - `amount`: `z.string().nullable()` (formatted like "$16k", "$5.2k")
   - `institution`: `z.string().nullable()` (bank/employer name)
   - `pageCount`: `z.number().nullable()`
   - `additionalNotes`: `z.string().nullable()`

4. Export `ClassificationResult` as `z.infer<typeof ClassificationResultSchema>`

5. Define `SubfolderTarget` type: `'person' | 'subject_property' | 'non_subject_property' | 'signed_docs' | 'down_payment' | 'root'`

6. Define and export `SUBFOLDER_ROUTING` as `Record<DocumentType, SubfolderTarget>` mapping every document type to its target subfolder. Use the routing table from 07-RESEARCH.md exactly.

7. Define and export `DOC_TYPE_LABELS` as `Record<DocumentType, string>` mapping document type identifiers to human-readable labels for filenames:
   - `photo_id` -> `'ID'`
   - `second_id` -> `'Second ID'`
   - `pay_stub` -> `'Pay Stub'`
   - `loe` -> `'LOE'`
   - `t4` -> `'T4'`
   - `t4a` -> `'T4A'`
   - `noa` -> `'NOA'`
   - `t1` -> `'T1'`
   - `t5` -> `'T5'`
   - `t4rif` -> `'T4RIF'`
   - `t2` -> `'T2'`
   - `bank_statement` -> `'Bank Statement'`
   - `rrsp_statement` -> `'RRSP Statement'`
   - `tfsa_statement` -> `'TFSA Statement'`
   - `fhsa_statement` -> `'FHSA Statement'`
   - `gift_letter` -> `'Gift Letter'`
   - `void_cheque` -> `'Void Cheque'`
   - `purchase_agreement` -> `'Purchase Agreement'`
   - `mls_listing` -> `'MLS'`
   - `mortgage_statement` -> `'Mortgage Statement'`
   - `property_tax_bill` -> `'Property Tax'`
   - `home_insurance` -> `'Home Insurance'`
   - `pension_letter` -> `'Pension Letter'`
   - `employment_contract` -> `'Employment Contract'`
   - `commission_statement` -> `'Commission Statement'`
   - `lease_agreement` -> `'Lease Agreement'`
   - `articles_of_incorporation` -> `'Articles of Incorporation'`
   - `financial_statement` -> `'Financial Statement'`
   - `separation_agreement` -> `'Separation Agreement'`
   - `divorce_decree` -> `'Divorce Decree'`
   - `discharge_certificate` -> `'Discharge Certificate'`
   - `pr_card` -> `'PR Card'`
   - `passport` -> `'Passport'`
   - `work_permit` -> `'Work Permit'`
   - `cra_statement_of_account` -> `'CRA Statement'`
   - `other` -> `'Document'`

8. Define `FilingDecision` interface:
   ```typescript
   export interface FilingDecision {
     classification: ClassificationResult;
     filename: string;
     subfolderTarget: SubfolderTarget;
     /** Resolved Google Drive folder ID for the target subfolder */
     targetFolderId: string;
     /** If an existing file was found, its Drive file ID (for update/replace) */
     existingFileId: string | null;
   }
   ```

9. Define `ClassificationJobData` interface:
   ```typescript
   export interface ClassificationJobData {
     /** Unique intake document ID for dedup (e.g., gmail-{messageId}-{index}) */
     intakeDocumentId: string;
     /** Temp file path where pdfBuffer is saved (NOT in Redis) */
     tempFilePath: string;
     /** Original filename (hint for classifier) */
     originalFilename: string;
     /** Sender email (for CRM contact matching) */
     senderEmail: string | null;
     /** Finmo application ID (if from Finmo source) */
     applicationId: string | null;
     /** Source of the document */
     source: 'gmail' | 'finmo';
     /** ISO timestamp */
     receivedAt: string;
   }
   ```

10. Define `ClassificationJobResult` interface:
    ```typescript
    export interface ClassificationJobResult {
      intakeDocumentId: string;
      classification: ClassificationResult | null;
      filed: boolean;
      driveFileId: string | null;
      manualReview: boolean;
      error: string | null;
    }
    ```

**Create `src/classification/config.ts`:**

Follow the same pattern as `src/config.ts` and `src/crm/config.ts`.

```typescript
import 'dotenv/config';

export interface ClassificationConfig {
  /** Anthropic API key for Claude classification */
  anthropicApiKey: string;
  /** Claude model ID for classification (default: claude-haiku-4-5-20241022) */
  model: string;
  /** Confidence threshold below which documents go to manual review (default: 0.7) */
  confidenceThreshold: number;
  /** Maximum pages to send to Claude for classification (default: 3) */
  maxClassificationPages: number;
  /** Google Drive root folder ID for "Mortgage Clients" folder */
  driveRootFolderId: string;
  /** Whether classification is enabled (kill switch) */
  enabled: boolean;
  /** Email to impersonate for Drive API operations */
  driveImpersonateAs: string;
}
```

- `anthropicApiKey`: `requiredEnv('ANTHROPIC_API_KEY')`
- `model`: `optionalEnv('CLASSIFICATION_MODEL', 'claude-haiku-4-5-20241022')`
- `confidenceThreshold`: `parseFloat(optionalEnv('CLASSIFICATION_CONFIDENCE_THRESHOLD', '0.7'))`
- `maxClassificationPages`: `parseInt(optionalEnv('CLASSIFICATION_MAX_PAGES', '3'), 10)`
- `driveRootFolderId`: `optionalEnv('DRIVE_ROOT_FOLDER_ID')` (optional because it may be populated by setup script)
- `enabled`: `process.env.CLASSIFICATION_ENABLED !== 'false'` (enabled by default)
- `driveImpersonateAs`: `optionalEnv('DRIVE_IMPERSONATE_AS', isDev ? 'dev@venturemortgages.com' : 'admin@venturemortgages.com')`

Use `requiredEnv` and `optionalEnv` helpers (define locally, same pattern as other config files). Import `dotenv/config` at top.

All imports must use `.js` extension for NodeNext module resolution.
  </action>
  <verify>`npx tsc --noEmit` passes. `npm test` still passes (241 tests). Check that `src/classification/types.ts` and `src/classification/config.ts` exist and compile.</verify>
  <done>Both files exist, compile without errors, export all specified types/constants/config. DOCUMENT_TYPES has 33 entries. SUBFOLDER_ROUTING covers all 33. DOC_TYPE_LABELS covers all 33. ClassificationResultSchema is a valid Zod schema.</done>
</task>

</tasks>

<verification>
1. `npm ls @anthropic-ai/sdk zod` shows both installed
2. `npx tsc --noEmit` passes with zero errors
3. `npm test` passes (241 existing tests unaffected)
4. `src/classification/types.ts` exports: DOCUMENT_TYPES, DocumentType, ClassificationResultSchema, ClassificationResult, SUBFOLDER_ROUTING, SubfolderTarget, DOC_TYPE_LABELS, FilingDecision, ClassificationJobData, ClassificationJobResult
5. `src/classification/config.ts` exports: classificationConfig, ClassificationConfig
</verification>

<success_criteria>
- @anthropic-ai/sdk and zod installed as production dependencies
- Classification types module compiles and exports all type definitions
- Classification config loads env vars following established project patterns
- All 241 existing tests still pass
</success_criteria>

<output>
After completion, create `.planning/phases/07-classification-filing/07-01-SUMMARY.md`
</output>
