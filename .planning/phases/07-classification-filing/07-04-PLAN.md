---
phase: 07-classification-filing
plan: 04
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/classification/drive-client.ts
  - src/classification/filer.ts
  - src/classification/__tests__/drive-client.test.ts
  - src/classification/__tests__/filer.test.ts
autonomous: true

must_haves:
  truths:
    - "Drive client authenticates using same service account pattern as gmail-client.ts with drive scope"
    - "Filer can search for folders by name within a parent folder"
    - "Filer can create new folders (person subfolders, Subject Property, etc.) on demand"
    - "Filer can upload a PDF to a target folder with a given filename"
    - "Filer can find existing files by name pattern for versioning/replace"
    - "Filer can update/replace an existing file's content"
  artifacts:
    - path: "src/classification/drive-client.ts"
      provides: "getDriveClient lazy singleton for Google Drive API v3"
      min_lines: 40
    - path: "src/classification/filer.ts"
      provides: "findFolder, findOrCreateFolder, uploadFile, findExistingFile, updateFileContent, resolveTargetFolder"
      min_lines: 100
    - path: "src/classification/__tests__/filer.test.ts"
      provides: "Tests for all filer operations with mocked Drive client"
      min_lines: 80
  key_links:
    - from: "src/classification/drive-client.ts"
      to: "src/email/gmail-client.ts"
      via: "Same loadServiceAccountKey + JWT pattern, different scope (drive)"
      pattern: "JWT|loadServiceAccountKey|googleapis"
    - from: "src/classification/filer.ts"
      to: "src/classification/drive-client.ts"
      via: "getDriveClient() for Drive API calls"
      pattern: "getDriveClient"
---

<objective>
Build the Google Drive client and filer module for searching folders, creating subfolders, uploading documents, and handling re-uploads (versioning).

Purpose: Implements FILE-03 (file to correct Drive folder) and FILE-04 (handle re-uploads). The Drive client reuses the service account authentication pattern from gmail-client.ts with the `https://www.googleapis.com/auth/drive` scope. The filer provides folder search/creation and file upload/update operations.

Output: `src/classification/drive-client.ts`, `src/classification/filer.ts` + test suites
</objective>

<execution_context>
@C:/Users/lucac/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/lucac/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-classification-filing/07-RESEARCH.md
@.planning/phases/07-classification-filing/07-01-SUMMARY.md
@.planning/DRIVE_STRUCTURE.md
@src/email/gmail-client.ts
@src/classification/types.ts
@src/classification/config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Google Drive API client with service account auth</name>
  <files>src/classification/drive-client.ts, src/classification/__tests__/drive-client.test.ts</files>
  <action>
**Create `src/classification/drive-client.ts`:**

Follow the exact same authentication pattern as `src/email/gmail-client.ts` but for Google Drive:

```typescript
import { google } from 'googleapis';
import { JWT, OAuth2Client } from 'google-auth-library';
import { classificationConfig } from './config.js';
```

1. Define `DriveClient` type:
   ```typescript
   export type DriveClient = ReturnType<typeof google.drive>;
   ```

2. Reuse `loadServiceAccountKey()` — since it's an internal function in gmail-client.ts (not exported), implement the same logic here:
   - Read `GOOGLE_SERVICE_ACCOUNT_KEY` env var
   - Base64 decode to JSON
   - Extract and validate `client_email` and `private_key`
   - Throw descriptive error if missing/malformed

3. Implement lazy singleton `getDriveClient(): DriveClient`:
   - Cache in module-level variable `_driveClient`
   - Auth detection: same as gmail-client — check `GOOGLE_REFRESH_TOKEN` first (OAuth2 dev mode), then service account
   - OAuth2 mode: create OAuth2Client with refresh token, `['https://www.googleapis.com/auth/drive']` scope
   - Service account mode: create JWT with `['https://www.googleapis.com/auth/drive']` scope, `subject: classificationConfig.driveImpersonateAs`
   - Create and return `google.drive({ version: 'v3', auth })`

4. Export `getDriveClient` and `DriveClient`.

5. Also export `resetDriveClient()` for testing (sets `_driveClient = null`).

**Create `src/classification/__tests__/drive-client.test.ts`:**

Basic tests with mocked googleapis:
1. **Creates Drive client with service account auth:** Mock env var, assert JWT created with drive scope
2. **Creates Drive client with OAuth2 auth:** Mock GOOGLE_REFRESH_TOKEN, assert OAuth2Client used
3. **Caches client (singleton):** Call getDriveClient twice, assert google.drive called once
4. **resetDriveClient clears cache:** Call reset, then getDriveClient again, assert google.drive called twice total
5. **Throws if no credentials:** No env vars set, assert throws with descriptive message

Mock `googleapis` and `google-auth-library` using vi.mock.
  </action>
  <verify>`npm test -- --run src/classification/__tests__/drive-client.test.ts` passes. `npx tsc --noEmit` passes.</verify>
  <done>Drive client authenticates using the same service account / OAuth2 pattern as Gmail client but with drive scope. Lazy singleton caching works. Tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: Create filer module with folder search/create and file upload/update</name>
  <files>src/classification/filer.ts, src/classification/__tests__/filer.test.ts</files>
  <action>
**Create `src/classification/filer.ts`:**

```typescript
import { Readable } from 'node:stream';
import { getDriveClient } from './drive-client.js';
import type { DriveClient } from './drive-client.js';
import type { SubfolderTarget } from './types.js';
```

All filer functions accept `drive: DriveClient` as a parameter (pure, testable — same pattern as gmail-reader.ts accepting gmail client as param). If no drive param provided, call `getDriveClient()` internally.

1. **`findFolder(drive: DriveClient, name: string, parentId: string): Promise<string | null>`**
   - Query: `name = '${escapeDriveQuery(name)}' and '${parentId}' in parents and mimeType = 'application/vnd.google-apps.folder' and trashed = false`
   - Fields: `files(id, name)`
   - Return first match's ID, or null if none found

2. **`createFolder(drive: DriveClient, name: string, parentId: string): Promise<string>`**
   - Create with `mimeType: 'application/vnd.google-apps.folder'`, `parents: [parentId]`
   - Fields: `id`
   - Return the created folder's ID

3. **`findOrCreateFolder(drive: DriveClient, name: string, parentId: string): Promise<string>`**
   - Try findFolder first; if found, return it
   - Otherwise createFolder and return
   - Log action taken (found existing vs created new)

4. **`uploadFile(drive: DriveClient, pdfBuffer: Buffer, filename: string, parentFolderId: string): Promise<string>`**
   - Create file with `name: filename`, `parents: [parentFolderId]`
   - Media: `mimeType: 'application/pdf'`, `body: Readable.from(pdfBuffer)`
   - Fields: `id, name, webViewLink`
   - Return the file's ID
   - Log: filename, folder ID (no PII)

5. **`findExistingFile(drive: DriveClient, filenamePattern: string, parentFolderId: string): Promise<{ id: string; name: string } | null>`**
   - Query: `name contains '${escapeDriveQuery(filenamePattern)}' and '${parentFolderId}' in parents and trashed = false`
   - Fields: `files(id, name, modifiedTime)`
   - Return first match or null
   - Used for versioning: find existing doc of same type before uploading

6. **`updateFileContent(drive: DriveClient, fileId: string, pdfBuffer: Buffer, newFilename?: string): Promise<void>`**
   - Update file content with media body
   - Optionally rename if newFilename provided
   - Used for FILE-04: replacing existing file with updated version

7. **`resolveTargetFolder(drive: DriveClient, clientFolderId: string, subfolderTarget: SubfolderTarget, personName: string): Promise<string>`**
   - If `subfolderTarget === 'root'`: return clientFolderId
   - If `subfolderTarget === 'person'`: findOrCreateFolder(drive, personName, clientFolderId)
   - If `subfolderTarget === 'subject_property'`: findOrCreateFolder(drive, 'Subject Property', clientFolderId)
   - If `subfolderTarget === 'non_subject_property'`: findOrCreateFolder(drive, 'Non-Subject Property', clientFolderId)
   - If `subfolderTarget === 'down_payment'`: findOrCreateFolder(drive, 'Down Payment', clientFolderId)
   - If `subfolderTarget === 'signed_docs'`: findOrCreateFolder(drive, 'Signed Docs', clientFolderId)

8. **`escapeDriveQuery(str: string): string`**
   - Escape single quotes in Drive query strings: replace `'` with `\\'`
   - Prevent query injection

Export all public functions.

**Create `src/classification/__tests__/filer.test.ts`:**

Create a mock Drive client factory that returns mocked `files.list`, `files.create`, `files.update` methods.

Test cases:
1. **findFolder returns ID when found:** Mock files.list to return one file. Assert returns the ID.
2. **findFolder returns null when empty:** Mock files.list to return empty. Assert returns null.
3. **createFolder creates with correct metadata:** Assert files.create called with folder MIME type and parent.
4. **findOrCreateFolder uses existing:** Mock findFolder to return ID. Assert createFolder NOT called.
5. **findOrCreateFolder creates when missing:** Mock findFolder to return null. Assert createFolder called.
6. **uploadFile uploads with correct metadata:** Assert files.create called with PDF MIME, filename, parent, and media body.
7. **findExistingFile returns match:** Mock files.list with a file. Assert returns id+name.
8. **findExistingFile returns null when no match:** Mock files.list empty. Assert returns null.
9. **updateFileContent updates existing file:** Assert files.update called with fileId and media body.
10. **updateFileContent renames if newFilename provided:** Assert files.update includes name in requestBody.
11. **resolveTargetFolder: 'root' returns clientFolderId directly:** No API call.
12. **resolveTargetFolder: 'person' finds/creates person subfolder:** Assert findOrCreateFolder called with personName.
13. **resolveTargetFolder: 'subject_property' finds/creates Subject Property:** Assert findOrCreateFolder called with 'Subject Property'.
14. **escapeDriveQuery escapes single quotes:** `O'Brien` -> `O\\'Brien`.
  </action>
  <verify>`npm test -- --run src/classification/__tests__/filer.test.ts` passes. `npx tsc --noEmit` passes.</verify>
  <done>Filer provides complete Drive operations: folder search/create, file upload, existing file detection, file content update, and target folder resolution for all subfolder types. All operations use Drive client as parameter for testability. Tests pass with mocked Drive client.</done>
</task>

</tasks>

<verification>
1. `npm test -- --run src/classification/__tests__/` passes all new tests
2. `npm test` passes (all existing + new tests)
3. `npx tsc --noEmit` passes
4. drive-client.ts creates authenticated Drive API v3 client
5. filer.ts handles all CRUD operations on Drive folders and files
6. All filer functions accept drive client as parameter (testable without real API)
</verification>

<success_criteria>
- Drive client reuses service account auth pattern from gmail-client.ts
- Filer supports: find folder, create folder, find-or-create, upload file, find existing file, update file content
- resolveTargetFolder maps SubfolderTarget to correct Drive subfolder name
- All operations are testable with mocked Drive client
- Drive query strings are properly escaped
</success_criteria>

<output>
After completion, create `.planning/phases/07-classification-filing/07-04-SUMMARY.md`
</output>
