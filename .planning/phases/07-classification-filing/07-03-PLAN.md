---
phase: 07-classification-filing
plan: 03
type: tdd
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/classification/classifier.ts
  - src/classification/naming.ts
  - src/classification/router.ts
  - src/classification/__tests__/classifier.test.ts
  - src/classification/__tests__/naming.test.ts
  - src/classification/__tests__/router.test.ts
autonomous: true

must_haves:
  truths:
    - "Classifier sends PDF to Claude API and returns structured ClassificationResult with document type, confidence, and metadata"
    - "Naming module generates filenames following Cat's convention: FirstName - DocType [Institution] [Year] [Amount].pdf"
    - "Router maps document type to correct subfolder target using SUBFOLDER_ROUTING table"
    - "Documents exceeding max page count are truncated before classification"
    - "Filenames are sanitized (no special chars that break file systems)"
  artifacts:
    - path: "src/classification/classifier.ts"
      provides: "classifyDocument function: Buffer -> ClassificationResult"
      min_lines: 60
    - path: "src/classification/naming.ts"
      provides: "generateFilename function: ClassificationResult -> string, sanitizeFilename helper"
      min_lines: 50
    - path: "src/classification/router.ts"
      provides: "routeToSubfolder function: DocumentType -> SubfolderTarget, getPersonSubfolderName helper"
      min_lines: 30
    - path: "src/classification/__tests__/classifier.test.ts"
      provides: "Tests for Claude API classification with mocked SDK"
      min_lines: 60
    - path: "src/classification/__tests__/naming.test.ts"
      provides: "Tests for filename generation with all doc type patterns"
      min_lines: 80
    - path: "src/classification/__tests__/router.test.ts"
      provides: "Tests for subfolder routing logic"
      min_lines: 40
  key_links:
    - from: "src/classification/classifier.ts"
      to: "@anthropic-ai/sdk"
      via: "Anthropic client with structured output"
      pattern: "Anthropic|messages\\.create|output_config"
    - from: "src/classification/naming.ts"
      to: "src/classification/types.ts"
      via: "DOC_TYPE_LABELS for human-readable labels"
      pattern: "DOC_TYPE_LABELS"
    - from: "src/classification/router.ts"
      to: "src/classification/types.ts"
      via: "SUBFOLDER_ROUTING for type-to-folder mapping"
      pattern: "SUBFOLDER_ROUTING"
---

<objective>
Build the document classifier (Claude API), file naming module, and subfolder router using TDD.

Purpose: These three pure/near-pure functions form the core intelligence of Phase 7. The classifier identifies document type via Claude's PDF analysis. The naming module generates Cat-convention filenames. The router maps types to subfolders. All three are highly testable with defined I/O.

Output: `src/classification/classifier.ts`, `src/classification/naming.ts`, `src/classification/router.ts` + test suites
</objective>

<execution_context>
@C:/Users/lucac/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/lucac/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-classification-filing/07-RESEARCH.md
@.planning/phases/07-classification-filing/07-01-SUMMARY.md
@.planning/DRIVE_STRUCTURE.md
@src/classification/types.ts
@src/classification/config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build classifier with Claude API structured output (TDD)</name>
  <files>src/classification/classifier.ts, src/classification/__tests__/classifier.test.ts</files>
  <action>
**TDD: Write tests first, then implement.**

**RED — Create `src/classification/__tests__/classifier.test.ts`:**

Mock the Anthropic SDK to avoid real API calls:
```typescript
import { vi, describe, it, expect, beforeEach } from 'vitest';

// Mock the Anthropic SDK
const mockCreate = vi.fn();
vi.mock('@anthropic-ai/sdk', () => ({
  default: class MockAnthropic {
    messages = { create: mockCreate };
  },
}));

// Mock config to avoid env var loading
vi.mock('../../classification/config.js', () => ({
  classificationConfig: {
    anthropicApiKey: 'test-key',
    model: 'claude-haiku-4-5-20241022',
    maxClassificationPages: 3,
    confidenceThreshold: 0.7,
  },
}));
```

Test cases:
1. **Classifies a T4 document:** Mock Claude response with `{ documentType: 't4', confidence: 0.95, borrowerFirstName: 'Kathy', ... }`. Assert classifyDocument returns a valid ClassificationResult.
2. **Classifies a pay stub:** Mock response with pay_stub type. Assert correct structure.
3. **Handles low confidence:** Mock response with confidence 0.4. Assert result still returned (threshold checking is done by worker, not classifier).
4. **Passes PDF as base64 document block:** Assert mockCreate was called with `messages[0].content[0].type === 'document'` and `source.type === 'base64'` and `source.media_type === 'application/pdf'`.
5. **Uses structured output config:** Assert mockCreate was called with `output_config` containing the format with JSON schema.
6. **Uses configured model:** Assert mockCreate was called with `model: 'claude-haiku-4-5-20241022'`.
7. **Throws on API error:** Mock mockCreate to throw. Assert classifyDocument propagates the error.
8. **Truncates large PDFs:** Provide a buffer, mock pdf-lib's PDFDocument.load to return a doc with 10 pages. Assert the function extracts only maxClassificationPages pages before sending to Claude. (Mock pdf-lib for this test.)

Run tests — they should FAIL (no implementation).

**GREEN — Create `src/classification/classifier.ts`:**

```typescript
import Anthropic from '@anthropic-ai/sdk';
import { z } from 'zod';
import { zodOutputFormat } from '@anthropic-ai/sdk/helpers/zod';
import { PDFDocument } from 'pdf-lib';
import { classificationConfig } from './config.js';
import { ClassificationResultSchema } from './types.js';
import type { ClassificationResult } from './types.js';
```

1. Lazy singleton for Anthropic client:
```typescript
let _client: Anthropic | null = null;
function getClient(): Anthropic {
  if (_client) return _client;
  _client = new Anthropic({ apiKey: classificationConfig.anthropicApiKey });
  return _client;
}
```

2. Implement `truncatePdf(pdfBuffer: Buffer, maxPages: number): Promise<Buffer>`:
   - Load PDF with `PDFDocument.load(new Uint8Array(pdfBuffer))`
   - If page count <= maxPages, return original buffer
   - Otherwise, create a new PDFDocument, copy first maxPages pages, save and return

3. Implement `classifyDocument(pdfBuffer: Buffer, filenameHint?: string): Promise<ClassificationResult>`:
   - Truncate PDF to maxClassificationPages
   - Create the classification prompt (same as research example, include the filenameHint as a secondary signal)
   - Call Claude API:
     ```typescript
     const response = await getClient().messages.create({
       model: classificationConfig.model,
       max_tokens: 512,
       messages: [{
         role: 'user',
         content: [
           {
             type: 'document',
             source: {
               type: 'base64',
               media_type: 'application/pdf',
               data: truncatedBuffer.toString('base64'),
             },
           },
           {
             type: 'text',
             text: classificationPrompt(filenameHint),
           },
         ],
       }],
       output_config: { format: zodOutputFormat(ClassificationResultSchema, 'classification') },
     });
     ```
   - Parse the response: `JSON.parse(response.content[0].text)` and validate with `ClassificationResultSchema.parse()`
   - Return the validated ClassificationResult
   - Log only: documentType, confidence (no PII)

4. Export `classifyDocument` and `truncatePdf` (truncatePdf exported for testing).

The classification prompt should list all known document types and instruct Claude to set confidence below 0.7 if uncertain. Include the filename hint if provided.

Run tests — they should PASS.
  </action>
  <verify>`npm test -- --run src/classification/__tests__/classifier.test.ts` passes. `npx tsc --noEmit` passes.</verify>
  <done>Classifier sends PDF to Claude via structured output, returns validated ClassificationResult. Large PDFs are truncated. All tests pass with mocked SDK.</done>
</task>

<task type="auto">
  <name>Task 2: Build naming module and subfolder router (TDD)</name>
  <files>src/classification/naming.ts, src/classification/router.ts, src/classification/__tests__/naming.test.ts, src/classification/__tests__/router.test.ts</files>
  <action>
**TDD: Write tests first for both modules, then implement.**

### Naming Module

**RED — Create `src/classification/__tests__/naming.test.ts`:**

Test cases based on Cat's actual naming patterns from DRIVE_STRUCTURE.md:
1. **T4 with all fields:** `{ documentType: 't4', borrowerFirstName: 'Kathy', institution: 'CPP', taxYear: 2024, amount: '$16k' }` -> `'Kathy - T4 CPP 2024 $16k.pdf'`
2. **T4RIF with institution and amount:** `{ documentType: 't4rif', borrowerFirstName: 'Terry', institution: 'Scotia', taxYear: 2024, amount: '$34k' }` -> `'Terry - T4RIF Scotia 2024 $34k.pdf'`
3. **Pay stub without year/amount:** `{ documentType: 'pay_stub', borrowerFirstName: 'Susan' }` -> `'Susan - Pay Stub.pdf'`
4. **ID only:** `{ documentType: 'photo_id', borrowerFirstName: 'Kathy' }` -> `'Kathy - ID.pdf'`
5. **T5 with institution and amount:** `{ documentType: 't5', borrowerFirstName: 'Terry', institution: 'Desjardins', taxYear: 2024, amount: '$585' }` -> `'Terry - T5 Desjardins 2024 $585.pdf'`
6. **Null borrower name uses fallback:** `{ documentType: 'noa', borrowerFirstName: null, taxYear: 2024 }` with fallbackName='John' -> `'John - NOA 2024.pdf'`
7. **Void cheque (shared doc):** `{ documentType: 'void_cheque', borrowerFirstName: null }` with fallbackName='Albrecht' -> `'Albrecht - Void Cheque.pdf'`
8. **Purchase agreement (property doc):** `{ documentType: 'purchase_agreement', borrowerFirstName: null }` with fallbackName='4587 Postill Dr' -> `'4587 Postill Dr - Purchase Agreement.pdf'`
9. **Sanitizes special characters:** Filename with `/ \ : * ? " < > |` in parts -> all replaced with `-` or removed
10. **Unknown doc type uses 'Document' label:** `{ documentType: 'other' }` -> `'Name - Document.pdf'`
11. **Amount with no institution:** `{ documentType: 'bank_statement', borrowerFirstName: 'Susan', amount: '$630k+' }` -> `'Susan - Bank Statement $630k+.pdf'`

**GREEN — Create `src/classification/naming.ts`:**

```typescript
import { DOC_TYPE_LABELS } from './types.js';
import type { ClassificationResult } from './types.js';
```

1. Implement `sanitizeFilename(filename: string): string`:
   - Replace characters not allowed in filenames (`/ \ : * ? " < > |`) with `-`
   - Collapse multiple spaces into one
   - Trim whitespace
   - Do NOT remove `$`, `+`, `.`, parentheses (these appear in Cat's naming)

2. Implement `generateFilename(classification: ClassificationResult, fallbackName: string): string`:
   - `name` = `classification.borrowerFirstName ?? fallbackName`
   - `docLabel` = `DOC_TYPE_LABELS[classification.documentType] ?? classification.documentType`
   - Build parts array: `[name, '-', docLabel]`
   - If `classification.institution` is not null: push institution
   - If `classification.taxYear` is not null: push String(taxYear)
   - If `classification.amount` is not null: push amount
   - Join with space, append `.pdf`
   - Return `sanitizeFilename(result)`

3. Export both functions.

### Router Module

**RED — Create `src/classification/__tests__/router.test.ts`:**

Test cases:
1. **Income docs route to person subfolder:** `t4`, `pay_stub`, `loe`, `noa`, `t1`, `pension_letter` all return `'person'`
2. **Property docs route to subject_property:** `purchase_agreement`, `mls_listing`, `property_tax_bill`, `home_insurance` return `'subject_property'`
3. **Down payment docs route to down_payment:** `bank_statement`, `rrsp_statement`, `gift_letter` return `'down_payment'`
4. **Void cheque routes to root:** `void_cheque` returns `'root'`
5. **Other routes to root:** `other` returns `'root'`
6. **Residency docs route to person:** `pr_card`, `passport`, `work_permit` return `'person'`
7. **getPersonSubfolderName builds correct name:** firstName='Terry', lastName='Albrecht' -> 'Terry'  (person subfolders use first name only per DRIVE_STRUCTURE.md analysis)
8. **getPersonSubfolderName with null name uses fallback:** null, null, fallback='Borrower 1' -> 'Borrower 1'

**GREEN — Create `src/classification/router.ts`:**

```typescript
import { SUBFOLDER_ROUTING } from './types.js';
import type { DocumentType, SubfolderTarget } from './types.js';
```

1. Implement `routeToSubfolder(documentType: DocumentType): SubfolderTarget`:
   - Return `SUBFOLDER_ROUTING[documentType] ?? 'root'`

2. Implement `getPersonSubfolderName(firstName: string | null, lastName: string | null, fallback: string): string`:
   - If firstName is not null and not empty, return firstName
   - Otherwise return fallback
   - (Person subfolders in Drive use just the first name: "Terry/", "Kathy/", "Susan/")

3. Export both functions.

Run all tests for both modules — they should PASS.
  </action>
  <verify>`npm test -- --run src/classification/__tests__/naming.test.ts src/classification/__tests__/router.test.ts` passes. `npx tsc --noEmit` passes.</verify>
  <done>Naming module generates filenames matching Cat's convention. Router maps all 33 doc types to correct subfolder targets. All tests pass. Both modules are pure functions with no side effects.</done>
</task>

</tasks>

<verification>
1. `npm test -- --run src/classification/__tests__/` passes all new tests
2. `npm test` passes (all existing + new tests)
3. `npx tsc --noEmit` passes
4. classifier.ts calls Claude API with structured output (output_config.format with zodOutputFormat)
5. naming.ts produces filenames matching DRIVE_STRUCTURE.md patterns
6. router.ts maps every DocumentType to a SubfolderTarget
</verification>

<success_criteria>
- Classifier uses Claude Haiku 4.5 with structured output for guaranteed-valid JSON
- Large PDFs truncated to first N pages before classification
- Filename generation matches Cat's naming: "FirstName - DocType [Institution] [Year] [Amount].pdf"
- Subfolder routing covers all 33 document types
- All functions are tested (TDD: tests written first)
</success_criteria>

<output>
After completion, create `.planning/phases/07-classification-filing/07-03-SUMMARY.md`
</output>
