---
phase: 11-drive-folder-linking-deal-subfolders
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/crm/types/index.ts
  - src/crm/config.ts
  - src/crm/contacts.ts
  - src/crm/setup/create-custom-fields.ts
autonomous: true
requirements: [DRIVE-01, DRIVE-03, DRIVE-07]

must_haves:
  truths:
    - "CRM config includes driveFolderIdFieldId (contact) and oppDealSubfolderIdFieldId (opportunity)"
    - "Setup script creates Drive Folder ID field on contact and Deal Subfolder ID field on opportunity"
    - "getContactDriveFolderId reads folder ID from contact custom fields, returning null if absent"
    - "Config gracefully handles missing field IDs (empty string) for backward compatibility"
  artifacts:
    - path: "src/crm/types/index.ts"
      provides: "DRIVE_FOLDER_FIELD_DEF and OPP_DEAL_SUBFOLDER_FIELD_DEF definitions"
      contains: "Drive Folder ID"
    - path: "src/crm/config.ts"
      provides: "driveFolderIdFieldId on CrmConfig"
      contains: "driveFolderIdFieldId"
    - path: "src/crm/contacts.ts"
      provides: "getContactDriveFolderId helper function"
      exports: ["getContactDriveFolderId"]
    - path: "src/crm/setup/create-custom-fields.ts"
      provides: "Setup script handles --drive-fields flag"
      contains: "drive-fields"
  key_links:
    - from: "src/crm/config.ts"
      to: "process.env"
      via: "GHL_FIELD_DRIVE_FOLDER_ID and GHL_OPP_FIELD_DEAL_SUBFOLDER_ID env vars"
      pattern: "GHL_FIELD_DRIVE_FOLDER_ID"
    - from: "src/crm/contacts.ts"
      to: "src/crm/types/index.ts"
      via: "CrmContact type for custom field reading"
      pattern: "getContactDriveFolderId"
---

<objective>
Add CRM config, types, and setup script support for Drive folder linking custom fields.

Purpose: Phase 11 needs two new CRM custom fields -- a TEXT field on contacts for the client Drive folder ID, and a TEXT field on opportunities for the deal subfolder ID. This plan creates the foundation: type definitions, config entries, a contact-level helper to read the folder ID, and setup script capability to provision the fields.

Output: Updated CRM types, config, contacts module, and setup script.
</objective>

<execution_context>
@C:/Users/lucac/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/lucac/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-drive-folder-linking-deal-subfolders/11-RESEARCH.md

@src/crm/types/index.ts
@src/crm/config.ts
@src/crm/contacts.ts
@src/crm/setup/create-custom-fields.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Drive folder field definitions, config entries, and contact helper</name>
  <files>
    src/crm/types/index.ts
    src/crm/config.ts
    src/crm/contacts.ts
  </files>
  <action>
1. In `src/crm/types/index.ts`:
   - Add a new `DRIVE_FOLDER_FIELD_DEF` constant (same pattern as DOC_TRACKING_FIELD_DEFS entries):
     ```
     { envKey: 'GHL_FIELD_DRIVE_FOLDER_ID', name: 'Drive Folder ID', dataType: 'TEXT' as const }
     ```
   - Add a new `OPP_DEAL_SUBFOLDER_FIELD_DEF` constant:
     ```
     { envKey: 'GHL_OPP_FIELD_DEAL_SUBFOLDER_ID', name: 'Deal Subfolder ID', dataType: 'TEXT' as const }
     ```
   - These are standalone constants (not part of the 9-field DOC_TRACKING arrays), because they are not doc tracking fields -- they are folder reference fields.

2. In `src/crm/config.ts`:
   - Add `driveFolderIdFieldId: string` to the `CrmConfig` interface.
   - Add `oppDealSubfolderIdFieldId: string` to the `CrmConfig` interface (top-level, not nested inside opportunityFieldIds -- it is a single standalone field, not part of the 9-field tracking group).
   - Populate both using `optionalEnv()` with empty string fallback:
     ```
     driveFolderIdFieldId: optionalEnv('GHL_FIELD_DRIVE_FOLDER_ID'),
     oppDealSubfolderIdFieldId: optionalEnv('GHL_OPP_FIELD_DEAL_SUBFOLDER_ID'),
     ```
   - In `validateConfig()`, add warnings (not errors) if these are empty, similar to the existing opportunity field warnings. Message: `'[CRM config] Drive folder field IDs not yet configured (run setup script with --drive-fields):'`

3. In `src/crm/contacts.ts`:
   - Add and export a `getContactDriveFolderId` function:
     ```typescript
     export function getContactDriveFolderId(
       contact: CrmContact,
       fieldId: string,
     ): string | null {
       const field = contact.customFields.find((f) => f.id === fieldId);
       if (!field || !field.value || typeof field.value !== 'string') {
         return null;
       }
       return field.value;
     }
     ```
   - This follows the same pure-function pattern as `parseContactTrackingFields` in tracking-sync.ts. Takes the contact record and field ID as parameters (no module-level config import needed).
  </action>
  <verify>
    Run `npx tsc --noEmit` to confirm no type errors.
    Run `npx vitest run` to confirm all existing tests still pass.
  </verify>
  <done>
    CrmConfig has driveFolderIdFieldId and oppDealSubfolderIdFieldId fields.
    getContactDriveFolderId is exported from contacts.ts.
    Type definitions exist for both new custom fields.
    All existing tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update setup script to create Drive folder custom fields</name>
  <files>
    src/crm/setup/create-custom-fields.ts
  </files>
  <action>
1. Add a new `--drive-fields` CLI flag to the setup script (same pattern as `--model=opportunity` and `--deprecate-contact-fields`).

2. When `--drive-fields` is passed:
   - Import `DRIVE_FOLDER_FIELD_DEF` and `OPP_DEAL_SUBFOLDER_FIELD_DEF` from `../types/index.js`.
   - Create the contact-level field: call `createField()` with model='contact', parentId=FIELD_GROUP_ID (same "Finmo Integration" group used for existing contact fields), using DRIVE_FOLDER_FIELD_DEF's name and dataType.
   - Create the opportunity-level field: call `createField()` with model='opportunity', resolve the opportunity field group using `findOppFieldGroup()`, using OPP_DEAL_SUBFOLDER_FIELD_DEF's name and dataType.
   - Print results in .env format:
     ```
     # Drive Folder Linking Custom Field IDs
     GHL_FIELD_DRIVE_FOLDER_ID=<id>
     GHL_OPP_FIELD_DEAL_SUBFOLDER_ID=<id>
     ```
   - Return early after creating these two fields (do not fall through to the 9-field doc tracking creation).

3. Add the `--drive-fields` flag check AFTER the `--deprecate-contact-fields` check and BEFORE the `--model=` parsing block in the `main()` function.

4. Update the script's JSDoc header to document the new flag:
   ```
   * Create Drive folder linking fields:
   *   npx tsx src/crm/setup/create-custom-fields.ts --drive-fields
   ```
  </action>
  <verify>
    Run `npx tsc --noEmit` to confirm no type errors.
    Run `npx vitest run` to confirm all existing tests still pass.
  </verify>
  <done>
    `npx tsx src/crm/setup/create-custom-fields.ts --drive-fields` is a valid command (script parses the flag and would create two fields against the CRM API).
    Script prints env var format for the two new field IDs.
    Existing --model and --deprecate-contact-fields flags still work unchanged.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with no errors
- `npx vitest run` passes with all existing tests passing
- `src/crm/config.ts` exports CrmConfig with `driveFolderIdFieldId` and `oppDealSubfolderIdFieldId`
- `src/crm/contacts.ts` exports `getContactDriveFolderId` function
- `src/crm/setup/create-custom-fields.ts` handles `--drive-fields` flag
</verification>

<success_criteria>
- CRM config interface extended with two new field ID properties
- Contact helper reads Drive folder ID from custom fields
- Setup script can provision both fields via --drive-fields flag
- Zero test regressions
</success_criteria>

<output>
After completion, create `.planning/phases/11-drive-folder-linking-deal-subfolders/11-01-SUMMARY.md`
</output>
