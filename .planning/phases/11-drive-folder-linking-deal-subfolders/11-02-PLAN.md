---
phase: 11-drive-folder-linking-deal-subfolders
plan: 02
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - src/webhook/worker.ts
  - src/drive/folder-scanner.ts
  - src/drive/index.ts
autonomous: true
requirements: [DRIVE-01, DRIVE-03, DRIVE-06]

must_haves:
  truths:
    - "Webhook worker stores clientFolderId on CRM contact after findOrCreateFolder"
    - "Webhook worker extracts deal reference from opportunity name and creates deal subfolder"
    - "Webhook worker stores dealSubfolderId on CRM opportunity"
    - "Drive scanner scans both client folder and deal subfolder, merging results"
    - "Filtered checklist includes both reusable (client) and property-specific (deal) docs"
  artifacts:
    - path: "src/webhook/worker.ts"
      provides: "CRM folder ID persistence + deal subfolder creation"
      contains: "driveFolderIdFieldId"
    - path: "src/drive/folder-scanner.ts"
      provides: "scanDealSubfolder function or dual scan in scanClientFolder"
      contains: "dealSubfolderId"
    - path: "src/drive/index.ts"
      provides: "Barrel export of extractDealReference"
  key_links:
    - from: "src/webhook/worker.ts"
      to: "src/crm/contacts.ts"
      via: "upsertContact with driveFolderIdFieldId custom field"
      pattern: "driveFolderIdFieldId.*field_value.*clientFolderId"
    - from: "src/webhook/worker.ts"
      to: "src/crm/opportunities.ts"
      via: "updateOpportunityFields with oppDealSubfolderIdFieldId"
      pattern: "oppDealSubfolderIdFieldId.*field_value.*dealSubfolderId"
    - from: "src/webhook/worker.ts"
      to: "src/classification/filer.ts"
      via: "findOrCreateFolder for deal subfolder creation"
      pattern: "findOrCreateFolder.*dealRef.*clientFolderId"
---

<objective>
Wire the webhook worker to persist folder IDs and teach the Drive scanner to check both locations.

Purpose: The webhook worker currently creates the client folder but discards the folder ID. This plan persists it to the CRM contact, creates a deal-specific subfolder per Finmo application, stores that on the opportunity, and updates the Drive scanner to check both locations when building the checklist.

Output: Webhook worker stores folder IDs, Drive scanner checks client + deal folders.
</objective>

<execution_context>
@C:/Users/lucac/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/lucac/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-drive-folder-linking-deal-subfolders/11-RESEARCH.md
@.planning/phases/11-drive-folder-linking-deal-subfolders/11-01-SUMMARY.md

@src/webhook/worker.ts
@src/drive/folder-scanner.ts
@src/drive/index.ts
@src/crm/contacts.ts
@src/crm/config.ts
@src/crm/opportunities.ts
@src/classification/filer.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Webhook worker â€” persist folder IDs and create deal subfolder</name>
  <files>
    src/webhook/worker.ts
    src/drive/index.ts
  </files>
  <action>
1. In `src/webhook/worker.ts`, after step 3 (where clientFolderId is resolved via findOrCreateFolder), add folder ID persistence:

   a. Import `crmConfig` from `../crm/config.js` and `findOpportunityByFinmoId`, `getOpportunityFieldValue`, `updateOpportunityFields` from `../crm/opportunities.js` (some may already be indirect via syncChecklistToCrm -- import directly for the new code).

   b. After `clientFolderId` is set (line ~82), store it on the CRM contact. The upsertContact call already happens later in step 8 (syncChecklistToCrm). However, we need the folder ID stored BEFORE the CRM sync so the contact has it immediately. Add a targeted upsert:
      ```typescript
      // Store client Drive folder ID on CRM contact (DRIVE-01)
      if (clientFolderId && crmConfig.driveFolderIdFieldId) {
        try {
          await upsertContact({
            email: mainBorrower.email,
            firstName: mainBorrower.firstName,
            lastName: mainBorrower.lastName,
            customFields: [
              { id: crmConfig.driveFolderIdFieldId, field_value: clientFolderId },
            ],
          });
        } catch (err) {
          console.error('[worker] Failed to store Drive folder ID on contact (non-fatal)', {
            applicationId,
            error: err instanceof Error ? err.message : String(err),
          });
        }
      }
      ```
      Import `upsertContact` from `../crm/contacts.js`.

   c. After storing the folder ID on the contact, resolve the opportunity and create a deal subfolder (DRIVE-03):
      ```typescript
      // Create deal subfolder per Finmo application (DRIVE-03)
      let dealSubfolderId: string | null = null;
      if (clientFolderId) {
        try {
          // Find the opportunity to get the deal reference
          const contactResult = await findContactByEmail(mainBorrower.email);
          if (contactResult) {
            const opportunity = await findOpportunityByFinmoId(
              contactResult,
              PIPELINE_IDS.LIVE_DEALS,
              finmoApp.application.id,
            );

            if (opportunity) {
              const dealRef = extractDealReference(opportunity.name, finmoApp.application.id);
              dealSubfolderId = await findOrCreateFolder(getDriveClient(), dealRef, clientFolderId);

              // Store deal subfolder ID on opportunity
              if (crmConfig.oppDealSubfolderIdFieldId) {
                await updateOpportunityFields(opportunity.id, [
                  { id: crmConfig.oppDealSubfolderIdFieldId, field_value: dealSubfolderId },
                ]);
              }

              console.log('[worker] Deal subfolder created', {
                applicationId,
                dealRef,
                dealSubfolderId,
              });
            }
          }
        } catch (err) {
          console.error('[worker] Deal subfolder creation failed (non-fatal)', {
            applicationId,
            error: err instanceof Error ? err.message : String(err),
          });
        }
      }
      ```
      Import `findContactByEmail` from `../crm/contacts.js`, `findOpportunityByFinmoId`, `updateOpportunityFields` from `../crm/opportunities.js`, `PIPELINE_IDS` from `../crm/types/index.js`, and `extractDealReference` from `../drive/index.js`.

   d. Update the Drive scan step (step 4) to scan both client folder and deal subfolder (DRIVE-06):
      ```typescript
      // 4. Scan Drive folder for existing docs (non-fatal)
      let filterResult: FilterResult | null = null;
      if (clientFolderId) {
        try {
          const borrowerFirstNames = finmoApp.borrowers.map(b => b.firstName);
          const existingDocs = await scanClientFolder(getDriveClient(), clientFolderId, borrowerFirstNames);

          // Also scan deal subfolder for property-specific docs
          let dealDocs: ExistingDoc[] = [];
          if (dealSubfolderId) {
            dealDocs = await scanClientFolder(getDriveClient(), dealSubfolderId, borrowerFirstNames);
          }

          const allExistingDocs = [...existingDocs, ...dealDocs];

          if (allExistingDocs.length > 0) {
            filterResult = filterChecklistByExistingDocs(checklist, allExistingDocs, new Date());
            console.log('[worker] Drive scan found existing docs', {
              applicationId,
              clientLevel: existingDocs.length,
              dealLevel: dealDocs.length,
              onFile: filterResult.alreadyOnFile.length,
              expired: filterResult.expiredDocs.length,
            });
          }
        } catch (err) {
          // ... existing error handler
        }
      }
      ```
      Import `ExistingDoc` type from `../drive/index.js`.

2. In `src/drive/index.ts` (barrel):
   - Add `extractDealReference` to the exports.
   - Also export the `ExistingDoc` type from folder-scanner.ts if not already exported.

3. Create the `extractDealReference` function. Add it to `src/drive/folder-scanner.ts` (it's a pure parsing function related to Drive folder naming, fits here alongside parseDocFromFilename):
   ```typescript
   /**
    * Extracts the Finmo deal reference from a CRM opportunity name.
    *
    * Finmo creates opportunities with names like "John - BRXM-F050382".
    * Extracts the portion after the last " - " as the deal reference.
    * Falls back to the first 8 characters of the fallback ID (UUID).
    *
    * @param opportunityName - The CRM opportunity name (may be undefined)
    * @param fallbackId - Finmo application UUID to use if extraction fails
    * @returns A human-readable deal reference for subfolder naming
    */
   export function extractDealReference(
     opportunityName: string | undefined,
     fallbackId: string,
   ): string {
     if (opportunityName) {
       const dashIdx = opportunityName.lastIndexOf(' - ');
       if (dashIdx >= 0) {
         const ref = opportunityName.slice(dashIdx + 3).trim();
         if (ref.length > 0) return ref;
       }
     }
     return fallbackId.slice(0, 8);
   }
   ```

IMPORTANT: All CRM calls for folder persistence are wrapped in try/catch with non-fatal error handling. A failure to store the folder ID or create the deal subfolder MUST NOT prevent the rest of the webhook pipeline from completing. Log the error and continue.
  </action>
  <verify>
    Run `npx tsc --noEmit` to confirm no type errors.
    Run `npx vitest run` to confirm all existing tests still pass.
  </verify>
  <done>
    Webhook worker stores clientFolderId on CRM contact via upsertContact.
    Webhook worker creates deal subfolder and stores dealSubfolderId on opportunity via updateOpportunityFields.
    Drive scan step scans both client and deal folders, merging results.
    extractDealReference parses opportunity name format "Name - BRXM-F050382".
    All operations are non-fatal (try/catch with logging).
    All existing tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Tests for extractDealReference and dual-scan verification</name>
  <files>
    src/drive/__tests__/folder-scanner.test.ts
  </files>
  <action>
1. Add unit tests for `extractDealReference` to the existing `src/drive/__tests__/folder-scanner.test.ts` test file (or create it if it doesn't exist).

2. Test cases for `extractDealReference`:
   - Standard format: `"John - BRXM-F050382"` returns `"BRXM-F050382"`
   - Multiple dashes in name: `"John Smith - Jane - BRXM-F050382"` returns `"BRXM-F050382"` (uses lastIndexOf)
   - No dash separator: `"JohnBRXMF050382"` returns first 8 chars of fallbackId
   - Undefined opportunity name: returns first 8 chars of fallbackId
   - Empty string after dash: `"John - "` returns first 8 chars of fallbackId
   - Whitespace after dash: `"John -   BRXM-F050382  "` returns `"BRXM-F050382"` (trimmed)

3. Follow existing project test patterns:
   - Import from the source module using .js extension (NodeNext)
   - Use `describe`/`it` blocks
   - No mocking needed (pure function)
  </action>
  <verify>
    Run `npx vitest run src/drive/__tests__/folder-scanner.test.ts` to confirm new tests pass.
    Run `npx vitest run` to confirm all tests pass.
  </verify>
  <done>
    extractDealReference has 6+ test cases covering standard format, edge cases, and fallbacks.
    All tests pass.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- `npx vitest run` passes with all existing + new tests
- Webhook worker imports and uses `crmConfig.driveFolderIdFieldId` and `crmConfig.oppDealSubfolderIdFieldId`
- `extractDealReference` handles standard opportunity name format and graceful fallbacks
- Drive scan merges client-level and deal-level results before filtering
</verification>

<success_criteria>
- Webhook worker persists clientFolderId to CRM contact custom field after folder creation
- Webhook worker creates deal subfolder named by deal reference and stores ID on opportunity
- Drive scanner checks both client and deal folders, combining results for checklist filtering
- All operations are non-fatal with proper error logging
- New tests for extractDealReference pass
</success_criteria>

<output>
After completion, create `.planning/phases/11-drive-folder-linking-deal-subfolders/11-02-SUMMARY.md`
</output>
